# AlertManager configuration for Weibo Crawler System
# åŸºäºMediaCrawlerå¢å¼ºçš„å‘Šè­¦ç®¡ç†é…ç½®

global:
  smtp_smarthost: 'smtp.company.com:587'
  smtp_from: 'alerts@company.com'
  smtp_auth_username: 'alerts@company.com'
  smtp_auth_password: 'your_smtp_password'
  smtp_require_tls: true

  # Slacké…ç½®
  slack_api_url: 'https://hooks.slack.com/services/YOUR/SLACK/WEBHOOK'
  slack_api_url_file: '/etc/alertmanager/slack_webhook_url'

# æ¨¡æ¿æ–‡ä»¶
templates:
  - '/etc/alertmanager/templates/*.tmpl'

# è·¯ç”±é…ç½®
route:
  group_by: ['alertname', 'cluster', 'service']
  group_wait: 10s
  group_interval: 10s
  repeat_interval: 1h
  receiver: 'web.hook'
  routes:

  # å…³é”®å‘Šè­¦ç«‹å³å‘é€
  - match:
      severity: critical
    receiver: 'critical-alerts'
    group_wait: 0s
    repeat_interval: 5m
    routes:
    - match:
        service: crawler
        component: service
      receiver: 'crawler-critical'
    - match:
        service: database
      receiver: 'database-critical'
    - match:
        service: storage
      receiver: 'storage-critical'

  # è­¦å‘Šå‘Šè­¦èšåˆå‘é€
  - match:
      severity: warning
    receiver: 'warning-alerts'
    group_wait: 30s
    repeat_interval: 2h
    routes:
    - match:
        service: crawler
      receiver: 'crawler-warning'
    - match:
        service: database
      receiver: 'database-warning'
    - match:
        service: network
      receiver: 'network-warning'

  # æ€§èƒ½å‘Šè­¦
  - match:
      component: performance
    receiver: 'performance-alerts'
    group_wait: 1m
    repeat_interval: 30m

  # åçˆ¬è™«å‘Šè­¦ç«‹å³å¤„ç†
  - match:
      component: anti-bot
    receiver: 'anti-bot-alerts'
    group_wait: 0s
    repeat_interval: 1m

  # é™é»˜ç»´æŠ¤æœŸé—´å‘Šè­¦
  - match:
      alertname: 'CrawlerServiceDown'
    active_time_intervals:
      - business-hours
    receiver: 'maintenance-alerts'

# æ—¶é—´é—´éš”å®šä¹‰
time_intervals:
  - name: business-hours
    time_intervals:
      - times:
          - start_time: '09:00'
            end_time: '18:00'
        weekdays: ['monday:friday']

  - name: after-hours
    time_intervals:
      - times:
          - start_time: '18:01'
            end_time: '08:59'
        weekdays: ['monday:friday']
      - weekdays: ['saturday', 'sunday']

# æŠ‘åˆ¶è§„åˆ™
inhibit_rules:
  # å¦‚æœæœåŠ¡å®•æœºï¼ŒæŠ‘åˆ¶è¯¥æœåŠ¡çš„å…¶ä»–å‘Šè­¦
  - source_match:
      alertname: 'CrawlerServiceDown'
    target_match_re:
      service: 'crawler'
    equal: ['instance']

  # å¦‚æœæ•°æ®åº“å®•æœºï¼ŒæŠ‘åˆ¶ç›¸å…³çš„è¿æ¥å‘Šè­¦
  - source_match_re:
      alertname: '(PostgreSQLDown|MongoDBDown|RedisDown)'
    target_match_re:
      service: 'crawler|queue'
    equal: ['instance']

  # å¦‚æœç½‘ç»œä¸é€šï¼ŒæŠ‘åˆ¶HTTPæœåŠ¡å‘Šè­¦
  - source_match:
      alertname: 'TCPServiceDown'
    target_match:
      component: 'http'
    equal: ['instance']

# æ¥æ”¶å™¨é…ç½®
receivers:
  # é»˜è®¤Webhookæ¥æ”¶å™¨
  - name: 'web.hook'
    webhook_configs:
      - url: 'http://alert-webhook-service:8080/webhook'
        send_resolved: true
        http_config:
          bearer_token: 'your_webhook_token'

  # å…³é”®å‘Šè­¦æ¥æ”¶å™¨
  - name: 'critical-alerts'
    email_configs:
      - to: 'ops-team@company.com,manager@company.com'
        subject: '[CRITICAL] å¾®åšçˆ¬å–ç³»ç»Ÿå‘Šè­¦ - {{ .GroupLabels.alertname }}'
        body: |
          {{ range .Alerts }}
          å‘Šè­¦åç§°: {{ .Annotations.summary }}
          å‘Šè­¦æè¿°: {{ .Annotations.description }}
          ä¸¥é‡ç¨‹åº¦: {{ .Labels.severity }}
          æœåŠ¡ç»„ä»¶: {{ .Labels.service }}/{{ .Labels.component }}
          å®ä¾‹: {{ .Labels.instance }}
          å¼€å§‹æ—¶é—´: {{ .StartsAt.Format "2006-01-02 15:04:05" }}
          è¿ç»´æ‰‹å†Œ: {{ .Annotations.runbook_url }}
          {{ end }}
        send_resolved: true

    slack_configs:
      - channel: '#alerts-critical'
        title: 'ğŸš¨ CRITICAL: å¾®åšçˆ¬å–ç³»ç»Ÿå‘Šè­¦'
        text: |
          {{ range .Alerts }}
          *å‘Šè­¦:* {{ .Annotations.summary }}
          *æè¿°:* {{ .Annotations.description }}
          *æœåŠ¡:* {{ .Labels.service }}/{{ .Labels.component }}
          *å®ä¾‹:* {{ .Labels.instance }}
          *æ—¶é—´:* {{ .StartsAt.Format "2006-01-02 15:04:05" }}
          {{ end }}
        send_resolved: true
        actions:
          - type: button
            text: 'æŸ¥çœ‹è¯¦æƒ…'
            url: 'https://grafana.company.com/d/weibo-crawler'
          - type: button
            text: 'è¿ç»´æ‰‹å†Œ'
            url: '{{ (index .Alerts 0).Annotations.runbook_url }}'

    webhook_configs:
      - url: 'https://api.company.com/alerts/critical'
        send_resolved: true

  # çˆ¬è™«å…³é”®å‘Šè­¦
  - name: 'crawler-critical'
    email_configs:
      - to: 'crawler-team@company.com,ops-team@company.com'
        subject: '[CRITICAL] çˆ¬è™«æœåŠ¡å‘Šè­¦ - {{ .GroupLabels.alertname }}'
        body: |
          çˆ¬è™«æœåŠ¡å…³é”®å‘Šè­¦ï¼

          {{ range .Alerts }}
          å‘Šè­¦: {{ .Annotations.summary }}
          è¯¦æƒ…: {{ .Annotations.description }}
          Pod: {{ .Labels.pod }}
          èŠ‚ç‚¹: {{ .Labels.node }}
          æ—¶é—´: {{ .StartsAt.Format "2006-01-02 15:04:05" }}

          å¿«é€Ÿå¤„ç†æ­¥éª¤:
          1. æ£€æŸ¥æœåŠ¡çŠ¶æ€: kubectl get pods -n weibo-crawler
          2. æŸ¥çœ‹æ—¥å¿—: kubectl logs -f deployment/crawler -n weibo-crawler
          3. æ£€æŸ¥èµ„æºä½¿ç”¨: kubectl top pods -n weibo-crawler
          4. å‚è€ƒè¿ç»´æ‰‹å†Œ: {{ .Annotations.runbook_url }}
          {{ end }}
        send_resolved: true

    slack_configs:
      - channel: '#crawler-alerts'
        title: 'ğŸš¨ çˆ¬è™«æœåŠ¡å…³é”®å‘Šè­¦'
        text: |
          {{ range .Alerts }}
          *{{ .Annotations.summary }}*
          {{ .Annotations.description }}
          *Pod:* {{ .Labels.pod }}
          *æ—¶é—´:* {{ .StartsAt.Format "2006-01-02 15:04:05" }}
          {{ end }}
        send_resolved: true

  # æ•°æ®åº“å…³é”®å‘Šè­¦
  - name: 'database-critical'
    email_configs:
      - to: 'db-team@company.com,ops-team@company.com'
        subject: '[CRITICAL] æ•°æ®åº“å‘Šè­¦ - {{ .GroupLabels.alertname }}'
        body: |
          æ•°æ®åº“å…³é”®å‘Šè­¦ï¼

          {{ range .Alerts }}
          å‘Šè­¦: {{ .Annotations.summary }}
          è¯¦æƒ…: {{ .Annotations.description }}
          æ•°æ®åº“: {{ .Labels.instance }}
          æ—¶é—´: {{ .StartsAt.Format "2006-01-02 15:04:05" }}
          {{ end }}
        send_resolved: true

  # å­˜å‚¨å…³é”®å‘Šè­¦
  - name: 'storage-critical'
    email_configs:
      - to: 'storage-team@company.com,ops-team@company.com'
        subject: '[CRITICAL] å­˜å‚¨å‘Šè­¦ - {{ .GroupLabels.alertname }}'
        body: |
          å­˜å‚¨ç³»ç»Ÿå…³é”®å‘Šè­¦ï¼

          {{ range .Alerts }}
          å‘Šè­¦: {{ .Annotations.summary }}
          è¯¦æƒ…: {{ .Annotations.description }}
          å­˜å‚¨: {{ .Labels.instance }}
          æ—¶é—´: {{ .StartsAt.Format "2006-01-02 15:04:05" }}
          {{ end }}
        send_resolved: true

  # è­¦å‘Šå‘Šè­¦æ¥æ”¶å™¨
  - name: 'warning-alerts'
    email_configs:
      - to: 'ops-team@company.com'
        subject: '[WARNING] å¾®åšçˆ¬å–ç³»ç»Ÿè­¦å‘Š - {{ .GroupLabels.alertname }}'
        body: |
          ç³»ç»Ÿè­¦å‘Šé€šçŸ¥ï¼š

          {{ range .Alerts }}
          è­¦å‘Š: {{ .Annotations.summary }}
          è¯¦æƒ…: {{ .Annotations.description }}
          æœåŠ¡: {{ .Labels.service }}/{{ .Labels.component }}
          æ—¶é—´: {{ .StartsAt.Format "2006-01-02 15:04:05" }}
          {{ end }}
        send_resolved: true

    slack_configs:
      - channel: '#alerts-warning'
        title: 'âš ï¸ ç³»ç»Ÿè­¦å‘Š'
        text: |
          {{ range .Alerts }}
          *{{ .Annotations.summary }}*
          {{ .Annotations.description }}
          {{ end }}
        send_resolved: true

  # çˆ¬è™«è­¦å‘Šå‘Šè­¦
  - name: 'crawler-warning'
    email_configs:
      - to: 'crawler-team@company.com'
        subject: '[WARNING] çˆ¬è™«æœåŠ¡è­¦å‘Š - {{ .GroupLabels.alertname }}'
        body: |
          çˆ¬è™«æœåŠ¡è­¦å‘Šï¼š

          {{ range .Alerts }}
          è­¦å‘Š: {{ .Annotations.summary }}
          è¯¦æƒ…: {{ .Annotations.description }}
          Pod: {{ .Labels.pod }}
          æ—¶é—´: {{ .StartsAt.Format "2006-01-02 15:04:05" }}
          {{ end }}
        send_resolved: true

  # æ•°æ®åº“è­¦å‘Šå‘Šè­¦
  - name: 'database-warning'
    email_configs:
      - to: 'db-team@company.com'
        subject: '[WARNING] æ•°æ®åº“è­¦å‘Š - {{ .GroupLabels.alertname }}'
        body: |
          æ•°æ®åº“è­¦å‘Šï¼š

          {{ range .Alerts }}
          è­¦å‘Š: {{ .Annotations.summary }}
          è¯¦æƒ…: {{ .Annotations.description }}
          æ•°æ®åº“: {{ .Labels.instance }}
          æ—¶é—´: {{ .StartsAt.Format "2006-01-02 15:04:05" }}
          {{ end }}
        send_resolved: true

  # ç½‘ç»œè­¦å‘Šå‘Šè­¦
  - name: 'network-warning'
    email_configs:
      - to: 'network-team@company.com'
        subject: '[WARNING] ç½‘ç»œè­¦å‘Š - {{ .GroupLabels.alertname }}'
        body: |
          ç½‘ç»œæœåŠ¡è­¦å‘Šï¼š

          {{ range .Alerts }}
          è­¦å‘Š: {{ .Annotations.summary }}
          è¯¦æƒ…: {{ .Annotations.description }}
          æœåŠ¡: {{ .Labels.instance }}
          æ—¶é—´: {{ .StartsAt.Format "2006-01-02 15:04:05" }}
          {{ end }}
        send_resolved: true

  # æ€§èƒ½å‘Šè­¦æ¥æ”¶å™¨
  - name: 'performance-alerts'
    email_configs:
      - to: 'performance-team@company.com,crawler-team@company.com'
        subject: '[PERFORMANCE] æ€§èƒ½å‘Šè­¦ - {{ .GroupLabels.alertname }}'
        body: |
          æ€§èƒ½å‘Šè­¦é€šçŸ¥ï¼š

          {{ range .Alerts }}
          å‘Šè­¦: {{ .Annotations.summary }}
          è¯¦æƒ…: {{ .Annotations.description }}
          æœåŠ¡: {{ .Labels.service }}
          Pod: {{ .Labels.pod }}
          æ—¶é—´: {{ .StartsAt.Format "2006-01-02 15:04:05" }}
          {{ end }}
        send_resolved: true

  # åçˆ¬è™«å‘Šè­¦æ¥æ”¶å™¨
  - name: 'anti-bot-alerts'
    email_configs:
      - to: 'crawler-team@company.com,security-team@company.com'
        subject: '[URGENT] åçˆ¬è™«æ£€æµ‹å‘Šè­¦'
        body: |
          æ£€æµ‹åˆ°åçˆ¬è™«æœºåˆ¶ï¼éœ€è¦ç«‹å³å¤„ç†ï¼

          {{ range .Alerts }}
          å‘Šè­¦: {{ .Annotations.summary }}
          è¯¦æƒ…: {{ .Annotations.description }}
          Pod: {{ .Labels.pod }}
          æ—¶é—´: {{ .StartsAt.Format "2006-01-02 15:04:05" }}

          ç´§æ€¥å¤„ç†æ­¥éª¤ï¼š
          1. ç«‹å³æ£€æŸ¥çˆ¬è™«é…ç½®
          2. è€ƒè™‘æš‚åœç›¸å…³çˆ¬å–ä»»åŠ¡
          3. æ›´æ¢User-Agentå’Œä»£ç†
          4. å¢åŠ è¯·æ±‚é—´éš”
          {{ end }}
        send_resolved: true

    slack_configs:
      - channel: '#crawler-urgent'
        title: 'ğŸš¨ URGENT: åçˆ¬è™«æ£€æµ‹'
        text: |
          æ£€æµ‹åˆ°åçˆ¬è™«æœºåˆ¶ï¼éœ€è¦ç«‹å³å¤„ç†ï¼

          {{ range .Alerts }}
          *{{ .Annotations.summary }}*
          {{ .Annotations.description }}
          *Pod:* {{ .Labels.pod }}
          *æ—¶é—´:* {{ .StartsAt.Format "2006-01-02 15:04:05" }}
          {{ end }}
        send_resolved: true

    webhook_configs:
      - url: 'https://api.company.com/alerts/urgent'
        send_resolved: true

  # ç»´æŠ¤æœŸé—´å‘Šè­¦
  - name: 'maintenance-alerts'
    email_configs:
      - to: 'ops-team@company.com'
        subject: '[MAINTENANCE] ç»´æŠ¤æœŸé—´å‘Šè­¦ - {{ .GroupLabels.alertname }}'
        body: |
          ç»´æŠ¤æœŸé—´å‘Šè­¦ï¼ˆå·²é™é»˜ï¼‰ï¼š

          {{ range .Alerts }}
          å‘Šè­¦: {{ .Annotations.summary }}
          è¯¦æƒ…: {{ .Annotations.description }}
          æ—¶é—´: {{ .StartsAt.Format "2006-01-02 15:04:05" }}
          {{ end }}
        send_resolved: true