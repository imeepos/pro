# V2 项目规划 - PNPM Workspace 初始化

## 项目概述
初始化基于 pnpm workspace 的 monorepo 项目结构

## 技术栈
- **前端框架**: Angular
- **后端框架**: Nest.js
- **语言**: TypeScript
- **代码规范**: ESLint + Prettier
- **前端测试**: Karma + Jasmine（Angular 默认测试框架）
- **后端测试**: Jest
- **包管理**: pnpm workspace
- **构建工具**: Turbo（monorepo 构建系统）

## 目录结构

```
.
├── pnpm-workspace.yaml           # pnpm workspace 配置
├── package.json                  # 根 package.json
├── turbo.json                    # Turbo 构建配置
├── .eslintrc.js                  # ESLint 配置
├── .prettierrc                   # Prettier 配置
├── tsconfig.base.json            # 基础 TypeScript 配置
├── apps/                         # 应用目录
│   ├── web/                     # Angular 前端应用
│   ├── admin/                   # Angular 后台管理应用
│   ├── api/                     # Nest.js 后端API服务
│   ├── crawler/                 # 爬虫微服务 (Nest.js)
│   └── cleaner/                 # 数据清洗微服务 (Nest.js)
└── packages/                    # 共享工具库
    ├── types/                   # 共享 TypeScript 类型定义
    ├── components/              # Angular UI组件库
    ├── utils/                   # 通用工具函数库
    ├── config/                  # 共享配置
    ├── rabbitmq/                # RabbitMQ 操作封装
    ├── redis/                   # Redis 操作封装
    ├── mongodb/                 # MongoDB 操作封装
    └── minio/                   # MinIO 对象存储操作封装
```

## 包依赖关系

### 前端应用依赖
- **web** (apps/web)
  - @pro/types
  - @pro/components
  - @pro/utils
  - @pro/config

- **admin** (apps/admin)
  - @pro/types
  - @pro/components
  - @pro/utils
  - @pro/config

### 后端应用依赖
- **api** (apps/api)
  - @pro/types
  - @pro/utils
  - @pro/config
  - @pro/rabbitmq
  - @pro/redis
  - @pro/mongodb
  - @pro/minio

- **crawler** (apps/crawler)
  - @pro/types
  - @pro/utils
  - @pro/config
  - @pro/rabbitmq
  - @pro/redis
  - @pro/mongodb
  - @pro/minio

- **cleaner** (apps/cleaner)
  - @pro/types
  - @pro/utils
  - @pro/config
  - @pro/rabbitmq
  - @pro/redis
  - @pro/mongodb
  - @pro/minio

## 任务拆解

### 阶段1：基础配置（无依赖，优先执行）
- [ ] 1.1 创建根目录 package.json（包含 pnpm workspace 配置，安装 turbo）
- [ ] 1.2 创建 pnpm-workspace.yaml 配置文件
- [ ] 1.3 创建 turbo.json 配置文件
  - 配置 build pipeline
  - 配置 test pipeline
  - 配置 lint pipeline
  - 配置 dev pipeline
  - 配置缓存策略
- [ ] 1.4 创建 tsconfig.base.json（基础 TypeScript 配置）
- [ ] 1.5 创建 .eslintrc.js（ESLint 配置）
- [ ] 1.6 创建 .prettierrc（Prettier 配置）
- [ ] 1.7 配置 .gitignore（包含 .turbo 缓存目录）

### 阶段2：创建基础目录结构（依赖阶段1）
- [ ] 2.1 创建 apps 目录
- [ ] 2.2 创建 packages 目录

### 阶段3：前端应用初始化（依赖阶段2，可并行）
- [ ] 3.1 初始化 Angular 前端应用（web）
  - 使用 Angular CLI
  - 配置 TypeScript
  - 配置 Karma + Jasmine 测试框架
  - 配置 ESLint + Prettier
- [ ] 3.2 初始化 Angular 后台管理应用（admin）
  - 使用 Angular CLI
  - 配置 TypeScript
  - 配置 Karma + Jasmine 测试框架
  - 配置 ESLint + Prettier

### 阶段4：后端应用初始化（依赖阶段2，可并行）
- [ ] 4.1 初始化 Nest.js 后端API服务（api）
  - 使用 Nest CLI
  - 配置 TypeScript
  - 集成 Jest
  - 配置 ESLint + Prettier
- [ ] 4.2 初始化爬虫微服务（crawler）
  - 使用 Nest CLI
  - 配置 TypeScript
  - 集成 Jest
  - 配置 ESLint + Prettier
- [ ] 4.3 初始化数据清洗微服务（cleaner）
  - 使用 Nest CLI
  - 配置 TypeScript
  - 集成 Jest
  - 配置 ESLint + Prettier

### 阶段5：工具库初始化（依赖阶段2，可并行）

#### 前端相关包
- [ ] 5.1 初始化 types 包（TypeScript 类型定义）
- [ ] 5.2 初始化 components 包（Angular 组件库）

#### 通用工具包
- [ ] 5.3 初始化 utils 包（通用工具函数）
- [ ] 5.4 初始化 config 包（共享配置）

#### 后端基础设施包（api、crawler、cleaner 公用）
- [ ] 5.5 初始化 rabbitmq 包（RabbitMQ 操作封装）
  - 连接管理
  - 消息发布/订阅
  - 队列操作
- [ ] 5.6 初始化 redis 包（Redis 操作封装）
  - 连接管理
  - 缓存操作
  - 发布/订阅
- [ ] 5.7 初始化 mongodb 包（MongoDB 操作封装）
  - 连接管理
  - 常用 CRUD 操作
  - 事务支持
- [ ] 5.8 初始化 minio 包（MinIO 对象存储封装）
  - 文件上传/下载
  - 桶管理
  - 预签名URL生成

### 阶段6：依赖配置与验证（依赖阶段3、4、5）
- [ ] 6.1 配置包之间的依赖关系
- [ ] 6.2 执行 pnpm install
- [ ] 6.3 验证 Turbo 构建系统
  - 运行 `pnpm turbo build` 验证构建流程
  - 验证增量构建和缓存功能
- [ ] 6.4 验证所有应用可以正常启动
  - 运行 `pnpm turbo dev` 测试开发模式
- [ ] 6.5 验证测试框架配置正确
  - 运行 `pnpm turbo test` 执行所有测试
- [ ] 6.6 验证 ESLint 和 Prettier 配置正确
  - 运行 `pnpm turbo lint` 执行代码检查

## 执行策略

### 执行流程图
```
阶段1（基础配置）
    ↓
阶段2（创建目录结构）
    ↓
阶段3（前端应用）| 阶段4（后端应用）| 阶段5（工具库）  ← 并行执行
    ↓
阶段6（依赖配置与验证）
```

### 详细执行顺序
1. **串行执行**：阶段1（基础配置）→ 阶段2（目录结构）
2. **并行执行**：阶段2完成后，阶段3、4、5 同时进行
   - Agent 1: 执行阶段3（前端应用初始化）
   - Agent 2: 执行阶段4（后端应用初始化）
   - Agent 3: 执行阶段5（工具库初始化）
3. **串行执行**：阶段3、4、5 全部完成后 → 阶段6（依赖配置与验证）

### 提交策略
- 每个阶段完成后立即提交代码
- 每个子任务完成后建议提交一次（便于回滚）
- 提交信息格式：`[阶段X.Y] 任务描述`

## 预计时间
- 阶段1：8-12分钟（增加 turbo.json 配置）
- 阶段2：2-5分钟
- 阶段3：15-20分钟（2个 Angular 应用）
- 阶段4：20-25分钟（1个主服务 + 2个微服务）
- 阶段5：25-35分钟（8个工具库：2前端 + 2通用 + 4后端基础设施）
- 阶段6：12-18分钟（配置、验证、Turbo 测试）
- **总计**：约 85-115分钟

## 注意事项
1. 确保 pnpm 已安装（版本 >= 8.0）
2. 确保 Node.js 版本 >= 18.0
3. Turbo 将作为项目依赖安装（推荐使用 `pnpm dlx turbo` 执行命令）
4. Angular CLI 和 Nest CLI 需要全局安装或使用 npx
5. 所有包名使用 `@pro/` 作为 scope 前缀（如：@pro/web, @pro/types）
6. 所有目录名使用单个单词，不使用"-"分割
7. TypeScript 版本需要兼容 Angular 和 Nest.js

## 后端基础设施包说明

### 设计目标
将 api、crawler、cleaner 三个后端应用中重复的基础设施操作抽离到 packages 中，实现：
- **代码复用**：避免重复编写相同的数据库、缓存、消息队列操作
- **统一接口**：提供一致的 API 调用方式
- **易于维护**：基础设施变更只需修改一个地方
- **版本管理**：通过 package.json 统一管理依赖版本

### 各包职责
- **@pro/rabbitmq**: 消息队列操作，用于微服务间异步通信
- **@pro/redis**: 缓存操作，提升数据访问性能
- **@pro/mongodb**: 数据库操作，统一 CRUD 接口和事务处理
- **@pro/minio**: 对象存储操作，处理文件上传下载（如爬虫抓取的图片、文档等）

## Turbo 构建系统说明

### 为什么使用 Turbo
在 monorepo 项目中，管理多个应用和包的构建、测试、开发流程非常复杂。Turbo 提供：

- **增量构建**: 只重新构建发生变化的包，大幅提升构建速度
- **智能缓存**: 缓存构建结果，避免重复工作
- **并行执行**: 自动分析依赖关系，最大化并行执行任务
- **任务管道**: 定义任务依赖关系，确保正确的执行顺序
- **远程缓存**: 支持团队共享构建缓存（可选）

### Turbo Pipeline 配置

#### build（构建）
- 依赖关系：先构建 packages，再构建 apps
- 输出：dist/ 目录
- 缓存：开启

#### test（测试）
- 依赖关系：依赖 build
- 缓存：开启

#### lint（代码检查）
- 依赖关系：无
- 缓存：开启

#### dev（开发模式）
- 依赖关系：无
- 缓存：关闭（实时更新）

### 常用命令
```bash
# 构建所有包
pnpm turbo build

# 运行所有测试
pnpm turbo test

# 代码检查
pnpm turbo lint

# 开发模式（同时启动所有应用）
pnpm turbo dev

# 只构建某个包
pnpm turbo build --filter=@pro/web

# 清除缓存
pnpm turbo build --force
```
