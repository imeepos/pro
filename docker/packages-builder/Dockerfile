# ========================================
# Packages Builder é•œåƒ
# ========================================
# ç›®çš„ï¼šæ„å»ºåŒ…å«æ‰€æœ‰å…±äº« packages çš„åŸºç¡€é•œåƒ
# ç”¨é€”ï¼šä¸ºåº”ç”¨é•œåƒæä¾›é¢„æ„å»ºçš„ packagesï¼Œå‡å°‘åº”ç”¨æ„å»ºæ—¶é—´
# ç­–ç•¥ï¼šå¤šé˜¶æ®µæ„å»º + åˆ†å±‚ç¼“å­˜ + ä¾èµ–å…³ç³»ä¼˜åŒ–
# ========================================

# ========================================
# åŸºç¡€é•œåƒé…ç½®
# å…è®¸é€šè¿‡ ARG çµæ´»æŒ‡å®šåŸºç¡€é•œåƒ
# ========================================
ARG BUILD_FROM_BASE=imeepos/base:latest
FROM $BUILD_FROM_BASE AS base

# ========================================
# å…ƒæ•°æ®æ ‡ç­¾
# ========================================
LABEL maintainer="Pro Team" \
      description="åŒ…å«æ‰€æœ‰å…±äº« packages æ„å»ºäº§ç‰©çš„åŸºç¡€é•œåƒ" \
      base.image="$BUILD_FROM_BASE" \
      packages="types,config,utils,mongodb,redis,rabbitmq,minio"

# ========================================
# ä¾èµ–å£°æ˜é˜¶æ®µ (deps)
# ç›®çš„ï¼šå°†ä¾èµ–å£°æ˜ä¸æºä»£ç åˆ†ç¦»ï¼Œæœ€å¤§åŒ–ç¼“å­˜åˆ©ç”¨
# å˜åŒ–é¢‘ç‡ï¼šä½ï¼ˆä»…åœ¨ä¾èµ–å˜æ›´æ—¶é‡å»ºï¼‰
# ========================================
FROM base AS deps

# åˆ‡æ¢åˆ° root ç”¨æˆ·ä»¥ç¡®ä¿å®‰è£…æƒé™
USER root

# è®¾ç½®å·¥ä½œç›®å½•
WORKDIR /app

# ========================================
# å¤åˆ¶ workspace é…ç½®æ–‡ä»¶
# è¿™äº›æ–‡ä»¶å†³å®šäº† monorepo çš„ç»“æ„
# ========================================
COPY --chown=nestjs:nodejs package.json bun.lock ./

# ========================================
# å¤åˆ¶æ‰€æœ‰ packages çš„ package.json
# æŒ‰ä¾èµ–å…³ç³»æ’åºï¼Œä¾¿äºç†è§£æ„å»ºæµç¨‹
# ========================================
# ç¬¬ä¸€å±‚ï¼šæ— ä¾èµ–çš„åŸºç¡€ packages
COPY --chown=nestjs:nodejs packages/types/package.json ./packages/types/
COPY --chown=nestjs:nodejs packages/config/package.json ./packages/config/

# ç¬¬äºŒå±‚ï¼šä¾èµ–åŸºç¡€ packages çš„å·¥å…·å±‚
COPY --chown=nestjs:nodejs packages/utils/package.json ./packages/utils/

# ç¬¬ä¸‰å±‚ï¼šæœåŠ¡é›†æˆå±‚ï¼ˆMongoDBã€Redisã€RabbitMQã€MinIOï¼‰
COPY --chown=nestjs:nodejs packages/mongodb/package.json ./packages/mongodb/
COPY --chown=nestjs:nodejs packages/redis/package.json ./packages/redis/
COPY --chown=nestjs:nodejs packages/rabbitmq/package.json ./packages/rabbitmq/
COPY --chown=nestjs:nodejs packages/minio/package.json ./packages/minio/

# ========================================
# å®‰è£…æ‰€æœ‰ä¾èµ–
# ä½¿ç”¨ BuildKit cache mount åŠ é€Ÿå®‰è£…è¿‡ç¨‹
# cache mountï¼šå¤ç”¨å·²ä¸‹è½½çš„ä¾èµ–ï¼Œé¿å…é‡å¤ä¸‹è½½
# ========================================
RUN --mount=type=cache,id=bun-packages,target=/root/.bun/install/cache \
    echo "ğŸ”§ å®‰è£…æ‰€æœ‰ packages ä¾èµ–..." && \
    chown -R nestjs:nodejs /app && \
    bun install

# ========================================
# æ„å»ºé˜¶æ®µ (builder)
# ç›®çš„ï¼šæŒ‰ä¾èµ–å…³ç³»é€å±‚æ„å»º packages
# ç­–ç•¥ï¼šåˆ†å±‚æ„å»ºï¼Œæœ€å¤§åŒ–åˆ©ç”¨ Docker å±‚çº§ç¼“å­˜
# ä¼˜åŠ¿ï¼šæºç å˜åŒ–åªå½±å“ç›¸å…³å±‚åŠåç»­ä¾èµ–å±‚
# ========================================
FROM deps AS builder

# ========================================
# å¤åˆ¶ TypeScript åŸºç¡€é…ç½®
# å˜åŒ–é¢‘ç‡ï¼šæä½ï¼Œæ”¾åœ¨æœ€å‰é¢
# ========================================
COPY --chown=nestjs:nodejs tsconfig.base.json* ./

# ========================================
# ç¬¬ä¸€å±‚ï¼š@pro/types
# åŸºç¡€ç±»å‹å®šä¹‰ï¼Œæ— ä¾èµ–ï¼Œæœ€åº•å±‚ package
# å½±å“èŒƒå›´ï¼štypes å˜åŒ–ä¼šå½±å“æ‰€æœ‰ä¾èµ–å®ƒçš„åç»­å±‚
# ========================================
COPY --chown=nestjs:nodejs packages/types/tsconfig.json ./packages/types/
COPY --chown=nestjs:nodejs packages/types/src ./packages/types/src
RUN echo "ğŸ—ï¸  æ„å»º @pro/types..." && \
    bun --filter @pro/types build

# ========================================
# ç¬¬äºŒå±‚ï¼š@pro/config
# é…ç½®ç®¡ç†ï¼Œæ— å¼ºä¾èµ–ï¼Œç‹¬ç«‹æ„å»º
# å½±å“èŒƒå›´ï¼šconfig å˜åŒ–å½±å“ä¾èµ–é…ç½®çš„ packages
# ========================================
COPY --chown=nestjs:nodejs packages/config/tsconfig.json ./packages/config/
COPY --chown=nestjs:nodejs packages/config/src ./packages/config/src
RUN echo "ğŸ—ï¸  æ„å»º @pro/config..." && \
    bun --filter @pro/config build

# ========================================
# ç¬¬ä¸‰å±‚ï¼š@pro/utils
# å·¥å…·å‡½æ•°åº“ï¼Œä¾èµ– types
# å½±å“èŒƒå›´ï¼šutils å˜åŒ–å½±å“ä½¿ç”¨å·¥å…·å‡½æ•°çš„ packages
# ========================================
COPY --chown=nestjs:nodejs packages/utils/tsconfig.json ./packages/utils/
COPY --chown=nestjs:nodejs packages/utils/src ./packages/utils/src
RUN echo "ğŸ—ï¸  æ„å»º @pro/utils..." && \
    bun --filter @pro/utils build

# ========================================
# ç¬¬å››å±‚ï¼šæœåŠ¡é›†æˆå±‚
# MongoDBã€Redisã€RabbitMQã€MinIO ç›¸äº’ç‹¬ç«‹
# å½±å“èŒƒå›´ï¼šå„è‡ªå˜åŒ–åªå½±å“ä¾èµ–å®ƒä»¬çš„åº”ç”¨
# ç¼“å­˜ç­–ç•¥ï¼šæ¯ä¸ªæœåŠ¡ç‹¬ç«‹ç¼“å­˜ï¼Œäº’ä¸å½±å“
# ========================================

# @pro/mongodb - MongoDB æ•°æ®åº“å°è£…
COPY --chown=nestjs:nodejs packages/mongodb/tsconfig.json ./packages/mongodb/
COPY --chown=nestjs:nodejs packages/mongodb/src ./packages/mongodb/src
RUN echo "ğŸ—ï¸  æ„å»º @pro/mongodb..." && \
    bun --filter @pro/mongodb build

# @pro/redis - Redis ç¼“å­˜å°è£…
COPY --chown=nestjs:nodejs packages/redis/tsconfig.json ./packages/redis/
COPY --chown=nestjs:nodejs packages/redis/src ./packages/redis/src
RUN echo "ğŸ—ï¸  æ„å»º @pro/redis..." && \
    bun --filter @pro/redis build

# @pro/rabbitmq - RabbitMQ æ¶ˆæ¯é˜Ÿåˆ—å°è£…
COPY --chown=nestjs:nodejs packages/rabbitmq/tsconfig.json ./packages/rabbitmq/
COPY --chown=nestjs:nodejs packages/rabbitmq/src ./packages/rabbitmq/src
RUN echo "ğŸ—ï¸  æ„å»º @pro/rabbitmq..." && \
    bun --filter @pro/rabbitmq build

# @pro/minio - MinIO å¯¹è±¡å­˜å‚¨å°è£…
COPY --chown=nestjs:nodejs packages/minio/tsconfig.json ./packages/minio/
COPY --chown=nestjs:nodejs packages/minio/src ./packages/minio/src
RUN echo "ğŸ—ï¸  æ„å»º @pro/minio..." && \
    bun --filter @pro/minio build

# ========================================
# ç”Ÿäº§é˜¶æ®µ (production)
# ç›®çš„ï¼šè¾“å‡ºåŒ…å«æ‰€æœ‰ packages æ„å»ºäº§ç‰©çš„é•œåƒ
# ç”¨é€”ï¼šä½œä¸ºåº”ç”¨é•œåƒçš„åŸºç¡€ï¼Œæä¾›é¢„æ„å»ºçš„ packages
# ä¼˜åŠ¿ï¼šåº”ç”¨æ„å»ºæ—¶æ— éœ€é‡æ–°æ„å»º packagesï¼Œå¤§å¹…æå‡é€Ÿåº¦
# ========================================
FROM base AS production

# åˆ‡æ¢åˆ° root ç”¨æˆ·ä»¥ç¡®ä¿å¤åˆ¶æƒé™
USER root

# è®¾ç½®å·¥ä½œç›®å½•
WORKDIR /app

# ========================================
# å¤åˆ¶ä¾èµ–å£°æ˜æ–‡ä»¶
# åº”ç”¨é•œåƒéœ€è¦è¿™äº›æ–‡ä»¶æ¥è¯†åˆ«ä¾èµ–å…³ç³»
# ========================================
COPY --chown=nestjs:nodejs package.json bun.lock ./

# å¤åˆ¶æ‰€æœ‰ packages çš„ package.json
COPY --chown=nestjs:nodejs packages/types/package.json ./packages/types/
COPY --chown=nestjs:nodejs packages/config/package.json ./packages/config/
COPY --chown=nestjs:nodejs packages/utils/package.json ./packages/utils/
COPY --chown=nestjs:nodejs packages/mongodb/package.json ./packages/mongodb/
COPY --chown=nestjs:nodejs packages/redis/package.json ./packages/redis/
COPY --chown=nestjs:nodejs packages/rabbitmq/package.json ./packages/rabbitmq/
COPY --chown=nestjs:nodejs packages/minio/package.json ./packages/minio/

# ========================================
# å®‰è£…æ‰€æœ‰ä¾èµ–
# ç”Ÿäº§é•œåƒéœ€è¦å®Œæ•´çš„ node_modules ä»¥æ”¯æŒåº”ç”¨è¿è¡Œ
# ========================================
RUN --mount=type=cache,id=bun-packages-prod,target=/root/.bun/install/cache \
    echo "ğŸ“¦ å®‰è£…ç”Ÿäº§ä¾èµ–..." && \
    bun install

# ========================================
# å¤åˆ¶æ„å»ºäº§ç‰©
# ä» builder é˜¶æ®µå¤åˆ¶æ‰€æœ‰ packages çš„ç¼–è¯‘ç»“æœ
# æŒ‰ä¾èµ–å…³ç³»é¡ºåºå¤åˆ¶ï¼Œä¾¿äºç†è§£å’Œç»´æŠ¤
# ========================================
COPY --from=builder --chown=nestjs:nodejs /app/packages/types/dist ./packages/types/dist
COPY --from=builder --chown=nestjs:nodejs /app/packages/config/dist ./packages/config/dist
COPY --from=builder --chown=nestjs:nodejs /app/packages/utils/dist ./packages/utils/dist
COPY --from=builder --chown=nestjs:nodejs /app/packages/mongodb/dist ./packages/mongodb/dist
COPY --from=builder --chown=nestjs:nodejs /app/packages/redis/dist ./packages/redis/dist
COPY --from=builder --chown=nestjs:nodejs /app/packages/rabbitmq/dist ./packages/rabbitmq/dist
COPY --from=builder --chown=nestjs:nodejs /app/packages/minio/dist ./packages/minio/dist

# ========================================
# è®¾ç½®æƒé™å’Œç”¨æˆ·
# ç¡®ä¿æ‰€æœ‰æ–‡ä»¶å½’ nestjs ç”¨æˆ·æ‰€æœ‰
# ========================================
RUN chown -R nestjs:nodejs /app

# åˆ‡æ¢åˆ°é root ç”¨æˆ·ï¼ˆå®‰å…¨æœ€ä½³å®è·µï¼‰
USER nestjs

# ========================================
# ç¯å¢ƒå˜é‡é…ç½®
# ========================================
ENV NODE_ENV=production
ENV BUN_INSTALL_ROOT=/root/.bun
ENV PATH=/root/.bun/bin:$PATH

# ========================================
# é»˜è®¤å‘½ä»¤
# æ­¤é•œåƒä½œä¸ºåŸºç¡€é•œåƒä½¿ç”¨ï¼Œä¸ç›´æ¥è¿è¡Œ
# ========================================
CMD ["echo", "Packages builder image ready. Use as base for application images."]
