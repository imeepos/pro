# ========================================
# Packages Builder é•œåƒ
# ========================================
# ç›®çš„ï¼šæ„å»ºåŒ…å«æ‰€æœ‰å…±äº« packages çš„åŸºç¡€é•œåƒ
# ç”¨é€”ï¼šä¸ºåº”ç”¨é•œåƒæä¾›é¢„æ„å»ºçš„ packagesï¼Œå‡å°‘åº”ç”¨æ„å»ºæ—¶é—´
# ç­–ç•¥ï¼šå¤šé˜¶æ®µæ„å»º + åˆ†å±‚ç¼“å­˜ + ä¾èµ–å…³ç³»ä¼˜åŒ–
# ä¼˜åŒ–ï¼šåŸºäºç»Ÿä¸€æƒé™é…ç½®çš„ base é•œåƒï¼Œå‡å°‘ç”¨æˆ·åˆ‡æ¢
# ========================================

# ========================================
# åŸºç¡€é•œåƒé…ç½®
# åŸºäº imeepos/base:latestï¼ŒåŒ…å«ç»Ÿä¸€çš„æƒé™é…ç½®å’Œ bun å®‰è£…
# ========================================
ARG BUILD_FROM_BASE=imeepos/base:latest
FROM $BUILD_FROM_BASE AS base

# ========================================
# å…ƒæ•°æ®æ ‡ç­¾
# ========================================
LABEL maintainer="Pro Team" \
      description="åŒ…å«æ‰€æœ‰å…±äº« packages æ„å»ºäº§ç‰©çš„åŸºç¡€é•œåƒ" \
      base.image="imeepos/base:latest" \
      packages="types,config,utils,mongodb,redis,rabbitmq,minio"

# ========================================
# ä¾èµ–å£°æ˜é˜¶æ®µ (deps)
# ç›®çš„ï¼šå°†ä¾èµ–å£°æ˜ä¸æºä»£ç åˆ†ç¦»ï¼Œæœ€å¤§åŒ–ç¼“å­˜åˆ©ç”¨
# å˜åŒ–é¢‘ç‡ï¼šä½ï¼ˆä»…åœ¨ä¾èµ–å˜æ›´æ—¶é‡å»ºï¼‰
# ä¼˜åŒ–ï¼šåˆ©ç”¨ base é•œåƒçš„ç»Ÿä¸€æƒé™é…ç½®ï¼Œå‡å°‘ç”¨æˆ·åˆ‡æ¢
# ========================================
FROM base AS deps

# è®¾ç½®å·¥ä½œç›®å½•ï¼ˆbase é•œåƒå·²é…ç½®å¥½æƒé™ï¼‰
WORKDIR /app

# é…ç½® Bun ä¸´æ—¶ç›®å½•ï¼Œè§£å†³æƒé™é—®é¢˜
ENV BUN_TMPDIR=/home/nestjs/tmp \
    BUN_INSTALL_CACHE_DIR=/home/nestjs/.bun/install/cache

# ========================================
# å¤åˆ¶ workspace é…ç½®æ–‡ä»¶
# è¿™äº›æ–‡ä»¶å†³å®šäº† monorepo çš„ç»“æ„
# ä¼˜åŒ–ï¼šç›´æ¥ä½¿ç”¨ base é•œåƒçš„ nestjs ç”¨æˆ·æƒé™
# ========================================
COPY --chown=nestjs:nodejs package.json bun.lock ./

# ========================================
# å¤åˆ¶æ‰€æœ‰ packages çš„ package.json
# æŒ‰ä¾èµ–å…³ç³»æ’åºï¼Œä¾¿äºç†è§£æ„å»ºæµç¨‹
# ä¼˜åŒ–ï¼šä¿æŒæƒé™ä¸€è‡´æ€§ï¼Œæ— éœ€é¢å¤–æƒé™è®¾ç½®
# ========================================
# ç¬¬ä¸€å±‚ï¼šæ— ä¾èµ–çš„åŸºç¡€ packages
COPY --chown=nestjs:nodejs packages/types/package.json ./packages/types/
COPY --chown=nestjs:nodejs packages/config/package.json ./packages/config/

# ç¬¬äºŒå±‚ï¼šä¾èµ–åŸºç¡€ packages çš„å·¥å…·å±‚
COPY --chown=nestjs:nodejs packages/utils/package.json ./packages/utils/

# ç¬¬ä¸‰å±‚ï¼šæœåŠ¡é›†æˆå±‚ï¼ˆMongoDBã€Redisã€RabbitMQã€MinIOï¼‰
COPY --chown=nestjs:nodejs packages/mongodb/package.json ./packages/mongodb/
COPY --chown=nestjs:nodejs packages/redis/package.json ./packages/redis/
COPY --chown=nestjs:nodejs packages/rabbitmq/package.json ./packages/rabbitmq/
COPY --chown=nestjs:nodejs packages/minio/package.json ./packages/minio/

# ========================================
# å®‰è£…æ‰€æœ‰ä¾èµ–
# ä¼˜åŒ–ï¼šä½¿ç”¨ç»Ÿä¸€çš„ç¼“å­˜ç›®å½•å’Œæƒé™é…ç½®
# 1. åˆ©ç”¨ base é•œåƒå·²å®‰è£…çš„ bun
# 2. ä½¿ç”¨ç»Ÿä¸€çš„ç¼“å­˜ ID å’Œç›®å½•
# 3. å‡å°‘æƒé™åˆ‡æ¢æ“ä½œ
# 4. ç¡®ä¿ä¸´æ—¶ç›®å½•å­˜åœ¨å¹¶æœ‰æ­£ç¡®æƒé™
# ========================================
RUN --mount=type=cache,id=bun-packages,target=/home/nestjs/.bun/install/cache,uid=1001,gid=1001 \
    echo "ğŸ”§ å®‰è£…æ‰€æœ‰ packages ä¾èµ–..." && \
    mkdir -p /home/nestjs/tmp && \
    chmod 755 /home/nestjs/tmp && \
    BUN_TMPDIR=/home/nestjs/tmp bun install

# ========================================
# æ„å»ºé˜¶æ®µ (builder)
# ç›®çš„ï¼šæŒ‰ä¾èµ–å…³ç³»é€å±‚æ„å»º packages
# ç­–ç•¥ï¼šåˆ†å±‚æ„å»ºï¼Œæœ€å¤§åŒ–åˆ©ç”¨ Docker å±‚çº§ç¼“å­˜
# ä¼˜åŠ¿ï¼šæºç å˜åŒ–åªå½±å“ç›¸å…³å±‚åŠåç»­ä¾èµ–å±‚
# ä¼˜åŒ–ï¼šä¿æŒç»Ÿä¸€çš„æƒé™é…ç½®ï¼Œæ— éœ€ç”¨æˆ·åˆ‡æ¢
# ========================================
FROM deps AS builder

# ========================================
# å¤åˆ¶ TypeScript åŸºç¡€é…ç½®
# å˜åŒ–é¢‘ç‡ï¼šæä½ï¼Œæ”¾åœ¨æœ€å‰é¢
# ä¼˜åŒ–ï¼šç»§æ‰¿ base é•œåƒçš„æƒé™é…ç½®
# ========================================
COPY --chown=nestjs:nodejs tsconfig.base.json* ./

# ========================================
# ç¬¬ä¸€å±‚ï¼š@pro/types
# åŸºç¡€ç±»å‹å®šä¹‰ï¼Œæ— ä¾èµ–ï¼Œæœ€åº•å±‚ package
# å½±å“èŒƒå›´ï¼štypes å˜åŒ–ä¼šå½±å“æ‰€æœ‰ä¾èµ–å®ƒçš„åç»­å±‚
# ä¼˜åŒ–ï¼šä½¿ç”¨ç»Ÿä¸€çš„ç”¨æˆ·æƒé™å’Œç¼“å­˜é…ç½®
# ========================================
COPY --chown=nestjs:nodejs packages/types/tsconfig.json ./packages/types/
COPY --chown=nestjs:nodejs packages/types/src ./packages/types/src
RUN echo "ğŸ—ï¸  æ„å»º @pro/types..." && \
    bun --filter @pro/types build

# ========================================
# ç¬¬ä¸‰å±‚ï¼š@pro/utils
# å·¥å…·å‡½æ•°åº“ï¼Œä¾èµ– types
# å½±å“èŒƒå›´ï¼šutils å˜åŒ–å½±å“ä½¿ç”¨å·¥å…·å‡½æ•°çš„ packages
# ä¼˜åŒ–ï¼šåˆ©ç”¨å·²å®‰è£…çš„ä¾èµ–ï¼Œæ— éœ€é‡æ–°å®‰è£…
# ========================================
COPY --chown=nestjs:nodejs packages/utils/tsconfig.json ./packages/utils/
COPY --chown=nestjs:nodejs packages/utils/src ./packages/utils/src
RUN echo "ğŸ—ï¸  æ„å»º @pro/utils..." && \
    bun --filter @pro/utils build

# ========================================
# ç¬¬å››å±‚ï¼šæœåŠ¡é›†æˆå±‚
# MongoDBã€Redisã€RabbitMQã€MinIO ç›¸äº’ç‹¬ç«‹
# å½±å“èŒƒå›´ï¼šå„è‡ªå˜åŒ–åªå½±å“ä¾èµ–å®ƒä»¬çš„åº”ç”¨
# ç¼“å­˜ç­–ç•¥ï¼šæ¯ä¸ªæœåŠ¡ç‹¬ç«‹ç¼“å­˜ï¼Œäº’ä¸å½±å“
# ä¼˜åŒ–ï¼šç»Ÿä¸€æƒé™ç®¡ç†ï¼Œå‡å°‘æ„å»ºå¼€é”€
# ========================================

# @pro/mongodb - MongoDB æ•°æ®åº“å°è£…
COPY --chown=nestjs:nodejs packages/mongodb/tsconfig.json ./packages/mongodb/
COPY --chown=nestjs:nodejs packages/mongodb/src ./packages/mongodb/src
RUN echo "ğŸ—ï¸  æ„å»º @pro/mongodb..." && \
    bun --filter @pro/mongodb build

# @pro/redis - Redis ç¼“å­˜å°è£…
COPY --chown=nestjs:nodejs packages/redis/tsconfig.json ./packages/redis/
COPY --chown=nestjs:nodejs packages/redis/src ./packages/redis/src
RUN echo "ğŸ—ï¸  æ„å»º @pro/redis..." && \
    bun --filter @pro/redis build

# @pro/rabbitmq - RabbitMQ æ¶ˆæ¯é˜Ÿåˆ—å°è£…
COPY --chown=nestjs:nodejs packages/rabbitmq/tsconfig.json ./packages/rabbitmq/
COPY --chown=nestjs:nodejs packages/rabbitmq/src ./packages/rabbitmq/src
RUN echo "ğŸ—ï¸  æ„å»º @pro/rabbitmq..." && \
    bun --filter @pro/rabbitmq build

# @pro/minio - MinIO å¯¹è±¡å­˜å‚¨å°è£…
COPY --chown=nestjs:nodejs packages/minio/tsconfig.json ./packages/minio/
COPY --chown=nestjs:nodejs packages/minio/src ./packages/minio/src
RUN echo "ğŸ—ï¸  æ„å»º @pro/minio..." && \
    bun --filter @pro/minio build

# ========================================
# ç”Ÿäº§é˜¶æ®µ (production)
# ç›®çš„ï¼šè¾“å‡ºåŒ…å«æ‰€æœ‰ packages æ„å»ºäº§ç‰©çš„é•œåƒ
# ç”¨é€”ï¼šä½œä¸ºåº”ç”¨é•œåƒçš„åŸºç¡€ï¼Œæä¾›é¢„æ„å»ºçš„ packages
# ä¼˜åŠ¿ï¼šåº”ç”¨æ„å»ºæ—¶æ— éœ€é‡æ–°æ„å»º packagesï¼Œå¤§å¹…æå‡é€Ÿåº¦
# ä¼˜åŒ–ï¼šåŸºäºç»Ÿä¸€æƒé™é…ç½®ï¼Œå‡å°‘ç”¨æˆ·åˆ‡æ¢å’Œé‡å¤æ“ä½œ
# ========================================
FROM base AS production

# è®¾ç½®å·¥ä½œç›®å½•ï¼ˆbase é•œåƒå·²é…ç½®å¥½æƒé™ï¼‰
WORKDIR /app

# ========================================
# å¤åˆ¶ä¾èµ–å£°æ˜æ–‡ä»¶
# åº”ç”¨é•œåƒéœ€è¦è¿™äº›æ–‡ä»¶æ¥è¯†åˆ«ä¾èµ–å…³ç³»
# ä¼˜åŒ–ï¼šç›´æ¥ä½¿ç”¨ base é•œåƒçš„ nestjs ç”¨æˆ·æƒé™
# ========================================
COPY --chown=nestjs:nodejs package.json bun.lock ./

# å¤åˆ¶æ‰€æœ‰ packages çš„ package.json
# ä¼˜åŒ–ï¼šä¿æŒæƒé™ä¸€è‡´æ€§ï¼Œé¿å…é¢å¤–çš„æƒé™è®¾ç½®
COPY --chown=nestjs:nodejs packages/types/package.json ./packages/types/
COPY --chown=nestjs:nodejs packages/config/package.json ./packages/config/
COPY --chown=nestjs:nodejs packages/utils/package.json ./packages/utils/
COPY --chown=nestjs:nodejs packages/mongodb/package.json ./packages/mongodb/
COPY --chown=nestjs:nodejs packages/redis/package.json ./packages/redis/
COPY --chown=nestjs:nodejs packages/rabbitmq/package.json ./packages/rabbitmq/
COPY --chown=nestjs:nodejs packages/minio/package.json ./packages/minio/

# ========================================
# å®‰è£…æ‰€æœ‰ä¾èµ–
# ä¼˜åŒ–ï¼šå¤ç”¨ä¾èµ–é˜¶æ®µçš„ç¼“å­˜ï¼Œä½¿ç”¨ç»Ÿä¸€çš„ç¼“å­˜ç›®å½•
# 1. ä½¿ç”¨ç»Ÿä¸€çš„ç¼“å­˜ IDï¼Œæœ€å¤§åŒ–ç¼“å­˜å¤ç”¨
# 2. åˆ©ç”¨ base é•œåƒå·²é…ç½®çš„ bun å’Œæƒé™
# 3. é¿å…é‡å¤å®‰è£… base é•œåƒå·²æœ‰çš„ä¾èµ–
# 4. ç¡®ä¿ä¸´æ—¶ç›®å½•å­˜åœ¨å¹¶æœ‰æ­£ç¡®æƒé™
# ========================================
RUN --mount=type=cache,id=bun-packages,target=/home/nestjs/.bun/install/cache,uid=1001,gid=1001 \
    echo "ğŸ“¦ å®‰è£…ç”Ÿäº§ä¾èµ–..." && \
    mkdir -p /home/nestjs/tmp && \
    chmod 755 /home/nestjs/tmp && \
    BUN_TMPDIR=/home/nestjs/tmp bun install

# ========================================
# å¤åˆ¶æ„å»ºäº§ç‰©
# ä» builder é˜¶æ®µå¤åˆ¶æ‰€æœ‰ packages çš„ç¼–è¯‘ç»“æœ
# æŒ‰ä¾èµ–å…³ç³»é¡ºåºå¤åˆ¶ï¼Œä¾¿äºç†è§£å’Œç»´æŠ¤
# ä¼˜åŒ–ï¼šæƒé™ä¸€è‡´æ€§ï¼Œæ— éœ€é¢å¤–çš„ chown æ“ä½œ
# ========================================
COPY --from=builder --chown=nestjs:nodejs /app/packages/types/dist ./packages/types/dist
COPY --from=builder --chown=nestjs:nodejs /app/packages/config/dist ./packages/config/dist
COPY --from=builder --chown=nestjs:nodejs /app/packages/utils/dist ./packages/utils/dist
COPY --from=builder --chown=nestjs:nodejs /app/packages/mongodb/dist ./packages/mongodb/dist
COPY --from=builder --chown=nestjs:nodejs /app/packages/redis/dist ./packages/redis/dist
COPY --from=builder --chown=nestjs:nodejs /app/packages/rabbitmq/dist ./packages/rabbitmq/dist
COPY --from=builder --chown=nestjs:nodejs /app/packages/minio/dist ./packages/minio/dist

# ========================================
# ç¯å¢ƒå˜é‡é…ç½®
# ä¼˜åŒ–ï¼šä¸ base é•œåƒä¿æŒä¸€è‡´çš„ç¯å¢ƒå˜é‡
# ä½¿ç”¨ç»Ÿä¸€çš„å®¶ç›®å½•å’Œè·¯å¾„é…ç½®
# ========================================
ENV NODE_ENV=production \
    BUN_INSTALL=/home/nestjs/.bun \
    BUN_TMPDIR=/home/nestjs/tmp \
    BUN_INSTALL_CACHE_DIR=/home/nestjs/.bun/install/cache \
    PATH=${BUN_INSTALL}/bin:${PATH}

# ========================================
# ç”¨æˆ·æƒé™éªŒè¯
# ç¡®ä¿ä»¥æ­£ç¡®çš„ç”¨æˆ·èº«ä»½è¿è¡Œ
# ä¼˜åŒ–ï¼šbase é•œåƒå·²é…ç½®å¥½ï¼Œæ— éœ€é¢å¤–æ“ä½œ
# ========================================
USER nestjs

# ========================================
# é»˜è®¤å‘½ä»¤
# æ­¤é•œåƒä½œä¸ºåŸºç¡€é•œåƒä½¿ç”¨ï¼Œä¸ç›´æ¥è¿è¡Œ
# ä¼˜åŒ–ï¼šæä¾›æ›´è¯¦ç»†çš„é•œåƒä¿¡æ¯
# ========================================
CMD ["echo", "Packages builder image ready. Use as base for application images. All packages built and cached."]
