# 微博 MCP 自动化操作系统

## 项目概述

基于 MCP (Model Context Protocol) 协议，实现一个微博自动化操作系统。通过 Playwright + Cookie + AI 大模型的组合，让 AI 能够自主分析页面并执行操作。

## 当前进度

- ✅ 已获取微博 Cookie
- 🔲 待实现：Playwright + Cookie 页面渲染
- 🔲 待实现：HTML 分析与 AI 决策
- 🔲 待实现：操作执行引擎

## 核心架构

```
用户指令 → MCP Server → Playwright 渲染 → AI 分析 HTML → 选择操作 → 执行动作 → 反馈结果
```

## 技术方案

### 1. MCP Server 层
- 基于 MCP SDK 创建服务器
- 提供工具接口供 Claude 调用
- 管理 Playwright 浏览器实例生命周期

### 2. Playwright 浏览器控制层
- 启动浏览器实例（headless 或 有头模式）
- 注入已有的微博 Cookie
- 导航到目标网址
- 获取渲染后的 HTML/截图

### 3. AI 决策层
- 将当前页面状态（HTML/截图/可交互元素）发送给 AI
- AI 分析可执行的操作选项
- 根据任务目标选择下一步操作

### 4. 操作执行层
支持的操作类型：
- **点击操作**：点击按钮、链接、元素
- **输入操作**：填写表单、输入框
- **滚动操作**：页面滚动、加载更多
- **导航操作**：前进、后退、刷新
- **等待操作**：等待元素出现、等待加载完成
- **数据提取**：提取文本、链接、图片等信息

## 任务拆分

### 阶段一：基础架构搭建（依赖：无）

#### 任务 1.1：创建 MCP Server 项目结构
- 创建独立的 MCP 服务包
- 配置 TypeScript + MCP SDK 依赖
- 定义基础配置文件

#### 任务 1.2：Playwright 集成
- 集成 Playwright 库
- 实现浏览器实例管理
- 实现 Cookie 注入功能

#### 任务 1.3：定义 MCP Tools 接口
- `weibo_navigate`：导航到指定 URL
- `weibo_get_page_state`：获取当前页面状态
- `weibo_click`：点击元素
- `weibo_input`：输入文本
- `weibo_scroll`：滚动页面
- `weibo_extract_data`：提取数据

### 阶段二：页面分析能力（依赖：阶段一完成）

#### 任务 2.1：HTML 简化与结构化
- 提取可交互元素（按钮、链接、输入框）
- 为每个元素生成唯一标识符
- 移除无关的样式和脚本内容
- 生成简化的 DOM 树结构

#### 任务 2.2：页面状态描述
- 提取页面标题和主要内容
- 识别当前页面类型（首页/搜索页/详情页等）
- 列出所有可执行操作的元素列表

#### 任务 2.3：视觉辅助（可选）
- 生成页面截图
- 在截图上标注可交互元素
- 提供视觉 + 文本的双重输入

### 阶段三：操作执行引擎（依赖：阶段一完成）

#### 任务 3.1：元素定位器
- 实现多种选择器策略（CSS、XPath、文本）
- 元素可见性检查
- 智能等待与重试机制

#### 任务 3.2：操作执行器
- 实现点击操作（普通点击、右键、双击）
- 实现输入操作（输入、清空、按键）
- 实现滚动操作（滚动到元素、滚动距离）
- 实现导航操作（后退、前进、刷新）

#### 任务 3.3：操作验证与反馈
- 操作前验证元素状态
- 操作后确认结果
- 错误处理与重试

### 阶段四：AI 决策集成（依赖：阶段二、阶段三完成）

#### 任务 4.1：提示词工程
- 设计系统提示词模板
- 定义操作选择的输出格式
- 提供任务上下文和历史记录

#### 任务 4.2：决策循环
- 获取当前页面状态
- 发送给 AI 分析
- 解析 AI 返回的操作指令
- 执行操作并获取反馈
- 循环直到任务完成

#### 任务 4.3：任务管理
- 任务目标跟踪
- 操作历史记录
- 成功/失败判定

### 阶段五：微博特定功能（依赖：阶段四完成）

#### 任务 5.1：微博常见操作封装
- 发布微博
- 搜索内容
- 点赞/评论/转发
- 关注/取关用户
- 浏览热搜

#### 任务 5.2：数据采集
- 采集微博内容
- 采集用户信息
- 采集评论数据
- 采集热搜数据

#### 任务 5.3：反爬虫处理
- 随机延迟
- 行为模拟（鼠标移动、滚动）
- 请求频率控制

### 阶段六：测试与优化（依赖：阶段五完成）

#### 任务 6.1：单元测试
- MCP Server 接口测试
- Playwright 操作测试
- 元素定位测试

#### 任务 6.2：集成测试
- 完整任务流程测试
- 异常场景测试
- 性能测试

#### 任务 6.3：文档与示例
- API 文档
- 使用示例
- 最佳实践

## 执行顺序

```
阶段一（1.1 → 1.2 → 1.3）
    ↓
阶段二（2.1 → 2.2 → 2.3可选）并行 阶段三（3.1 → 3.2 → 3.3）
    ↓
阶段四（4.1 → 4.2 → 4.3）
    ↓
阶段五（5.1 并行 5.2 并行 5.3）
    ↓
阶段六（6.1 → 6.2 → 6.3）
```

## 技术栈

- **MCP SDK**：@modelcontextprotocol/sdk
- **Playwright**：浏览器自动化
- **TypeScript**：类型安全
- **Zod**：参数验证

## 注意事项

1. **Cookie 安全**：Cookie 应该加密存储，不要硬编码
2. **频率限制**：避免过快操作触发反爬虫
3. **错误处理**：网络错误、元素找不到、操作失败都要妥善处理
4. **资源管理**：及时关闭浏览器实例，避免内存泄漏
5. **日志记录**：记录所有操作和决策过程，便于调试

## 待讨论问题

1. MCP Server 是独立服务还是集成到现有项目？
2. 浏览器实例是长期保持还是按需创建？
3. Cookie 存储方式和更新机制？
4. 如何定义"任务完成"的标准？
5. 需要支持多账号并发操作吗？
6. 是否需要验证码处理机制？

## 下一步

请确认：
1. 这个方案是否符合你的预期？
2. 有哪些需要调整或补充的地方？
3. 优先级最高的是哪个部分？
