# 004 - 大屏幕系统自定义拖拽布局

## 需求概述

实现一个大屏幕展示系统，支持自定义拖拽布局、在线预览和投放展示。

## 系统架构

### 1. @pro/api - 后端服务
负责页面配置的数据管理

**功能模块：**
- 大屏页面 CRUD 接口
- 布局配置保存/加载
- 组件配置管理
- 权限控制

**数据模型设计：**
```typescript
// 大屏页面表
interface ScreenPage {
  id: string;
  name: string;              // 页面名称
  description?: string;      // 页面描述
  layout: LayoutConfig;      // 布局配置
  components: Component[];   // 组件列表
  status: 'draft' | 'published';  // 发布状态
  createdBy: string;         // 创建者
  createdAt: Date;
  updatedAt: Date;
}

// 布局配置
interface LayoutConfig {
  width: number;             // 画布宽度（如 1920）
  height: number;            // 画布高度（如 1080）
  background: string;        // 背景色/图片
  grid?: {
    enabled: boolean;
    size: number;
  };
}

// 组件配置
interface Component {
  id: string;
  type: string;              // 组件类型：chart/text/image/video/data-table
  position: {
    x: number;
    y: number;
    width: number;
    height: number;
    zIndex: number;
  };
  config: any;               // 组件特定配置
  dataSource?: {
    type: 'api' | 'static';
    url?: string;
    data?: any;
    refreshInterval?: number; // 刷新间隔（ms）
  };
}
```

**API 接口：**
```
POST   /api/screens              - 创建大屏页面
GET    /api/screens              - 获取页面列表（支持分页、筛选）
GET    /api/screens/:id          - 获取页面详情
PUT    /api/screens/:id          - 更新页面配置
DELETE /api/screens/:id          - 删除页面
POST   /api/screens/:id/copy     - 复制页面
POST   /api/screens/:id/publish  - 发布页面
POST   /api/screens/:id/draft    - 设为草稿
PUT    /api/screens/default/:id  - 设置默认页面
GET    /api/screens/default      - 获取默认页面
```

**请求/响应示例：**

```typescript
// POST /api/screens - 创建页面
Request:
{
  "name": "微博运营大屏",
  "description": "展示微博账号运营数据",
  "layout": {
    "width": 1920,
    "height": 1080,
    "background": "#0f1419",
    "grid": { "enabled": true, "size": 10 }
  },
  "components": []
}

Response:
{
  "id": "uuid-xxx",
  "name": "微博运营大屏",
  "status": "draft",
  "createdAt": "2025-10-08T10:00:00Z",
  ...
}

// PUT /api/screens/:id - 更新页面
Request:
{
  "layout": { ... },
  "components": [
    {
      "id": "comp-1",
      "type": "weibo-stats-card",
      "position": { "x": 0, "y": 0, "width": 4, "height": 2, "zIndex": 1 }
    },
    {
      "id": "comp-2",
      "type": "fans-trend-chart",
      "position": { "x": 4, "y": 0, "width": 8, "height": 4, "zIndex": 1 }
    }
  ]
}
```

### 2. @pro/admin - 管理后台（编辑器）
负责创建和管理大屏页面，提供拖拽布局编辑器

#### 核心功能模块

**1. 多页面管理功能**
- ✅ **页面列表**：展示所有创建的页面（名称、创建时间、状态）
- ✅ **创建页面**：快速创建新的大屏页面
- ✅ **编辑页面**：进入编辑器修改页面布局
- ✅ **删除页面**：删除不需要的页面
- ✅ **复制页面**：基于现有页面快速创建副本
- ✅ **切换页面**：在不同页面之间切换展示
- ✅ **设置默认**：设置系统启动时的默认页面
- 🔄 **页面状态**：草稿 / 已发布

**2. 可视化拖拽编辑器**
- ✅ **组件库面板**：展示所有可用的业务组件
- ✅ **拖拽添加组件**：从组件库拖拽到画布（Angular CDK）
- ✅ **布局调整**：移动、缩放组件（angular-gridster2）
- ✅ **实时预览**：切换预览模式，所见即所得
- ✅ **自动保存**：定时自动保存草稿
- ✅ **撤销/重做**：支持操作历史回退

**3. 组件库（业务组件开箱即用）**
- 📊 **微博已登录用户统计卡片** `WeiboLoggedInUsersCardComponent` ⭐️ 优先实现
  - 展示：已登录用户总数、今日新增、在线用户数
  - 数据源：GET `/api/weibo/logged-in-users/stats`
  - WebSocket：监听 `weibo:logged-in-users:update` 事件
  - 样式：亮色主题卡片

**技术栈：**
- 拖拽库：`angular-gridster2` + `@angular/cdk/drag-drop`
- 动态组件：`ComponentFactoryResolver`
- 组件注册：`ComponentRegistryService`
- 图表库：`ECharts`（用于图表类组件）
- 样式库：`TailwindCSS`

**编辑器页面结构：**
```
┌─────────────────────────────────────────────────────────────┐
│ 顶部工具栏                                                    │
│ [返回列表] [页面名称] [自动保存] [预览] [保存] [发布]          │
├──────────┬──────────────────────────────────┬───────────────┤
│          │                                  │               │
│ 左侧面板 │        中央画布区域               │  右侧面板     │
│          │                                  │               │
│ 组件库   │   ┌─────────────────────────┐   │  页面设置     │
│ ├─微博   │   │                         │   │  - 页面名称   │
│ │ 统计   │   │   gridster2 网格布局    │   │  - 画布尺寸   │
│ │ 卡片   │   │                         │   │  - 背景设置   │
│ ├─粉丝   │   │   [组件1] [组件2]       │   │  - 网格配置   │
│ │ 趋势   │   │                         │   │               │
│ ├─账号   │   │   [组件3]               │   │               │
│ │ 列表   │   │                         │   │               │
│ └─...    │   └─────────────────────────┘   │               │
│          │                                  │               │
└──────────┴──────────────────────────────────┴───────────────┘
```

### 3. @pro/web - 前台展示
负责大屏页面的线上投放和展示

**核心功能：**
- 根据页面 ID 加载配置
- 渲染大屏布局和组件
- 数据自动刷新
- 全屏展示模式
- 响应式适配（可选）

**技术要点：**
- 纯展示模式，不可编辑
- 支持实时数据更新
- 性能优化（大屏长时间运行）

## 技术方案

### 拖拽编辑器实现方案 ✅

**确定方案：angular-gridster2 + Angular CDK Drag Drop**

#### 技术栈组合
1. **angular-gridster2**：实现画布网格布局和组件拖拽调整
   - 网格化布局管理
   - 组件位置、尺寸调整
   - 响应式布局支持

2. **Angular CDK Drag Drop**：实现组件库拖拽
   - 从组件库拖拽到画布
   - 拖拽预览效果
   - 拖放逻辑处理

3. **ComponentFactoryResolver**：动态组件加载
   - 运行时动态创建组件实例
   - 支持懒加载
   - 类型安全

#### 组件注册机制

```typescript
// component-registry.service.ts
@Injectable({ providedIn: 'root' })
export class ComponentRegistryService {
  private components = new Map<string, Type<any>>();

  register(type: string, component: Type<any>) {
    this.components.set(type, component);
  }

  get(type: string): Type<any> | undefined {
    return this.components.get(type);
  }

  getAll(): Array<{ type: string; component: Type<any> }> {
    return Array.from(this.components.entries()).map(([type, component]) => ({
      type,
      component
    }));
  }
}
```

#### 业务组件开箱即用设计 **【核心理念】**

**设计原则：**
- ✅ **零配置**：组件内部已对接后端数据接口
- ✅ **自动获取**：组件通过 Service 自动获取数据
- ✅ **实时更新**：自动订阅 WebSocket 接收实时数据
- ✅ **统一接口**：所有组件遵循统一的生命周期

**示例组件实现：**

```typescript
// 微博已登录用户统计卡片组件
@Component({
  selector: 'app-weibo-logged-in-users-card',
  template: `
    <div class="stats-card bg-white rounded-lg shadow p-6">
      <h3 class="text-lg font-semibold text-gray-800 mb-4">微博已登录用户统计</h3>
      <div class="stats grid grid-cols-3 gap-4">
        <div class="stat-item text-center">
          <div class="text-2xl font-bold text-blue-600">{{ stats?.total || 0 }}</div>
          <div class="text-sm text-gray-500">总用户数</div>
        </div>
        <div class="stat-item text-center">
          <div class="text-2xl font-bold text-green-600">{{ stats?.todayNew || 0 }}</div>
          <div class="text-sm text-gray-500">今日新增</div>
        </div>
        <div class="stat-item text-center">
          <div class="text-2xl font-bold text-purple-600">{{ stats?.online || 0 }}</div>
          <div class="text-sm text-gray-500">在线用户</div>
        </div>
      </div>
    </div>
  `
})
export class WeiboLoggedInUsersCardComponent implements OnInit, OnDestroy {
  stats: any;
  private destroy$ = new Subject<void>();

  constructor(
    private weiboService: WeiboService,
    private wsService: WebSocketService
  ) {}

  ngOnInit() {
    // 自动获取初始数据
    this.weiboService.getLoggedInUsersStats().pipe(
      takeUntil(this.destroy$)
    ).subscribe(stats => {
      this.stats = stats;
    });

    // 自动订阅实时更新
    this.wsService.on('weibo:logged-in-users:update').pipe(
      takeUntil(this.destroy$)
    ).subscribe(stats => {
      this.stats = stats;
    });
  }

  ngOnDestroy() {
    this.destroy$.next();
    this.destroy$.complete();
  }
}
```

**数据接口定义：**

```typescript
// GET /api/weibo/logged-in-users/stats
interface LoggedInUsersStats {
  total: number;        // 已登录用户总数
  todayNew: number;     // 今日新增登录用户
  online: number;       // 当前在线用户数
}

// WebSocket 事件：weibo:logged-in-users:update
// 推送相同格式的数据
```

**用户使用流程：**
1. 从左侧组件库拖拽「微博已登录用户统计卡片」到画布
2. 组件自动调用 API 获取数据并展示
3. WebSocket 自动推送实时更新
4. 无需任何配置，开箱即用

### 工作流程

#### 1. 进入编辑器
- 用户点击「创建页面」创建新页面
- 或点击「编辑页面」编辑已有页面
- 进入可视化编辑器界面

#### 2. 拖拽组件
- 从左侧组件库面板选择组件
- 使用 Angular CDK Drag Drop 拖拽到画布
- gridster2 自动分配网格位置

#### 3. 调整布局
- 拖动组件调整位置
- 拖动边角调整尺寸
- 实时看到布局变化

#### 4. 实时预览
- 切换到预览模式
- 查看真实数据效果
- 所见即所得

#### 5. 保存页面
- 点击保存按钮
- 序列化画布配置
- 通过 RESTful API 保存到数据库

#### 6. 切换页面
- 在页面列表中选择不同页面
- 快速切换展示内容
- 支持设置默认页面

### 数据流设计

```
编辑器流程：
1. 用户从组件库拖拽组件（CDK Drag Drop）
2. 组件添加到 gridster2 画布
3. ComponentFactoryResolver 动态创建组件实例
4. 组件自动获取数据并展示（无需配置）
5. 用户调整布局（移动、缩放）
6. 点击保存，序列化配置 → POST /api/screens
7. 切换预览模式，查看真实效果

展示流程（@pro/web）：
1. 通过 URL 参数获取页面 ID（/screen/:id）
2. 调用 GET /api/screens/:id 获取配置
3. ComponentFactoryResolver 动态渲染组件
4. 组件自动获取数据 + WebSocket 实时更新
5. 全屏展示模式
```

## 开发计划与任务拆分

### 任务依赖关系分析

```
任务依赖图：
A(数据库设计) -> B(API接口) -> C(admin页面列表) -> D(编辑器框架)
                             -> E(web展示框架)

D(编辑器框架) -> F(组件注册服务) -> G(业务组件开发) -> H(拖拽功能)
E(web展示框架) -> I(渲染引擎)

H(拖拽功能) + I(渲染引擎) -> J(预览模式) -> K(集成测试)

执行顺序：
1. A（数据库）
2. B（API）
3. C|E 并行（admin列表 + web框架）
4. D（编辑器框架）
5. F（组件注册）
6. G（业务组件）
7. H|I 并行（拖拽 + 渲染）
8. J（预览）
9. K（测试）
```

### 阶段一：基础架构（后端优先）

**任务 A：数据库表设计**
- [ ] 创建 `screen_pages` 表
  - `id`, `name`, `description`, `layout`, `components`, `status`, `is_default`, `created_by`, `created_at`, `updated_at`
- [ ] 创建 Entity：`ScreenPage`
- [ ] 编写数据库迁移脚本

**任务 B：API 基础接口实现**（依赖 A）
- [ ] 创建 `screens` 模块（NestJS）
- [ ] 实现 CRUD 接口
  - `POST /api/screens` - 创建
  - `GET /api/screens` - 列表（分页）
  - `GET /api/screens/:id` - 详情
  - `PUT /api/screens/:id` - 更新
  - `DELETE /api/screens/:id` - 删除
  - `POST /api/screens/:id/copy` - 复制
  - `POST /api/screens/:id/publish` - 发布
  - `PUT /api/screens/default/:id` - 设置默认
  - `GET /api/screens/default` - 获取默认
- [ ] 实现微博已登录用户统计接口
  - `GET /api/weibo/logged-in-users/stats` - 获取统计数据
- [ ] 添加 JWT 权限校验（`@UseGuards(JwtAuthGuard)`）
- [ ] 实现 WebSocket Gateway
  - 创建 `ScreensGateway`
  - 支持 `weibo:logged-in-users:update` 事件推送
  - JWT 认证（WebSocket 握手时验证 token）
- [ ] 编写单元测试

**提交点：** 完成后提交代码 `feat(api): 实现大屏页面管理接口和 WebSocket`

### 阶段二：前端框架搭建（并行）

**任务 C：admin 页面列表**（依赖 B，与 E 并行）
- [ ] 创建 `screens` 路由和组件（需要登录，`canActivate: [AuthGuard]`）
- [ ] 实现页面列表页面
  - 表格展示（名称、状态、创建时间、操作）
  - 创建、编辑、删除、复制按钮
  - 设置默认页面功能
- [ ] 创建 `ScreenApiService`（HTTP 请求带 JWT token）
- [ ] 状态管理（Akita Store）

**任务 E：web 展示框架**（依赖 B，与 C 并行）
- [ ] 创建 `/screen/:id` 路由（需要登录，`canActivate: [AuthGuard]`）
- [ ] 创建 `screen-display.component`
- [ ] 创建 `ScreenApiService`（HTTP 请求带 JWT token）
- [ ] 创建 `WebSocketService`（连接时传递 JWT token）
- [ ] 全屏模式支持

**提交点：** 完成后提交代码 `feat(admin,web): 添加大屏页面管理基础框架`

### 阶段三：编辑器核心开发

**任务 D：编辑器框架**（依赖 C）
- [ ] 创建编辑器路由 `/screens/editor/:id`
- [ ] 搭建编辑器布局（三栏结构）
  - 顶部工具栏
  - 左侧组件库面板
  - 中央画布区域
  - 右侧设置面板
- [ ] 集成 `angular-gridster2`
- [ ] 基础保存/加载功能

**任务 F：组件注册服务**（依赖 D）
- [ ] 创建 `ComponentRegistryService`
- [ ] 定义组件接口 `IScreenComponent`
- [ ] 实现组件注册机制

**任务 G：业务组件开发**（依赖 F）
- [ ] 微博已登录用户统计卡片组件 `WeiboLoggedInUsersCardComponent`
  - 调用 `GET /api/weibo/logged-in-users/stats` 获取初始数据
  - 订阅 WebSocket 事件 `weibo:logged-in-users:update`
  - 亮色主题样式设计（白色卡片 + TailwindCSS）
  - 展示：总用户数、今日新增、在线用户数
- [ ] 注册组件到 Registry

**提交点：** 完成后提交代码 `feat(admin,web): 实现微博已登录用户统计卡片`

### 阶段四：拖拽与渲染（并行）

**任务 H：拖拽功能实现**（依赖 G，与 I 并行）
- [ ] 组件库 -> 画布拖拽（Angular CDK）
- [ ] gridster2 配置和集成
- [ ] ComponentFactoryResolver 动态创建组件
- [ ] 组件删除功能
- [ ] 布局序列化/反序列化

**任务 I：web 渲染引擎**（依赖 E+F，与 H 并行）
- [ ] 实现动态组件渲染
- [ ] 加载页面配置并渲染
- [ ] WebSocket 实时数据推送
- [ ] 性能优化（长时间运行）

**提交点：** 完成后分别提交 `feat(admin): 实现拖拽编辑功能` 和 `feat(web): 实现大屏渲染引擎`

### 阶段五：预览与测试

**任务 J：预览模式**（依赖 H+I）
- [ ] admin 编辑器预览模式
- [ ] 预览模式数据模拟
- [ ] 编辑/预览模式切换

**任务 K：集成测试**（依赖 J）
- [ ] E2E 测试：创建页面流程
- [ ] E2E 测试：编辑器拖拽流程
- [ ] E2E 测试：web 展示流程
- [ ] 性能测试

**提交点：** 完成后提交代码 `test: 添加大屏系统集成测试`

### 阶段六：优化与完善

- [ ] 样式优化（TailwindCSS）
- [ ] 自动保存功能
- [ ] 撤销/重做功能
- [ ] 错误处理和提示
- [ ] 文档编写

---

## 技术细节确认

### ✅ 已确认
1. **技术栈**：angular-gridster2 + Angular CDK + ComponentFactoryResolver
2. **核心理念**：业务组件开箱即用，零配置
3. **多页面管理**：完整的 CRUD + 默认页面设置
4. **固定分辨率**：1920x1080（暂不考虑响应式）

### ✅ 全部确认

1. **初期组件库范围**：
   - ✅ 暂时只实现 1 个演示组件即可
   - 📊 **微博已登录用户统计卡片** `WeiboLoggedInUsersCardComponent`（优先实现）
   - 展示：总用户数、今日新增、在线用户数

2. **WebSocket 实时推送**：
   - ✅ 优先使用 WebSocket
   - 组件自动订阅 WebSocket 事件接收实时数据
   - 需要实现 WebSocket Gateway（NestJS）

3. **权限管理**：
   - ✅ **admin 编辑**：需要登录（JWT 鉴权）
   - ✅ **web 展示**：需要登录（JWT 鉴权）
   - 使用现有的 JWT Auth Guard

4. **组件样式主题**：
   - ✅ 亮色主题为主
   - ✅ 不需要主题切换功能

---

## 方案最终确认 ✅

已确认所有技术细节，准备进入开发阶段！
