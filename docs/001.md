# 001 登录注册功能开发规划

## 目标

开发完整的登录注册功能，包括：
- 后端API接口（NestJS）
- 后台管理系统登录注册页面（Angular）
- 大屏幕应用登录注册页面（Angular）

## 技术栈

- **后端**: NestJS + PostgreSQL + TypeORM + Redis + JWT
- **前端**: Angular 17 + RxJS
- **SDK**: @pro/sdk - 接口封装库（前端统一调用）
- **共享包**: @pro/types, @pro/utils, @pro/config

## 任务拆解

### 阶段0：基础设施准备 【最优先，可并行】

#### 0.1 共享类型定义 (@pro/types)
- [ ] 定义用户类型接口
  - User: id, username, email, status, createdAt, updatedAt
  - UserProfile: 用户档案信息
- [ ] 定义登录/注册请求 DTO 类型
  - RegisterDto: username, email, password
  - LoginDto: usernameOrEmail, password
- [ ] 定义登录/注册响应类型
  - AuthResponse: accessToken, refreshToken, user
- [ ] 定义 JWT Payload 类型
  - JwtPayload: userId, username, email, iat, exp
- [ ] 定义错误响应类型
  - ErrorResponse: code, message, details
- [ ] 导出给所有模块使用

#### 0.2 工具库 (@pro/utils)
- [ ] 密码校验工具
  - `validatePassword(password: string): ValidationResult`
  - 校验规则：长度 >= 6
  - 返回类型安全的校验结果
- [ ] Token 校验工具
  - `isTokenExpired(token: string): boolean`
  - `decodeToken(token: string): JwtPayload | null`
  - `getTokenExpiry(token: string): Date | null`
- [ ] 表单验证工具
  - `validateEmail(email: string): boolean`
  - `validateUsername(username: string): boolean`
- [ ] 通用工具
  - `formatDate(date: Date): string`
  - `debounce(fn, delay)`
  - 等
- [ ] 类型安全：所有函数都有明确的类型定义

#### 0.3 配置管理 (@pro/config)
- [ ] 定义环境配置接口
  - `IEnvironmentConfig`: apiBaseUrl, tokenKey, refreshTokenKey, timeout
- [ ] 实现环境变量读取
  - 开发环境配置
  - 生产环境配置
  - 测试环境配置
- [ ] 导出配置获取函数
  - `getConfig(): IEnvironmentConfig`
  - `getApiUrl(): string`
- [ ] 类型安全：配置对象强类型定义

---

### 阶段1：后端API开发 (@pro/api) 【优先级：高】

#### 1.1 数据库设计
- [ ] 设计 User 表结构（TypeORM Entity）
  - 字段：id, username, email, password(加密), status, createdAt, updatedAt
  - 索引：username(unique), email(unique)
- [ ] PostgreSQL 数据库连接配置
- [ ] TypeORM 配置与迁移

#### 1.2 核心模块开发
- [ ] 安装依赖包
  - `@nestjs/typeorm`
  - `typeorm`
  - `pg` (PostgreSQL driver)
  - `@nestjs/jwt`
  - `@nestjs/passport`
  - `passport-jwt`
  - `passport-local`
  - `bcryptjs`
  - `class-validator`
  - `class-transformer`

- [ ] 创建 Auth 模块
  - 注册接口 `POST /api/auth/register`
  - 登录接口 `POST /api/auth/login`
  - 获取当前用户信息 `GET /api/auth/profile`
  - 刷新Token `POST /api/auth/refresh`
  - 登出 `POST /api/auth/logout`

- [ ] 创建 User 模块
  - 用户 CRUD 接口
  - 用户信息更新

#### 1.3 认证与授权
- [ ] JWT 策略配置
- [ ] JWT 守卫实现
- [ ] 密码加密/验证工具
- [ ] Token 生成与验证

#### 1.4 数据验证
- [ ] 注册 DTO 验证（用户名、邮箱、密码强度）
- [ ] 登录 DTO 验证
- [ ] 全局异常处理

#### 1.5 Redis 会话管理
- [ ] Token 黑名单（登出功能）
- [ ] 用户会话存储

#### 1.6 测试
- [ ] 单元测试
- [ ] E2E 测试

---

### 阶段2：SDK 接口定义库开发 (@pro/sdk) 【依赖：阶段1】

#### 2.1 初始化 SDK 包
- [ ] 创建 @pro/sdk 包
- [ ] 配置 TypeScript
- [ ] 配置导出

#### 2.2 定义 HTTP 客户端抽象接口
- [ ] 定义 IHttpClient 接口
  - `get<T>(url: string, options?): Observable<T>`
  - `post<T>(url: string, body?, options?): Observable<T>`
  - `put<T>(url: string, body?, options?): Observable<T>`
  - `delete<T>(url: string, options?): Observable<T>`
- [ ] 定义请求配置接口
- [ ] 定义响应类型

#### 2.3 定义认证 API 抽象接口
- [ ] 定义 IAuthService 接口
  - `login(dto: LoginDto): Observable<AuthResponse>`
  - `register(dto: RegisterDto): Observable<AuthResponse>`
  - `logout(): Observable<void>`
  - `refreshToken(refreshToken: string): Observable<AuthResponse>`
  - `getProfile(): Observable<UserProfile>`

#### 2.4 定义用户 API 抽象接口
- [ ] 定义 IUserService 接口
  - `getUserInfo(id: string): Observable<User>`
  - `updateUserInfo(id: string, data: Partial<User>): Observable<User>`

#### 2.5 定义 SDK 配置接口
- [ ] 定义 SDKConfig 接口
  - baseURL
  - timeout
  - headers
- [ ] 定义 Token 存储接口
  - `getToken(): string | null`
  - `setToken(token: string): void`
  - `clearToken(): void`

#### 2.6 类型安全
- [ ] 引用 @pro/types 确保类型一致
- [ ] 导出所有接口定义
- [ ] 导出所有 API 类型

---

### 阶段3：前端并行开发（在阶段2完成后）

#### 3.1 后台管理系统 (@pro/admin) 【可并行】
- [ ] 安装依赖
  - `@pro/sdk`
  - `@pro/types`
  - `@pro/utils`
  - `@pro/config`
  - `@angular/common/http` (Angular 自带)
  - `@datorama/akita` (状态管理)
  - `@datorama/akita-ng-router-store` (可选，路由状态)

- [ ] 配置环境变量
  - 使用 @pro/config 读取环境配置
  - 配置 API baseURL
  - 配置 Token 存储 key

- [ ] 实现 SDK 接口
  - 实现 IAuthService
    - 使用 Angular HttpClient
    - 注入依赖
    - 使用 @pro/config 获取配置
  - 实现 IUserService
  - 实现 Token 存储（LocalStorage）
    - 使用 @pro/config 获取 tokenKey

- [ ] HTTP 拦截器
  - Token 拦截器：
    - 自动添加 Token 到请求头
    - 使用 @pro/utils 的 isTokenExpired 检查过期
  - 错误拦截器：
    - 401 自动刷新 Token 或跳转登录
    - 错误统一处理

- [ ] Akita 状态管理
  - 创建 Auth Store
    - 定义 AuthState 接口：
      - user: User | null
      - isAuthenticated: boolean
      - loading: boolean
      - error: string | null
    - 创建 AuthStore 类（继承 Store）
  - 创建 Auth Query
    - 创建 AuthQuery 类（继承 Query）
    - 定义 Selectors：
      - currentUser$: Observable<User | null>
      - isAuthenticated$: Observable<boolean>
      - loading$: Observable<boolean>
      - error$: Observable<string | null>
  - 创建 Auth Service
    - 集成 AuthStore 和 AuthQuery
    - 实现登录/注册/登出方法
    - 更新状态（setLoading, setUser, setError）

- [ ] 创建认证服务（AuthService）
  - 调用实现的 IAuthService（SDK 实现）
  - 集成 Akita 状态管理
  - Token 管理（get/set/clear）
  - 登录状态同步到 Store

- [ ] 开发登录页面组件
  - 表单设计（响应式表单）
  - 表单验证：
    - 使用 @pro/utils 的 validatePassword（长度 >= 6）
    - 使用 @pro/utils 的 validateEmail
    - 使用 @pro/utils 的 validateUsername
  - 错误提示
  - 加载状态（从状态管理获取）
  - 登录成功后跳转

- [ ] 开发注册页面组件
  - 表单设计（响应式表单）
  - 表单验证：
    - 使用 @pro/utils 的 validatePassword（长度 >= 6）
    - 使用 @pro/utils 的 validateEmail
    - 使用 @pro/utils 的 validateUsername
    - 确认密码验证（密码一致性）
  - 错误提示
  - 加载状态（从状态管理获取）
  - 注册成功后跳转登录或自动登录

- [ ] 路由配置
  - 登录路由 `/login`
  - 注册路由 `/register`

- [ ] 路由守卫
  - 认证守卫（AuthGuard）
  - 未登录跳转到登录页
  - 已登录跳转到主页

#### 3.2 大屏幕应用 (@pro/web) 【可并行】
- [ ] 安装依赖
  - `@pro/sdk`
  - `@pro/types`
  - `@pro/utils`
  - `@pro/config`
  - `@angular/common/http` (Angular 自带)
  - `@datorama/akita` (状态管理)
  - `@datorama/akita-ng-router-store` (可选，路由状态)

- [ ] 配置环境变量
  - 使用 @pro/config 读取环境配置
  - 配置 API baseURL
  - 配置 Token 存储 key

- [ ] 实现 SDK 接口
  - 实现 IAuthService
    - 使用 Angular HttpClient
    - 使用 @pro/config 获取配置
  - 实现 IUserService
  - 实现 Token 存储（LocalStorage）
    - 使用 @pro/config 获取 tokenKey

- [ ] HTTP 拦截器
  - Token 拦截器：
    - 自动添加 Token 到请求头
    - 使用 @pro/utils 的 isTokenExpired 检查过期
  - 错误拦截器：
    - 401 自动刷新 Token 或跳转登录
    - 错误统一处理

- [ ] Akita 状态管理（与 admin 相同结构）
  - 创建 Auth Store
    - 定义 AuthState 接口（同 admin）
    - 创建 AuthStore 类
  - 创建 Auth Query
    - 创建 AuthQuery 类
    - 定义 Selectors（同 admin）
  - 创建 Auth Service
    - 集成 AuthStore 和 AuthQuery
    - 实现登录/注册/登出方法
    - 更新状态

- [ ] 创建认证服务（AuthService）
  - 调用实现的 IAuthService（SDK 实现）
  - 集成 Akita 状态管理
  - Token 管理（get/set/clear）
  - 登录状态同步到 Store

- [ ] 开发大屏幕风格登录页面
  - **科技感 + 亮色主题**
  - 全屏设计
  - 表单设计（响应式表单）
  - 表单验证：
    - 使用 @pro/utils 的 validatePassword（长度 >= 6）
    - 使用 @pro/utils 的 validateEmail
    - 使用 @pro/utils 的 validateUsername
  - 错误提示
  - 加载状态（从状态管理获取）
  - 动画效果（渐入、悬浮等）
  - 科技感元素（网格、光效等）

- [ ] 开发大屏幕风格注册页面
  - **科技感 + 亮色主题**
  - 同登录页面风格
  - 表单验证：
    - 使用 @pro/utils 的 validatePassword（长度 >= 6）
    - 使用 @pro/utils 的 validateEmail
    - 使用 @pro/utils 的 validateUsername
    - 确认密码验证
  - 错误提示
  - 加载状态（从状态管理获取）

- [ ] 路由配置
  - 登录路由 `/login`
  - 注册路由 `/register`

- [ ] 路由守卫
  - 认证守卫（AuthGuard）
  - 未登录跳转到登录页
  - 已登录跳转到主页

---

### 阶段4：集成测试与优化
- [ ] 前后端联调测试
- [ ] 测试各种边界情况
  - 重复注册
  - 错误的用户名/密码
  - Token 过期
  - 并发请求
- [ ] 性能优化
- [ ] 安全性检查
  - SQL注入防护（虽然是MongoDB）
  - XSS防护
  - CSRF防护
  - 密码强度要求

---

## 任务依赖关系

```
阶段0: 基础设施准备（可并行）
  ├─ 0.1 @pro/types (类型定义)
  ├─ 0.2 @pro/utils (工具库：密码/Token/表单验证)
  └─ 0.3 @pro/config (配置管理：环境变量)
          ↓
阶段1: 后端API开发 (@pro/api)
  ├─ 依赖：@pro/types, @pro/utils, @pro/config
  ├─ 1.1 数据库设计 (PostgreSQL + TypeORM)
  ├─ 1.2 核心模块开发
  ├─ 1.3 认证与授权
  ├─ 1.4 数据验证（使用 @pro/utils）
  ├─ 1.5 Redis会话管理
  └─ 1.6 测试
          ↓
阶段2: SDK 接口定义 (@pro/sdk)
  ├─ 依赖：@pro/types
  ├─ 2.1 初始化 SDK 包
  ├─ 2.2 定义 HTTP 客户端抽象接口
  ├─ 2.3 定义认证 API 抽象接口
  ├─ 2.4 定义用户 API 抽象接口
  ├─ 2.5 定义 SDK 配置接口
  └─ 2.6 类型安全
          ↓
    (完成后，可并行执行)
          ↓
  ┌───────┴───────┐
  ↓               ↓
阶段3.1:        阶段3.2:
@pro/admin     @pro/web
(并行)         (并行)
  ├─ 依赖：@pro/sdk, @pro/types, @pro/utils, @pro/config
  ├─ 实现 SDK 接口（Angular HttpClient）
  ├─ 状态管理（NgRx/Akita/其他）
  ├─ HTTP 拦截器（使用 @pro/utils）
  ├─ 表单验证（使用 @pro/utils）
  └─ 登录/注册页面
  ↓               ↓
  └───────┬───────┘
          ↓
阶段4: 集成测试与优化
```

**关键依赖说明**：
1. **阶段0最优先**：基础设施（types, utils, config）是所有模块的基础
   - 0.1, 0.2, 0.3 可以并行开发
2. **阶段1依赖阶段0**：后端 API 使用 types/utils/config
3. **阶段2依赖阶段0和阶段1**：SDK 定义接口需要 types 和后端 API
4. **阶段3依赖阶段0和阶段2**：前端实现 SDK 接口，使用 utils/config
5. **阶段3.1 和 3.2 可并行**：两个前端应用都使用同一套基础设施
6. **阶段4在前端完成后**：需要前后端都完成才能集成测试

---

## 执行计划

### Phase 0: 基础设施准备（估计：1天）
**可并行开发 3 个 agent**：
1. Agent 1: 开发 @pro/types（类型定义）
2. Agent 2: 开发 @pro/utils（密码/Token/表单验证工具）
3. Agent 3: 开发 @pro/config（环境配置管理）
4. 各自完成后提交代码

### Phase 1: 后端开发（估计：2-3天）
1. 使用 1 个 code-artisan agent 开发 @pro/api
   - 依赖：@pro/types, @pro/utils, @pro/config
   - PostgreSQL + TypeORM 配置
   - Auth 模块开发（使用 @pro/utils 验证）
   - 测试
2. 完成后提交代码

### Phase 2: SDK 接口定义（估计：0.5天）
1. 使用 1 个 code-artisan agent 开发 @pro/sdk
   - 定义抽象接口（IAuthService, IUserService, IHttpClient）
   - 引用 @pro/types 确保类型安全
   - 定义配置接口
2. 完成后提交代码

### Phase 3: 前端并行开发（估计：3-4天）
**并行开发 2 个 agent**：
1. Agent 1: 开发 @pro/admin
   - 依赖：@pro/sdk, @pro/types, @pro/utils, @pro/config, @datorama/akita
   - 实现 SDK 接口（Angular HttpClient）
   - Akita 状态管理（AuthStore, AuthQuery, AuthService）
   - 登录/注册页面
2. Agent 2: 开发 @pro/web
   - 依赖：@pro/sdk, @pro/types, @pro/utils, @pro/config, @datorama/akita
   - 实现 SDK 接口（Angular HttpClient）
   - Akita 状态管理（与 admin 相同结构）
   - 大屏幕风格登录/注册页面（科技感 + 亮色主题）
3. 两个 agent **并行工作**
4. 各自完成后提交代码

### Phase 4: 集成测试（估计：1天）
1. 前后端联调
2. 测试各种场景
3. 修复问题
4. 提交最终代码

---

## 技术要点

### 后端 (@pro/api)
- **数据库**: PostgreSQL + TypeORM
  - Entity 定义用户表
  - 自动迁移
  - 索引优化（username、email unique）
- **认证**: JWT 认证机制
- **密码**: bcryptjs 加密，加盐 10 轮
- **Token**: Access Token 1小时，Refresh Token 7天
- **会话**: Redis 存储 Token 黑名单和用户会话
- **验证**: class-validator 进行数据验证

### SDK (@pro/sdk) - 接口定义库
- **设计模式**: 抽象接口定义，前端实现
- **核心接口**:
  - IHttpClient: HTTP 客户端抽象
  - IAuthService: 认证服务接口
  - IUserService: 用户服务接口
  - ITokenStorage: Token 存储接口
- **类型安全**: 引用 @pro/types 确保类型一致
- **返回类型**: 所有方法返回 Observable（RxJS）
- **配置接口**: SDKConfig（baseURL, timeout, headers）

### 前端 (@pro/admin, @pro/web) - 实现层
- **HTTP 客户端**: Angular HttpClient (@angular/common/http)
- **SDK 实现**: 实现 @pro/sdk 定义的所有接口
- **拦截器**:
  - Token 拦截器：自动添加 Token 到请求头
  - 错误拦截器：401 自动刷新 Token 或跳转登录
  - 错误统一处理
- **状态管理**: Akita (@datorama/akita)
  - AuthStore: 存储认证状态（user, isAuthenticated, loading, error）
  - AuthQuery: 查询认证状态（Selectors）
  - AuthService: 管理认证逻辑
  - 基于 RxJS，响应式状态管理
- **Token 存储**: LocalStorage（使用 @pro/config 获取 key）
- **表单**: Reactive Forms
- **表单验证**: 使用 @pro/utils（密码、邮箱、用户名验证）
- **路由守卫**: Angular Router Guard 保护路由

### 前端 UI 差异
- **@pro/admin**: 传统后台管理风格
- **@pro/web**: 科技感 + 亮色主题 + 大屏幕设计

### 共享包 (@pro/types)
- 定义所有接口类型
- 前后端共享，确保类型一致
- DTO、Entity、Response 类型
- 错误类型、验证结果类型

### 工具库 (@pro/utils)
- **密码验证**：`validatePassword(password: string): ValidationResult`
  - 规则：长度 >= 6
  - 返回：`{ valid: boolean, errors: string[] }`
- **Token 工具**：
  - `isTokenExpired(token: string): boolean`
  - `decodeToken(token: string): JwtPayload | null`
  - `getTokenExpiry(token: string): Date | null`
- **表单验证**：
  - `validateEmail(email: string): boolean`
  - `validateUsername(username: string): boolean`
- **类型安全**：所有函数强类型定义
- **单元测试**：每个工具函数都有测试

### 配置库 (@pro/config)
- **环境配置接口**：`IEnvironmentConfig`
  - apiBaseUrl: string
  - tokenKey: string
  - refreshTokenKey: string
  - timeout: number
- **环境文件**：
  - development.ts
  - production.ts
  - test.ts
- **配置获取**：
  - `getConfig(): IEnvironmentConfig`
  - `getApiUrl(): string`
- **类型安全**：配置对象强类型
- **可扩展**：支持动态添加配置项

### Akita 状态管理架构
- **Store（存储）**：
  - 定义 State 接口
  - 继承 Store<State>
  - 提供 update 方法
- **Query（查询）**：
  - 继承 Query<State>
  - 定义 Selectors（Observable）
  - 提供派生状态
- **Service（服务）**：
  - 注入 Store 和 Query
  - 实现业务逻辑
  - 调用 Store.update 更新状态
- **DevTools**：
  - 支持 Redux DevTools
  - 状态变化追踪
  - 时间旅行调试

---

## 需求确认 ✅

1. **密码策略**：长度 >= 6 位，无特殊字符要求
2. **验证码**：不需要
3. **第三方登录**：不支持
4. **用户名规则**：支持用户名和邮箱登录（两者都可以）
5. **角色权限**：不需要角色系统（后续可扩展）
6. **大屏幕UI风格**：科技感 + 亮色主题

## 技术方案确认 ✅

### 已确认
1. **@pro/sdk 实现方案**：方案B - SDK 定义抽象接口，前端用 Angular HttpClient 实现
   - SDK 定义接口和类型（IAuthService, IUserService, IHttpClient等）
   - 前端使用 @angular/common/http 实现具体调用
   - 符合 Angular 生态，类型安全，灵活可扩展

2. **共享包职责**：
   - @pro/types：类型定义
   - @pro/utils：密码验证、Token 验证、表单验证
   - @pro/config：环境配置管理

3. **Angular 状态管理方案**：Akita
   - 基于 RxJS，API 简洁
   - 适合中型项目，扩展性好
   - 学习成本适中
   - 支持 DevTools

---

## 备注

- 每个小任务完成后提交代码
- 使用 code-artisan agent 保证代码质量
- 遵循 pnpm workspace 架构

### 共享包使用原则
- **@pro/types**：所有模块都引用，确保类型一致
- **@pro/utils**：
  - 后端使用：密码验证（在 DTO 验证中使用）
  - 前端使用：密码验证、Token 验证、表单验证
  - 避免重复代码，统一业务逻辑
- **@pro/config**：
  - 后端使用：读取数据库配置、Redis 配置等
  - 前端使用：读取 API baseURL、Token key 等
  - 环境隔离，配置集中管理

### SDK 设计模式
- SDK 定义抽象接口（接口层）
- 前端实现具体逻辑（实现层）
- 确保类型安全和代码复用

### 技术约束
- **类型安全第一**：所有模块强类型定义
- **前端 HTTP 客户端**：统一使用 Angular HttpClient，不使用 axios
- **密码验证**：最小长度 6 位，前后端都使用 @pro/utils 验证
- **Token 验证**：使用 @pro/utils 的 Token 工具
- **配置管理**：统一使用 @pro/config，不硬编码配置

### 并行开发策略
- **Phase 0**：3 个 agent 并行开发 types/utils/config
- **Phase 3**：2 个 agent 并行开发 admin/web
- 每个 agent 完成后立即提交代码

