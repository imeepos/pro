# Docker Compose 应用部署方案

## 项目概况

### 当前应用列表

**后端应用（NestJS）**
- `api` - API 主服务
- `cleaner` - 数据清理微服务
- `crawler` - 爬虫微服务

**前端应用（Angular）**
- `admin` - 管理后台 (端口 4201)
- `web` - 用户端 (端口 4200)

### 当前基础设施

已存在的 docker-compose.yml 包含：
- PostgreSQL
- Redis
- RabbitMQ
- MongoDB
- MinIO (对象存储)
- Nginx (反向代理)

## 部署方案设计

### 1. 容器化策略

#### 后端应用（NestJS）
- **镜像选择**: Node.js 18+ Alpine 基础镜像
- **构建方式**: 多阶段构建（build stage + production stage）
- **启动命令**: `node dist/main`
- **依赖**:
  - 数据库: PostgreSQL, MongoDB
  - 缓存: Redis
  - 消息队列: RabbitMQ
  - 对象存储: MinIO

#### 前端应用（Angular）
- **镜像选择**: Node.js (构建) + Nginx Alpine (运行)
- **构建方式**: 多阶段构建（npm build + nginx 静态文件服务）
- **Nginx 配置**: SPA 路由支持，API 代理

### 2. 服务依赖关系

```
基础设施层（已存在）
├── postgres
├── redis
├── rabbitmq
├── mongo
└── minio

应用层（待添加）
├── api (依赖: postgres, redis, rabbitmq, mongo, minio)
├── crawler (依赖: api, rabbitmq, mongo, minio)
├── cleaner (依赖: api, rabbitmq, mongo)
├── web (依赖: api)
└── admin (依赖: api)
```

### 3. 网络和端口规划

#### 内部服务（backend 网络）
- api: 3000
- crawler: 3001
- cleaner: 3002

#### 对外服务（通过 Nginx）
- web: 80 (/)
- admin: 80 (/admin)
- api: 80 (/api)

### 4. 环境变量管理

需要为每个应用配置：
- 数据库连接信息
- Redis 连接信息
- RabbitMQ 连接信息
- MinIO 配置
- API 端点
- 端口配置

### 5. Nginx 配置更新

需要更新 nginx 配置以支持：
- `/` -> web 应用
- `/admin` -> admin 应用
- `/api` -> api 服务
- 静态文件缓存
- SPA 路由支持

## 实施任务清单

### 阶段 1: 准备 Dockerfile（可并行）

- [ ] **任务 1.1**: 创建 api 应用的 Dockerfile
- [ ] **任务 1.2**: 创建 crawler 应用的 Dockerfile
- [ ] **任务 1.3**: 创建 cleaner 应用的 Dockerfile
- [ ] **任务 1.4**: 创建 web 应用的 Dockerfile
- [ ] **任务 1.5**: 创建 admin 应用的 Dockerfile

### 阶段 2: 配置环境变量

- [ ] **任务 2.1**: 更新 .env.example 添加应用相关环境变量
- [ ] **任务 2.2**: 为每个应用创建 .env.example 文件

### 阶段 3: 更新 docker-compose.yml

- [ ] **任务 3.1**: 添加 api 服务配置
- [ ] **任务 3.2**: 添加 crawler 服务配置（依赖 api）
- [ ] **任务 3.3**: 添加 cleaner 服务配置（依赖 api）
- [ ] **任务 3.4**: 添加 web 服务配置
- [ ] **任务 3.5**: 添加 admin 服务配置

### 阶段 4: 更新 Nginx 配置

- [ ] **任务 4.1**: 更新 nginx 配置支持前端应用路由
- [ ] **任务 4.2**: 配置 API 反向代理
- [ ] **任务 4.3**: 配置静态资源缓存策略

### 阶段 5: 验证和测试

- [ ] **任务 5.1**: 构建所有镜像
- [ ] **任务 5.2**: 启动所有服务
- [ ] **任务 5.3**: 验证服务健康检查
- [ ] **任务 5.4**: 验证服务间通信
- [ ] **任务 5.5**: 验证前端访问

## 技术细节待确认

1. **构建优化**
   - 是否使用 pnpm workspace 在 Docker 中构建？
   - 是否需要构建缓存层？

2. **开发模式**
   - 是否需要 docker-compose.dev.yml 用于开发？
   - 是否使用 volume 挂载源码实现热重载？

3. **生产优化**
   - 是否需要健康检查配置？
   - 是否需要资源限制？
   - 是否需要日志收集？

## 下一步

请确认以下问题：

1. **部署模式**: 这个方案是用于生产部署还是开发环境？或者两者都需要？
2. **构建方式**: 是否希望在 Docker 内使用 pnpm workspace 构建，还是在外部构建后复制？
3. **网络暴露**: 前端应用是否都通过 Nginx 统一入口，还是各自暴露端口？
4. **环境变量**: 是否有特殊的配置需求？
