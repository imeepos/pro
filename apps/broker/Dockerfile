# ========================================
# åŸºç¡€å‡†å¤‡é˜¶æ®µï¼šå…±äº«çš„ä¾èµ–å®‰è£…å±‚
# ç›®çš„ï¼šä¸º development å’Œ builder é˜¶æ®µæä¾›ç»Ÿä¸€çš„ä¾èµ–åŸºç¡€
# ç¼“å­˜ç­–ç•¥ï¼šä¼˜å…ˆä½¿ç”¨å·²æœ‰é•œåƒä½œä¸ºåŸºç¡€ï¼Œå¤§å¹…åŠ é€Ÿæ„å»º
# ========================================
ARG BUILD_FROM_BASE=node:20-alpine
FROM $BUILD_FROM_BASE AS base

# åˆ›å»ºé root ç”¨æˆ·ï¼ˆä¿®å¤æƒé™é—®é¢˜ï¼‰
RUN (getent group nodejs >/dev/null 2>&1 || addgroup -g 1001 -S nodejs) && \
    (id nestjs >/dev/null 2>&1 || adduser -S nestjs -u 1001)

# å®‰è£… bunï¼ˆå…¨å±€ï¼Œå¯è¢«åç»­é˜¶æ®µå¤ç”¨ï¼‰
RUN curl -fsSL https://bun.sh/install | bash

# è®¾ç½®å·¥ä½œç›®å½•å¹¶ç¡®ä¿æƒé™æ­£ç¡®
WORKDIR /app

# åˆ›å»º bun ç¼“å­˜ç›®å½•å¹¶è®¾ç½®æƒé™
RUN mkdir -p /root/.bun/install/cache && \
    chown -R nestjs:nodejs /app && \
    chown -R nestjs:nodejs /root/.bun

# ========================================
# ä¾èµ–å£°æ˜å±‚ï¼šå¤åˆ¶æ‰€æœ‰ package.json æ–‡ä»¶
# ç›®çš„ï¼šå°†ä¾èµ–å£°æ˜ä¸æºä»£ç åˆ†ç¦»ï¼Œæœ€å¤§åŒ–ç¼“å­˜åˆ©ç”¨
# å˜åŒ–é¢‘ç‡ï¼šä½ï¼ˆä»…åœ¨ä¾èµ–å˜æ›´æ—¶é‡å»ºï¼‰
# ========================================
# å¤åˆ¶ workspace é…ç½®æ–‡ä»¶
COPY pnpm-workspace.yaml package.json bun.lockb ./

# å¤åˆ¶æ‰€æœ‰ packages çš„ package.jsonï¼ˆæŒ‰ä¾èµ–å…³ç³»æ’åºï¼‰
COPY packages/types/package.json ./packages/types/
COPY packages/config/package.json ./packages/config/
COPY packages/utils/package.json ./packages/utils/
COPY packages/mongodb/package.json ./packages/mongodb/
COPY packages/redis/package.json ./packages/redis/
COPY packages/rabbitmq/package.json ./packages/rabbitmq/

# å¤åˆ¶ broker åº”ç”¨çš„ package.json
COPY apps/broker/package.json ./apps/broker/

# ========================================
# ä¾èµ–å®‰è£…å±‚ï¼šå®‰è£…æ‰€æœ‰ä¾èµ–
# ç›®çš„ï¼šä¸ºå¼€å‘å’Œæ„å»ºæä¾›å®Œæ•´çš„ä¾èµ–ç¯å¢ƒ
# ========================================
RUN --mount=type=cache,id=bun-base,target=/root/.bun/install/cache \
    echo "ğŸ”§ å®‰è£…æ‰€æœ‰ä¾èµ–..." && \
    chown -R nestjs:nodejs /app && \
    chown -R nestjs:nodejs /root/.bun && \
    bun install --frozen-lockfile

# ========================================
# å¼€å‘é˜¶æ®µï¼šåŸºäºä¾èµ–å±‚ï¼Œæ·»åŠ æºä»£ç çƒ­é‡è½½
# ========================================
FROM base AS development

# å¤åˆ¶æºä»£ç ï¼ˆå¼€å‘æ—¶éœ€è¦å®Œæ•´æºç ç”¨äºçƒ­é‡è½½ï¼‰
COPY packages/ ./packages/
COPY apps/ ./apps/

# æš´éœ²ç«¯å£
EXPOSE 3003

# å¯åŠ¨å¼€å‘æœåŠ¡å™¨
CMD ["bun", "--filter", "@pro/broker", "start:dev"]

# ============================================
# æ„å»ºé˜¶æ®µï¼šåŸºäºä¾èµ–å±‚ï¼ŒæŒ‰ä¾èµ–å…³ç³»é€å±‚æ„å»º
# ç›®çš„ï¼šæœ€å¤§åŒ–åˆ©ç”¨ç¼“å­˜ï¼Œåªé‡å»ºå˜åŒ–çš„éƒ¨åˆ†
# ç¼“å­˜ç­–ç•¥ï¼šæŒ‰ä¾èµ–å…³ç³»åˆ†å±‚ï¼Œæºç å˜åŒ–åªå½±å“ç›¸å…³å±‚
# ============================================
FROM base AS builder

# Builder é˜¶æ®µç›´æ¥ä½¿ç”¨ base é˜¶æ®µå®‰è£…çš„ä¾èµ–

# ============================================
# åŸºç¡€é…ç½®å±‚ï¼šTypeScript é…ç½®ï¼ˆå˜åŒ–é¢‘ç‡æä½ï¼‰
# ç›®çš„ï¼šå°†æ„å»ºé…ç½®ä¸æºä»£ç åˆ†ç¦»
# ============================================
COPY tsconfig.base.json* ./

# ============================================
# æ ¸å¿ƒä¾èµ–æ„å»ºå±‚ï¼šæŒ‰ä¾èµ–å…³ç³»é€æ„å»º packages
# ç›®çš„ï¼šåˆ©ç”¨ Docker å±‚çº§ç¼“å­˜ï¼Œåªé‡å»ºå˜åŒ–çš„ package
# æ„å»ºé¡ºåºï¼šæŒ‰ä¾èµ–å…³ç³»ä»åº•å±‚åˆ°ä¸Šå±‚
# ============================================

# ç¬¬ä¸€å±‚ï¼š@pro/typesï¼ˆåŸºç¡€ç±»å‹å®šä¹‰ï¼Œæ— ä¾èµ–ï¼‰
# ç›®çš„ï¼šæœ€åº•å±‚åŒ…ï¼Œtypes å˜åŒ–åªå½±å“æ­¤å±‚åŠæ‰€æœ‰åç»­å±‚
COPY packages/types/tsconfig.json ./packages/types/
COPY packages/types/src ./packages/types/src
RUN bun --filter @pro/types build

# ç¬¬äºŒå±‚ï¼š@pro/configï¼ˆé…ç½®ç®¡ç†ï¼Œä¾èµ– typesï¼‰
# ç›®çš„ï¼šconfig å˜åŒ–åªå½±å“æ­¤å±‚åŠä¾èµ–å®ƒçš„åç»­å±‚
COPY packages/config/tsconfig.json ./packages/config/
COPY packages/config/src ./packages/config/src
RUN bun --filter @pro/config build

# ç¬¬ä¸‰å±‚ï¼š@pro/mongodbï¼ˆMongoDB å°è£…ï¼Œç‹¬ç«‹ä¾èµ–ï¼‰
# ç›®çš„ï¼šmongodb å˜åŒ–åªå½±å“æ­¤å±‚åŠä¾èµ–å®ƒçš„åç»­å±‚
COPY packages/mongodb/tsconfig.json ./packages/mongodb/
COPY packages/mongodb/src ./packages/mongodb/src
RUN bun --filter @pro/mongodb build

# ç¬¬å››å±‚ï¼š@pro/utilsï¼ˆå·¥å…·å‡½æ•°ï¼Œç‹¬ç«‹ä¾èµ–ï¼‰
# ç›®çš„ï¼šutils å˜åŒ–åªå½±å“æ­¤å±‚åŠä¾èµ–å®ƒçš„åç»­å±‚
COPY packages/utils/tsconfig.json ./packages/utils/
COPY packages/utils/src ./packages/utils/src
RUN bun --filter @pro/utils build

# ç¬¬äº”å±‚ï¼š@pro/redisï¼ˆRedis å°è£…ï¼Œä¾èµ– configï¼‰
# ç›®çš„ï¼šredis å˜åŒ–åªå½±å“æ­¤å±‚åŠä¾èµ–å®ƒçš„åç»­å±‚
COPY packages/redis/tsconfig.json ./packages/redis/
COPY packages/redis/src ./packages/redis/src
RUN bun --filter @pro/redis build

# ç¬¬å…­å±‚ï¼š@pro/rabbitmqï¼ˆRabbitMQ å°è£…ï¼Œä¾èµ– configï¼‰
# ç›®çš„ï¼šrabbitmq å˜åŒ–åªå½±å“æ­¤å±‚åŠä¾èµ–å®ƒçš„åç»­å±‚
COPY packages/rabbitmq/tsconfig.json ./packages/rabbitmq/
COPY packages/rabbitmq/src ./packages/rabbitmq/src
RUN bun --filter @pro/rabbitmq build

# ç¬¬ä¸ƒå±‚ï¼š@pro/broker åº”ç”¨ï¼ˆé¡¶å±‚åº”ç”¨ï¼Œä¾èµ–æ‰€æœ‰ packagesï¼‰
# ç›®çš„ï¼šbroker å˜åŒ–åªå½±å“æ­¤å±‚ï¼Œæœ€å¤§åŒ–ç¼“å­˜åˆ©ç”¨
COPY apps/broker/tsconfig.json ./apps/broker/
COPY apps/broker/tsconfig.build.json* ./apps/broker/
COPY apps/broker/nest-cli.json* ./apps/broker/
COPY apps/broker/src ./apps/broker/src
RUN bun --filter @pro/broker build

# ========================================
# ç”Ÿäº§é˜¶æ®µï¼šè¿è¡Œæ—¶é•œåƒ
# ç›®çš„ï¼šåŸºäºæ„å»ºäº§ç‰©åˆ›å»ºåŒ…å«æ‰€æœ‰ä¾èµ–çš„è¿è¡Œæ—¶é•œåƒ
# ========================================
FROM node:20-alpine AS production

# ========================================
# è¿è¡Œæ—¶å‡†å¤‡å±‚ï¼šå®‰è£…ç³»ç»Ÿä¾èµ–å’Œé…ç½®ç”¨æˆ·
# ç›®çš„ï¼šé…ç½®å®‰å…¨çš„è¿è¡Œç¯å¢ƒï¼Œé¿å…ä½¿ç”¨ root ç”¨æˆ·
# ========================================
# å®‰è£… bun å’Œ dumb-initï¼ˆä¿¡å·å¤„ç†ï¼‰
RUN curl -fsSL https://bun.sh/install | bash && \
    apk add --no-cache dumb-init

# åˆ›å»ºé root ç”¨æˆ·ï¼ˆå®‰å…¨æœ€ä½³å®è·µï¼‰
RUN (getent group nodejs >/dev/null 2>&1 || addgroup -g 1001 -S nodejs) && \
    (id nestjs >/dev/null 2>&1 || adduser -S nestjs -u 1001)

# è®¾ç½®å·¥ä½œç›®å½•
WORKDIR /app

# ========================================
# ä¾èµ–å±‚ï¼šå®‰è£…æ‰€æœ‰ä¾èµ–ï¼ˆç”Ÿäº§å’Œå¼€å‘ï¼‰
# ç›®çš„ï¼šç®€åŒ–ä¾èµ–ç®¡ç†ï¼Œç¡®ä¿è¿è¡Œæ—¶ç¯å¢ƒå®Œæ•´
# ========================================
# å¤åˆ¶ä¾èµ–å£°æ˜æ–‡ä»¶
COPY --chown=nestjs:nodejs pnpm-workspace.yaml package.json bun.lockb ./
COPY --chown=nestjs:nodejs packages/types/package.json ./packages/types/
COPY --chown=nestjs:nodejs packages/config/package.json ./packages/config/
COPY --chown=nestjs:nodejs packages/utils/package.json ./packages/utils/
COPY --chown=nestjs:nodejs packages/mongodb/package.json ./packages/mongodb/
COPY --chown=nestjs:nodejs packages/redis/package.json ./packages/redis/
COPY --chown=nestjs:nodejs packages/rabbitmq/package.json ./packages/rabbitmq/
COPY --chown=nestjs:nodejs apps/broker/package.json ./apps/broker/

# å®‰è£…æ‰€æœ‰ä¾èµ–ï¼ˆåŒ…æ‹¬å¼€å‘ä¾èµ–ï¼‰
RUN --mount=type=cache,id=bun-all,target=/root/.bun/install/cache \
    bun install --frozen-lockfile

# ========================================
# æ„å»ºäº§ç‰©å±‚ï¼šå¤åˆ¶ç¼–è¯‘åçš„ä»£ç 
# ç›®çš„ï¼šä» builder é˜¶æ®µå¤åˆ¶æ„å»ºäº§ç‰©ï¼Œä¸åŒ…å«æºä»£ç 
# ä¼˜åŠ¿ï¼šé•œåƒä½“ç§¯å°ï¼Œå®‰å…¨æ€§é«˜ï¼Œæ„å»ºé€Ÿåº¦å¿«
# ========================================
# å¤åˆ¶ packages çš„æ„å»ºäº§ç‰©ï¼ˆæŒ‰ä¾èµ–å…³ç³»é¡ºåºå¤åˆ¶ï¼‰
COPY --from=builder --chown=nestjs:nodejs /app/packages/types/dist ./packages/types/dist
COPY --from=builder --chown=nestjs:nodejs /app/packages/config/dist ./packages/config/dist
COPY --from=builder --chown=nestjs:nodejs /app/packages/utils/dist ./packages/utils/dist
COPY --from=builder --chown=nestjs:nodejs /app/packages/mongodb/dist ./packages/mongodb/dist
COPY --from=builder --chown=nestjs:nodejs /app/packages/redis/dist ./packages/redis/dist
COPY --from=builder --chown=nestjs:nodejs /app/packages/rabbitmq/dist ./packages/rabbitmq/dist

# å¤åˆ¶åº”ç”¨çš„æ„å»ºäº§ç‰©
COPY --from=builder --chown=nestjs:nodejs /app/apps/broker/dist ./apps/broker/dist

# ========================================
# è¿è¡Œæ—¶é…ç½®ï¼šç”¨æˆ·æƒé™ã€ç¯å¢ƒå˜é‡å’Œå¥åº·æ£€æŸ¥
# ç›®çš„ï¼šé…ç½®ç”Ÿäº§ç¯å¢ƒçš„è¿è¡Œå‚æ•°
# ========================================
# åˆ‡æ¢åˆ°é root ç”¨æˆ·
USER nestjs

# æš´éœ²ç«¯å£
EXPOSE 3003

# è®¾ç½®ç”Ÿäº§ç¯å¢ƒå˜é‡
ENV NODE_ENV=production
ENV NODE_OPTIONS="--experimental-global-webcrypto"
ENV BUN_INSTALL_ROOT=/root/.bun
ENV PATH=/root/.bun/bin:$PATH

# å¥åº·æ£€æŸ¥ï¼ˆç¡®ä¿æœåŠ¡å¯ç”¨æ€§ï¼‰
HEALTHCHECK --interval=30s --timeout=3s --start-period=40s --retries=3 \
    CMD node -e "require('http').get('http://localhost:3003/health', (r) => {process.exit(r.statusCode === 200 ? 0 : 1)})"

# å¯åŠ¨åº”ç”¨ï¼ˆä½¿ç”¨ dumb-init å¤„ç†ä¿¡å·ï¼‰
ENTRYPOINT ["dumb-init", "--"]
CMD ["node", "apps/broker/dist/apps/broker/src/main.js"]
