<nz-layout class="h-full">
  <!-- 头部 -->
  <nz-page-header
    [title]="title"
    subTitle="填写事件的完整信息"
    [extra]="extraActions">
  </nz-page-header>

  <!-- 表单内容 -->
  <div class="flex-1 overflow-y-auto p-6">
    <form [formGroup]="eventForm" class="max-w-4xl mx-auto space-y-6">
      <!-- 基础信息 -->
      <nz-card title="基础信息" [nzBordered]="false">
        <form [formGroup]="eventForm" nz-form>
          <nz-form-item>
            <nz-form-control nzErrorTip="事件名称为必填项，最多200个字符">
              <nz-form-label>
                事件名称 <span style="color: red">*</span>
              </nz-form-label>
              <nz-input
                formControlName="eventName"
                nzPlaceHolder="请输入事件名称"
                [nzStatus]="eventForm.get('eventName')?.invalid && eventForm.get('eventName')?.touched ? 'error' : ''"
                nzSize="large"
              />
            </nz-form-control>
          </nz-form-item>

          <nz-form-item>
            <nz-row [nzGutter]="16">
              <nz-col [nzSpan]="12">
                <nz-form-control>
                  <nz-form-label>
                    行业类型 <span style="color: red">*</span>
                  </nz-form-label>
                  <nz-select
                    [formControl]="industryTypeIdControl"
                    nzPlaceHolder="请选择行业类型"
                    [nzOptions]="industryTypeOptions"
                    nzSize="large"
                  ></nz-select>
                </nz-form-control>
              </nz-col>
              <nz-col [nzSpan]="12">
                <nz-form-control>
                  <nz-form-label>
                    事件类型 <span style="color: red">*</span>
                  </nz-form-label>
                  <nz-select
                    [formControl]="eventTypeIdControl"
                    nzPlaceHolder="请选择事件类型"
                    [nzOptions]="eventTypeOptions"
                    nzSize="large"
                  ></nz-select>
                </nz-form-control>
              </nz-col>
            </nz-row>
          </nz-form-item>

          <nz-form-item>
            <nz-form-control>
              <nz-form-label>简介</nz-form-label>
              <nz-textarea
                formControlName="summary"
                [nzRows]="4"
                nzPlaceHolder="请输入事件简介"
                nzSize="large"
              />
            </nz-form-control>
          </nz-form-item>
        </form>
      </nz-card>

      <!-- 时间地点 -->
      <nz-card title="时间地点" [nzBordered]="false">
        <form [formGroup]="eventForm" nz-form>
          <nz-form-item>
            <nz-form-control nzErrorTip="请选择发生时间">
              <nz-form-label>
                发生时间 <span style="color: red">*</span>
              </nz-form-label>
              <nz-date-picker
                formControlName="occurTime"
                nzPlaceHolder="请选择发生时间"
                nzShowTime
                nzFormat="YYYY-MM-DD HH:mm:ss"
                [nzSize]="'large'"
                style="width: 100%"
              />
            </nz-form-control>
          </nz-form-item>

        </form>
      </nz-card>

      <!-- 标签设置 -->
      <nz-card title="标签设置" [nzBordered]="false">
        <app-tag-selector
          [selectedTagIds]="selectedTagIds"
          [allTags]="(allTags$ | async) || []"
          [popularTags]="(popularTags$ | async) || []"
          (tagsChange)="onTagsChange($event)"
          (tagCreate)="onTagCreate($event)"
        ></app-tag-selector>
      </nz-card>

      <!-- 附件上传 -->
      <nz-card title="附件上传" [nzBordered]="false">

        <div class="space-y-6">
          <!-- 图片上传 -->
          <div>
            <label class="block text-sm font-medium text-gray-900 dark:text-white mb-2">
              事件图片
              <span class="text-gray-500 text-xs ml-2">(最多9张，单张不超过10MB)</span>
            </label>
            <app-image-upload
              *ngIf="eventId"
              [eventId]="eventId"
              [multiple]="true"
              [maxCount]="9"
              [maxSize]="10 * 1024 * 1024"
              [existingImages]="existingImages"
              [disabled]="loading"
              (uploadSuccess)="onImageUploadSuccess($event)"
              (uploadError)="onImageUploadError($event)"
              (deleteSuccess)="onImageDeleteSuccess($event)"
            />
            <div *ngIf="!eventId" class="text-sm text-gray-500 dark:text-gray-400 py-4 px-6 bg-gray-50 dark:bg-gray-700 rounded-lg border border-dashed border-gray-300 dark:border-gray-600">
              请先保存事件草稿后再上传图片
            </div>
          </div>

          <!-- 文档上传 -->
          <div>
            <label class="block text-sm font-medium text-gray-900 dark:text-white mb-2">
              相关文档
              <span class="text-gray-500 text-xs ml-2">(最多10个，单个不超过50MB)</span>
            </label>
            <app-file-upload
              *ngIf="eventId"
              [eventId]="eventId"
              [multiple]="true"
              [maxCount]="10"
              [maxSize]="50 * 1024 * 1024"
              [disabled]="loading"
              (uploadSuccess)="onFileUploadSuccess($event)"
              (uploadError)="onFileUploadError($event)"
              (deleteSuccess)="onFileDeleteSuccess($event)"
            />
            <div *ngIf="!eventId" class="text-sm text-gray-500 dark:text-gray-400 py-4 px-6 bg-gray-50 dark:bg-gray-700 rounded-lg border border-dashed border-gray-300 dark:border-gray-600">
              请先保存事件草稿后再上传文档
            </div>
          </div>

          <!-- 视频上传 -->
          <div>
            <label class="block text-sm font-medium text-gray-900 dark:text-white mb-2">
              事件视频
              <span class="text-gray-500 text-xs ml-2">(最多3个，单个不超过500MB)</span>
            </label>
            <pro-video-upload
              *ngIf="eventId"
              [eventId]="eventId"
              [multiple]="true"
              [maxCount]="3"
              [maxSize]="500 * 1024 * 1024"
              [disabled]="loading"
              (uploadSuccess)="onVideoUploadSuccess($event)"
              (uploadError)="onVideoUploadError($event)"
              (deleteSuccess)="onVideoDeleteSuccess($event)"
            />
            <div *ngIf="!eventId" class="text-sm text-gray-500 dark:text-gray-400 py-4 px-6 bg-gray-50 dark:bg-gray-700 rounded-lg border border-dashed border-gray-300 dark:border-gray-600">
              请先保存事件草稿后再上传视频
            </div>
        </div>
      </nz-card>
    </form>
  </div>

  <!-- 操作按钮模板 -->
  <ng-template #extraActions>
    <nz-space>
      <nz-button (click)="cancel()" [nzLoading]="loading">取消</nz-button>
      <nz-button (click)="saveDraft()" [nzLoading]="loading">保存草稿</nz-button>
      <nz-button
        type="primary"
        (click)="publish()"
        [nzLoading]="loading">
        {{ isEditMode ? '保存并发布' : '创建并发布' }}
      </nz-button>
    </nz-space>
  </ng-template>
</nz-layout>
