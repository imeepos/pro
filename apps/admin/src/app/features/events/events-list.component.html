<nz-card>
  <nz-page-header
    title="事件管理"
    subTitle="管理和查看所有事件信息"
    [extra]="headerActions">
  </nz-page-header>

  <!-- 搜索区域 -->
  <div class="mb-4">
    <nz-space class="w-full">
      <nz-input-group nzSearch [nzSuffix]="suffixIcons">
        <input
          type="text"
          [(ngModel)]="filterParams.keyword"
          (keyup.enter)="onSearch(filterParams.keyword || '')"
          nz-input
          placeholder="搜索事件名称、描述..."
        />
      </nz-input-group>

      <!-- 视图切换 -->
      <nz-radio-group [(ngModel)]="viewMode" nzButtonStyle="solid">
        <label nz-radio-button nzValue="list">
          <span nz-icon nzType="unordered-list"></span>
          列表
        </label>
        <label nz-radio-button nzValue="map">
          <span nz-icon nzType="environment"></span>
          地图
        </label>
      </nz-radio-group>
    </nz-space>

    <!-- 搜索历史 -->
    <div class="mt-2" *ngIf="!filterParams.keyword && searchHistory.length > 0">
      <small class="text-gray-500">最近搜索：</small>
      <nz-space class="ml-2">
        <nz-tag *ngFor="let term of searchHistory.slice(0, 3)"
                (click)="onSearch(term)"
                nzMode="cursor">
          {{ term }}
        </nz-tag>
      </nz-space>
    </div>
  </div>

  <!-- 事件列表 -->
  <nz-table
    #basicTable
    [nzData]="events"
    [nzLoading]="loading"
    [nzFrontPagination]="false"
    [nzTotal]="total"
    [(nzPageIndex)]="filterParams.page"
    [(nzPageSize)]="filterParams.pageSize"
    (nzPageIndexChange)="onPageChange($event)"
    (nzPageSizeChange)="onPageSizeChange($event)"
    [nzShowSizeChanger]="true"
    [nzShowQuickJumper]="true"
    [nzPageSizeOptions]="[10, 20, 50, 100]"
    *ngIf="viewMode === 'list'">

    <thead>
      <tr>
        <th>事件名称</th>
        <th>状态</th>
        <th>发生时间</th>
        <th>地点</th>
        <th>操作</th>
      </tr>
    </thead>
    <tbody>
      <tr *ngFor="let event of basicTable.data">
        <td>
          <div>
            <strong>{{ event.eventName }}</strong>
            <div *ngIf="event.summary" class="text-gray-500 text-sm mt-1">
              {{ event.summary | slice:0:100 }}{{ event.summary.length > 100 ? '...' : '' }}
            </div>
          </div>
        </td>
        <td>
          <nz-tag [nzColor]="getStatusColor(event.status)">
            {{ getStatusText(event.status) }}
          </nz-tag>
        </td>
        <td>{{ formatDate(event.occurTime) }}</td>
        <td>{{ event.province }} {{ event.city }} <span *ngIf="event.district">{{ event.district }}</span></td>
        <td>
          <nz-space>
            <button nz-button nzType="link" nzSize="small" (click)="viewDetail(event)">查看</button>
            <button nz-button nzType="link" nzSize="small" (click)="editEvent(event)">编辑</button>
            <button
              *ngIf="event.status === 0"
              nz-button
              nzType="link"
              nzSize="small"
              (click)="publishEvent(event)">
              发布
            </button>
            <button
              *ngIf="event.status === 1"
              nz-button
              nzType="link"
              nzSize="small"
              (click)="archiveEvent(event)">
              归档
            </button>
            <button
              nz-button
              nzType="link"
              nzSize="small"
              nzDanger
              (click)="openDeleteDialog(event)">
              删除
            </button>
          </nz-space>
        </td>
      </tr>
    </tbody>
  </nz-table>

  <!-- 地图视图 -->
  <div class="h-64 flex items-center justify-center text-gray-500" *ngIf="viewMode === 'map'">
    <nz-empty nzDescription="地图视图功能开发中..."></nz-empty>
  </div>
</nz-card>

<!-- 操作按钮模板 -->
<ng-template #headerActions>
  <button nz-button type="primary" (click)="createEvent()">
    <span nz-icon nzType="plus"></span>
    创建事件
  </button>
</ng-template>

<!-- 搜索图标模板 -->
<ng-template #suffixIcons>
  <nz-space>
    <button nz-icon nzType="close-circle" *ngIf="filterParams.keyword" (click)="clearSearch()"></button>
    <button nz-icon nzType="search" (click)="onSearch(filterParams.keyword || '')"></button>
  </nz-space>
</ng-template>

<!-- 删除确认对话框 -->
<app-delete-event-dialog
  *ngIf="showDeleteDialog"
  [event]="eventToDelete"
  (confirm)="onConfirmDelete()"
  (cancel)="closeDeleteDialog()"
></app-delete-event-dialog>
