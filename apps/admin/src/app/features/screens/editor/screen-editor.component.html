<div #editorContainer class="flex flex-col w-full h-full" [class.fullscreen-mode]="isFullscreen$ | async">
  <!-- 顶部工具栏 -->
  <div *ngIf="!(isFullscreen$ | async)" class="toolbar flex items-center gap-1 px-4 py-2 bg-white border-b border-gray-200">
    <button
      (click)="backToList()"
      class="toolbar-icon-btn"
      title="返回列表">
      <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M19 12H5M5 12L12 19M5 12L12 5"/>
      </svg>
    </button>

    <div class="flex-1"></div>

    <button
      (click)="undo()"
      [disabled]="!canUndo()"
      class="toolbar-icon-btn"
      title="撤销 (Ctrl+Z)">
      <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M3 7v6h6"/>
        <path d="M21 17a9 9 0 00-9-9 9 9 0 00-6 2.3L3 13"/>
      </svg>
    </button>

    <button
      (click)="redo()"
      [disabled]="!canRedo()"
      class="toolbar-icon-btn"
      title="重做 (Ctrl+Y)">
      <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M21 7v6h-6"/>
        <path d="M3 17a9 9 0 019-9 9 9 0 016 2.3l3 2.7"/>
      </svg>
    </button>

    <div class="toolbar-divider"></div>

    <button
      (click)="toggleGridLines()"
      class="toolbar-icon-btn"
      [class.active]="showGrid$ | async"
      [title]="(showGrid$ | async) ? '隐藏网格' : '显示网格'">
      @if (showGrid$ | async) {
        <svg class="icon" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="2">
          <rect x="3" y="3" width="7" height="7"/>
          <rect x="14" y="3" width="7" height="7"/>
          <rect x="14" y="14" width="7" height="7"/>
          <rect x="3" y="14" width="7" height="7"/>
        </svg>
      } @else {
        <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <rect x="3" y="3" width="7" height="7"/>
          <rect x="14" y="3" width="7" height="7"/>
          <rect x="14" y="14" width="7" height="7"/>
          <rect x="3" y="14" width="7" height="7"/>
        </svg>
      }
    </button>

    <button
      (click)="toggleSnapToGrid()"
      class="toolbar-icon-btn"
      [class.active]="snapToGrid$ | async"
      [title]="(snapToGrid$ | async) ? '关闭网格吸附 (Shift临时禁用)' : '开启网格吸附'">
      @if (snapToGrid$ | async) {
        <svg class="icon" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="2">
          <path d="M6 4a2 2 0 012-2h8a2 2 0 012 2v16a2 2 0 01-2 2h-1.5a1 1 0 01-1-1v-4.5a1 1 0 00-1-1h-2a1 1 0 00-1 1V21a1 1 0 01-1 1H8a2 2 0 01-2-2V4z"/>
        </svg>
      } @else {
        <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M6 4a2 2 0 012-2h8a2 2 0 012 2v16a2 2 0 01-2 2h-1.5a1 1 0 01-1-1v-4.5a1 1 0 00-1-1h-2a1 1 0 00-1 1V21a1 1 0 01-1 1H8a2 2 0 01-2-2V4z"/>
        </svg>
      }
    </button>

    <button
      (click)="toggleMarkLine()"
      class="toolbar-icon-btn"
      [class.active]="showMarkLine$ | async"
      [title]="(showMarkLine$ | async) ? '隐藏对齐辅助线' : '显示对齐辅助线'">
      @if (showMarkLine$ | async) {
        <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M3 3v18M9 3v18M15 3v18M21 3v18"/>
        </svg>
      } @else {
        <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-dasharray="4 2">
          <path d="M3 3v18M9 3v18M15 3v18M21 3v18"/>
        </svg>
      }
    </button>

    <button
      (click)="toggleCoordinates()"
      class="toolbar-icon-btn"
      [class.active]="isShowCoordinates$ | async"
      [title]="(isShowCoordinates$ | async) ? '隐藏组件坐标 (Ctrl+Shift+C)' : '显示组件坐标 (Ctrl+Shift+C)'">
      @if (isShowCoordinates$ | async) {
        <svg class="icon" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="2">
          <path d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
          <path d="M9 12h6m-6 4h6"/>
        </svg>
      } @else {
        <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
          <path d="M9 12h6m-6 4h6"/>
        </svg>
      }
    </button>

    <button
      (click)="toggleTheme()"
      class="toolbar-icon-btn"
      [title]="(darkTheme$ | async) ? '切换到亮色主题' : '切换到暗色主题'">
      @if (darkTheme$ | async) {
        <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="12" cy="12" r="5"/>
          <path d="M12 1v2m0 18v2M4.22 4.22l1.42 1.42m12.72 12.72l1.42 1.42M1 12h2m18 0h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"/>
        </svg>
      } @else {
        <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/>
        </svg>
      }
    </button>

    <button
      (click)="togglePreview()"
      class="toolbar-icon-btn"
      [class.active]="previewMode"
      [title]="previewMode ? '切换到编辑模式' : '切换到预览模式'">
      @if (previewMode) {
        <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"/>
        </svg>
      } @else {
        <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
          <circle cx="12" cy="12" r="3"/>
        </svg>
      }
    </button>

    <button
      (click)="toggleFullscreen()"
      class="toolbar-icon-btn"
      [class.active]="isFullscreen$ | async"
      [title]="(isFullscreen$ | async) ? '退出全屏 (ESC)' : '全屏预览 (F11)'">
      @if (isFullscreen$ | async) {
        <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M8 3v3a2 2 0 01-2 2H3m18 0h-3a2 2 0 01-2-2V3m0 18v-3a2 2 0 012-2h3M3 16h3a2 2 0 012 2v3"/>
        </svg>
      } @else {
        <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M8 3H5a2 2 0 00-2 2v3m18 0V5a2 2 0 00-2-2h-3m0 18h3a2 2 0 002-2v-3M3 16v3a2 2 0 002 2h3"/>
        </svg>
      }
    </button>

    <button
      (click)="toggleLayerPanel()"
      class="toolbar-icon-btn"
      [class.active]="!layerPanelCollapsed"
      [title]="layerPanelCollapsed ? '显示图层面板' : '隐藏图层面板'">
      @if (!layerPanelCollapsed) {
        <svg class="icon" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="2">
          <path d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"/>
        </svg>
      } @else {
        <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"/>
        </svg>
      }
    </button>

    <div class="toolbar-divider"></div>

    <!-- 保存状态指示器 -->
    <div class="save-status-indicator flex items-center gap-2 px-3 py-1">
      @if ((saveStatus$ | async) === 'saving') {
        <svg class="w-4 h-4 animate-spin text-blue-500" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M21 12a9 9 0 11-6.219-8.56"/>
        </svg>
        <span class="text-xs text-blue-600">保存中...</span>
      } @else if ((saveStatus$ | async) === 'error') {
        <svg class="w-4 h-4 text-red-500" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="12" cy="12" r="10"/>
          <path d="M15 9l-6 6m0-6l6 6"/>
        </svg>
        <span class="text-xs text-red-600">保存失败</span>
      } @else if ((isDirty$ | async)) {
        <svg class="w-4 h-4 text-orange-500" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="12" cy="12" r="10"/>
          <path d="M12 6v6l4 2"/>
        </svg>
        <span class="text-xs text-orange-600">未保存</span>
      } @else {
        <svg class="w-4 h-4 text-green-500" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M20 6L9 17l-5-5"/>
        </svg>
        <span class="text-xs text-green-600">已保存</span>
      }
    </div>

    <button
      (click)="save()"
      [disabled]="(saveStatus$ | async) === 'saving'"
      class="toolbar-icon-btn"
      title="立即保存">
      @if ((saveStatus$ | async) === 'saving') {
        <svg class="icon animate-spin" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M21 12a9 9 0 11-6.219-8.56"/>
        </svg>
      } @else {
        <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M19 21H5a2 2 0 01-2-2V5a2 2 0 012-2h11l5 5v11a2 2 0 01-2 2z"/>
          <path d="M17 21v-8H7v8M7 3v5h8"/>
        </svg>
      }
    </button>

    <button
      (click)="publish()"
      class="toolbar-icon-btn"
      title="发布">
      <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M13 10V3L4 14h7v7l9-11h-7z"/>
      </svg>
    </button>
  </div>

  <!-- 主内容区 -->
  <div class="flex flex-1 min-h-0 overflow-hidden">
    <!-- 左侧组件库面板 -->
    <div *ngIf="!leftPanelCollapsed && !(isFullscreen$ | async)" class="component-library-panel w-64 border-r border-gray-200 bg-white overflow-hidden flex flex-col">
      <!-- 面板头部 -->
      <div class="p-3 border-b border-gray-200">
        <div class="flex items-center justify-between mb-3">
          <h3 class="text-sm font-semibold text-gray-700">组件库</h3>
          <button
            (click)="toggleLeftPanel()"
            class="text-gray-400 hover:text-gray-600 transition-colors"
            title="收起面板">
            <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M15 18l-6-6 6-6"/>
            </svg>
          </button>
        </div>

        <!-- 搜索框 -->
        <input
          type="text"
          [(ngModel)]="searchQuery"
          (ngModelChange)="onSearchChange($event)"
          placeholder="搜索组件..."
          class="w-full px-4 py-2 text-sm text-gray-900 bg-gray-50 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:bg-white"
        />
      </div>

      <!-- 分类标签 -->
      <div class="px-3 py-2 border-b border-gray-200 flex flex-wrap gap-2">
        @for (category of componentCategories; track category.name) {
          <button
            (click)="onCategoryChange(category.name)"
            [class.active]="selectedCategory === category.name"
            class="px-2 py-1 text-xs rounded-full transition-colors category-tag"
            [title]="category.name + ' (' + category.count + ')'">
            {{ category.name }} <span class="text-gray-400">({{ category.count }})</span>
          </button>
        }
      </div>

      <!-- 组件列表 -->
      <div class="flex-1 overflow-y-auto p-3">
        @if (filteredComponents.length === 0) {
          <div class="text-center py-8 text-gray-400 text-sm">
            <svg class="w-12 h-12 mx-auto mb-2 opacity-50" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="11" cy="11" r="8"/>
              <path d="M21 21l-4.35-4.35"/>
            </svg>
            <p>未找到匹配的组件</p>
          </div>
        } @else {
          <div class="space-y-2">
            @for (comp of filteredComponents; track comp.type) {
              <div
                draggable="true"
                [attr.data-component-type]="comp.type"
                (dragstart)="onComponentDragStart($event, comp)"
                (dragend)="onComponentDragEnd($event)"
                class="component-card p-3 border border-gray-200 rounded-lg cursor-move hover:border-blue-400 hover:shadow-md transition-all bg-white select-none">
                <div class="flex items-center gap-3">
                  <div class="component-icon w-10 h-10 rounded-md bg-blue-50 flex items-center justify-center text-blue-600 text-xl flex-shrink-0">
                    {{ comp.icon }}
                  </div>
                  <div class="flex-1 min-w-0">
                    <div class="text-sm font-medium text-gray-900 truncate">{{ comp.name }}</div>
                    <div class="text-xs text-gray-500 truncate">{{ comp.category }}</div>
                  </div>
                </div>
              </div>
            }
          </div>
        }
      </div>
    </div>

    <!-- 左侧面板折叠按钮 -->
    <button
      *ngIf="leftPanelCollapsed && !(isFullscreen$ | async)"
      (click)="toggleLeftPanel()"
      class="panel-toggle-btn left"
      title="展开组件库">
      <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M9 18l6-6-6-6"/>
      </svg>
    </button>

    <!-- 画布区域 -->
    <app-canvas class="flex-1 bg-gray-100 overflow-hidden p-1" [class.dark-theme]="darkTheme$ | async"></app-canvas>

    <!-- 右侧图层面板 -->
    <app-layer-panel *ngIf="!layerPanelCollapsed && !(isFullscreen$ | async)"></app-layer-panel>

    <!-- 右侧属性编辑面板 -->
    <app-right-sidebar
      *ngIf="!(isFullscreen$ | async)"
      [(collapsed)]="rightPanelCollapsed"
    ></app-right-sidebar>
  </div>
</div>
