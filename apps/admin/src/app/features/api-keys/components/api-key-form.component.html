<div class="space-y-4">
  <form [formGroup]="apiKeyForm" (ngSubmit)="onSubmit()" class="space-y-4">
    <!-- 基本信息 -->
    <div class="space-y-3">
      <h3 class="text-base font-semibold text-gray-900 dark:text-white pb-2 border-b border-gray-200 dark:border-gray-600">基本信息</h3>

      <!-- 名称 -->
      <div>
        <label for="name" class="block text-sm font-medium text-gray-900 dark:text-white mb-2">
          API Key 名称 <span class="text-red-500">*</span>
        </label>
        <input
          type="text"
          id="name"
          formControlName="name"
          class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-blue-500 dark:focus:border-blue-500"
          placeholder="例如：生产环境API密钥"
          [class.border-red-500]="hasError('name')"
          [class.dark:border-red-500]="hasError('name')"
        />
        <p class="mt-1 text-sm text-red-600 dark:text-red-400" *ngIf="hasError('name')">
          {{ getErrorMessage('name') }}
        </p>
      </div>

      <!-- 描述 -->
      <div>
        <label for="description" class="block text-sm font-medium text-gray-900 dark:text-white mb-2">
          描述信息
        </label>
        <textarea
          id="description"
          formControlName="description"
          rows="3"
          class="block w-full p-2.5 text-sm text-gray-900 bg-gray-50 rounded-lg border border-gray-300 focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-blue-500 dark:focus:border-blue-500 resize-none"
          placeholder="描述此 API Key 的用途和范围..."
        ></textarea>
        <p class="mt-1 text-xs text-gray-500 dark:text-gray-400 text-right">
          {{ apiKeyForm.get('description')?.value?.length || 0 }}/500
        </p>
      </div>
    </div>

    <!-- 权限配置 -->
    <div class="space-y-3">
      <h3 class="text-base font-semibold text-gray-900 dark:text-white pb-2 border-b border-gray-200 dark:border-gray-600">权限配置</h3>

      <!-- API 类型 -->
      <div>
        <label class="block text-sm font-medium text-gray-900 dark:text-white mb-2">
          API 类型 <span class="text-red-500">*</span>
        </label>
        <div class="grid grid-cols-1 gap-2">
          <ng-container *ngFor="let typeOption of apiTypeOptions; trackBy: trackByValue">
            <label class="relative flex items-center p-3 border rounded-lg cursor-pointer transition-colors"
                   [class.border-blue-600]="apiKeyForm.get('type')?.value === typeOption.value"
                   [class.bg-blue-50]="apiKeyForm.get('type')?.value === typeOption.value"
                   [class.dark:bg-blue-900/20]="apiKeyForm.get('type')?.value === typeOption.value"
                   [class.dark:border-blue-600]="apiKeyForm.get('type')?.value === typeOption.value"
                   [class.border-gray-300]="apiKeyForm.get('type')?.value !== typeOption.value"
                   [class.dark:border-gray-600]="apiKeyForm.get('type')?.value !== typeOption.value"
                   [class.bg-white]="apiKeyForm.get('type')?.value !== typeOption.value"
                   [class.dark:bg-gray-800]="apiKeyForm.get('type')?.value !== typeOption.value">
              <input
                type="radio"
                name="type"
                [value]="typeOption.value"
                formControlName="type"
                class="w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 focus:ring-blue-500 dark:focus:ring-blue-600 dark:ring-offset-gray-800 dark:bg-gray-700 dark:border-gray-600"
              />
              <div class="flex-1 ms-3">
                <div class="font-medium text-gray-900 dark:text-white">{{ typeOption.label }}</div>
                <div class="text-sm text-gray-600 dark:text-gray-400">{{ typeOption.description }}</div>
              </div>
            </label>
          </ng-container>
        </div>
      </div>

      <!-- 权限选择 -->
      <div>
        <div class="flex items-center justify-between mb-2">
          <label class="block text-sm font-medium text-gray-900 dark:text-white">
            详细权限 ({{ getSelectedPermissionsCount() }}/{{ permissionOptions.length }})
          </label>
          <button type="button"
                  class="text-xs text-blue-600 hover:text-blue-700 dark:text-blue-400 dark:hover:text-blue-300 transition-colors"
                  (click)="toggleAllPermissions()">
            {{ isAllPermissionsSelected() ? '取消全选' : '全选' }}
          </button>
        </div>

        <div class="bg-gray-50 dark:bg-gray-800 rounded-lg p-3 border border-gray-200 dark:border-gray-700">
          <!-- 权限组 -->
          <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
            <!-- 事件权限 -->
            <div class="space-y-1">
              <h4 class="text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">📅 事件管理</h4>
              <label class="flex items-center space-x-2 text-sm cursor-pointer hover:bg-white dark:hover:bg-gray-700 p-2 rounded transition-colors">
                <input type="checkbox"
                       class="w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500 dark:focus:ring-blue-600 dark:ring-offset-gray-800 dark:bg-gray-700 dark:border-gray-600"
                       [checked]="isPermissionSelected('read:events')"
                       (change)="onPermissionChange('read:events', $event)"
                       [disabled]="apiKeyForm.get('type')?.value !== 'admin'">
                <span class="text-gray-900 dark:text-white">读取事件数据</span>
              </label>
              <label class="flex items-center space-x-2 text-sm cursor-pointer hover:bg-white dark:hover:bg-gray-700 p-2 rounded transition-colors">
                <input type="checkbox"
                       class="w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500 dark:focus:ring-blue-600 dark:ring-offset-gray-800 dark:bg-gray-700 dark:border-gray-600"
                       [checked]="isPermissionSelected('write:events')"
                       (change)="onPermissionChange('write:events', $event)"
                       [disabled]="apiKeyForm.get('type')?.value !== 'admin'">
                <span class="text-gray-900 dark:text-white">写入事件数据</span>
              </label>
              <label class="flex items-center space-x-2 text-sm cursor-pointer hover:bg-white dark:hover:bg-gray-700 p-2 rounded transition-colors">
                <input type="checkbox"
                       class="w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500 dark:focus:ring-blue-600 dark:ring-offset-gray-800 dark:bg-gray-700 dark:border-gray-600"
                       [checked]="isPermissionSelected('delete:events')"
                       (change)="onPermissionChange('delete:events', $event)"
                       [disabled]="apiKeyForm.get('type')?.value !== 'admin'">
                <span class="text-gray-900 dark:text-white">删除事件数据</span>
              </label>
            </div>

            <!-- 用户权限 -->
            <div class="space-y-1">
              <h4 class="text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">👥 用户管理</h4>
              <label class="flex items-center space-x-2 text-sm cursor-pointer hover:bg-white dark:hover:bg-gray-700 p-2 rounded transition-colors">
                <input type="checkbox"
                       class="w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500 dark:focus:ring-blue-600 dark:ring-offset-gray-800 dark:bg-gray-700 dark:border-gray-600"
                       [checked]="isPermissionSelected('read:users')"
                       (change)="onPermissionChange('read:users', $event)"
                       [disabled]="apiKeyForm.get('type')?.value !== 'admin'">
                <span class="text-gray-900 dark:text-white">读取用户信息</span>
              </label>
              <label class="flex items-center space-x-2 text-sm cursor-pointer hover:bg-white dark:hover:bg-gray-700 p-2 rounded transition-colors">
                <input type="checkbox"
                       class="w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500 dark:focus:ring-blue-600 dark:ring-offset-gray-800 dark:bg-gray-700 dark:border-gray-600"
                       [checked]="isPermissionSelected('write:users')"
                       (change)="onPermissionChange('write:users', $event)"
                       [disabled]="apiKeyForm.get('type')?.value !== 'admin'">
                <span class="text-gray-900 dark:text-white">修改用户信息</span>
              </label>
            </div>

            <!-- 配置权限 -->
            <div class="space-y-1">
              <h4 class="text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">⚙️ 配置管理</h4>
              <label class="flex items-center space-x-2 text-sm cursor-pointer hover:bg-white dark:hover:bg-gray-700 p-2 rounded transition-colors">
                <input type="checkbox"
                       class="w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500 dark:focus:ring-blue-600 dark:ring-offset-gray-800 dark:bg-gray-700 dark:border-gray-600"
                       [checked]="isPermissionSelected('read:config')"
                       (change)="onPermissionChange('read:config', $event)"
                       [disabled]="apiKeyForm.get('type')?.value !== 'admin'">
                <span class="text-gray-900 dark:text-white">读取配置信息</span>
              </label>
              <label class="flex items-center space-x-2 text-sm cursor-pointer hover:bg-white dark:hover:bg-gray-700 p-2 rounded transition-colors">
                <input type="checkbox"
                       class="w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500 dark:focus:ring-blue-600 dark:ring-offset-gray-800 dark:bg-gray-700 dark:border-gray-600"
                       [checked]="isPermissionSelected('write:config')"
                       (change)="onPermissionChange('write:config', $event)"
                       [disabled]="apiKeyForm.get('type')?.value !== 'admin'">
                <span class="text-gray-900 dark:text-white">修改配置信息</span>
              </label>
            </div>

            <!-- 管理员权限 -->
            <div class="space-y-1">
              <h4 class="text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">🔐 管理权限</h4>
              <label class="flex items-center space-x-2 text-sm cursor-pointer hover:bg-white dark:hover:bg-gray-700 p-2 rounded transition-colors">
                <input type="checkbox"
                       class="w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500 dark:focus:ring-blue-600 dark:ring-offset-gray-800 dark:bg-gray-700 dark:border-gray-600"
                       [checked]="isPermissionSelected('admin:all')"
                       (change)="onPermissionChange('admin:all', $event)"
                       [disabled]="apiKeyForm.get('type')?.value !== 'admin'">
                <span class="text-gray-900 dark:text-white">管理员权限</span>
              </label>
              <p class="text-xs text-gray-500 dark:text-gray-400 ps-6">拥有所有系统功能的完全访问权限</p>
            </div>
          </div>

          <!-- 权限提示 -->
          <div class="mt-3 p-2 bg-blue-50 rounded-lg border border-blue-200 dark:bg-blue-900/20 dark:border-blue-800">
            <div class="flex items-start gap-2">
              <svg class="w-4 h-4 text-blue-600 dark:text-blue-400 flex-shrink-0 mt-0.5" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"/>
              </svg>
              <div class="text-xs text-blue-800 dark:text-blue-400">
                <p class="font-medium mb-1">权限说明：</p>
                <ul class="space-y-0.5 list-disc list-inside">
                  <li>只读类型：自动分配基础读取权限</li>
                  <li>读写类型：自动分配读写权限</li>
                  <li>管理员类型：拥有所有权限</li>
                  <li>自定义权限：仅在管理员类型下可选</li>
                </ul>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- 有效期设置 -->
    <div class="space-y-3">
      <h3 class="text-base font-semibold text-gray-900 dark:text-white pb-2 border-b border-gray-200 dark:border-gray-600">有效期设置</h3>

      <div>
        <label for="expiresAt" class="block text-sm font-medium text-gray-900 dark:text-white mb-2">
          过期时间
        </label>
        <div class="flex gap-2">
          <input
            type="datetime-local"
            id="expiresAt"
            formControlName="expiresAt"
            class="flex-1 bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-blue-500 dark:focus:border-blue-500"
            [min]="getMinDateTime()"
            [max]="getMaxDateTime()"
          />
          <button type="button"
                  class="px-3 py-2.5 text-sm text-gray-700 bg-gray-100 border border-gray-300 rounded-lg hover:bg-gray-200 dark:bg-gray-700 dark:text-gray-300 dark:border-gray-600 dark:hover:bg-gray-600"
                  (click)="setDefaultExpiryDate()">
            1年
          </button>
          <button type="button"
                  class="px-3 py-2.5 text-sm text-gray-700 bg-gray-100 border border-gray-300 rounded-lg hover:bg-gray-200 dark:bg-gray-700 dark:text-gray-300 dark:border-gray-600 dark:hover:bg-gray-600"
                  (click)="clearExpiryDate()">
            永久
          </button>
        </div>
        <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">
          留空表示永不过期。建议设置合理的过期时间以提高安全性。
        </p>
      </div>
    </div>

    <!-- 操作按钮 -->
    <div class="flex justify-end gap-3 pt-4 border-t border-gray-200 dark:border-gray-600">
      <button type="button"
              class="py-2.5 px-5 text-sm font-medium text-gray-900 focus:outline-none bg-white rounded-lg border border-gray-200 hover:bg-gray-100 hover:text-blue-700 focus:z-10 focus:ring-4 focus:ring-gray-100 dark:focus:ring-gray-700 dark:bg-gray-800 dark:text-gray-400 dark:border-gray-600 dark:hover:text-white dark:hover:bg-gray-700"
              (click)="onCancel()">
        取消
      </button>
      <button type="submit"
              class="text-white bg-blue-700 hover:bg-blue-800 focus:ring-4 focus:outline-none focus:ring-blue-300 font-medium rounded-lg text-sm px-5 py-2.5 text-center inline-flex items-center dark:bg-blue-600 dark:hover:bg-blue-700 dark:focus:ring-blue-800 disabled:opacity-50 disabled:cursor-not-allowed"
              [disabled]="!isFormValid() || loading">
        <svg *ngIf="loading" class="w-4 h-4 me-2 animate-spin" fill="none" viewBox="0 0 24 24">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
          <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        {{ loading ? '处理中...' : getSubmitButtonText() }}
      </button>
    </div>
  </form>
</div>