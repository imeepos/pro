<!-- æ¨¡æ€æ¡†èƒŒæ™¯ -->
<div class="fixed inset-0 z-50 flex items-center justify-center"
     *ngIf="visible"
     (click)="onBackdropClick($event)"
     (keydown)="onKeydown($event)"
     tabindex="-1">

  <!-- èƒŒæ™¯é®ç½© -->
  <div class="absolute inset-0 bg-black/60 backdrop-blur-sm animate-[fadeIn_0.2s_ease-out]"></div>

  <!-- æ¨¡æ€æ¡†å®¹å™¨ -->
  <div class="relative w-full max-w-3xl mx-4 max-h-[90vh] overflow-hidden animate-[slideUp_0.3s_ease-out]"
       (click)="onModalClick($event)">

    <!-- åˆ›å»º/ç¼–è¾‘è¡¨å• -->
    <div class="bg-white rounded-2xl shadow-[0_25px_70px_rgba(0,0,0,0.35)] overflow-hidden"
         *ngIf="isFormVisible()">

      <!-- æ¨¡æ€æ¡†å¤´éƒ¨ -->
      <div class="px-8 py-6 border-b border-slate-200 bg-gradient-to-r from-primary to-primary-dark">
        <div class="flex items-center justify-between">
          <div>
            <h2 class="text-2xl font-bold text-white">{{ getModalTitle() }}</h2>
            <p class="text-white/80 text-sm mt-1">{{ getActionDescription() }}</p>
          </div>
          <button class="w-8 h-8 flex items-center justify-center rounded-full bg-white/20 hover:bg-white/30 transition-colors text-white"
                  (click)="onClose()">
            <span class="text-xl">âœ•</span>
          </button>
        </div>
      </div>

      <!-- æ¨¡æ€æ¡†å†…å®¹ -->
      <div class="max-h-[calc(90vh-200px)] overflow-y-auto p-8">
        <!-- é”™è¯¯æç¤º -->
        <div class="mb-6 p-4 bg-red-50 border border-red-200 rounded-lg" *ngIf="error">
          <div class="flex items-start gap-3">
            <span class="text-red-500 text-lg">âš ï¸</span>
            <div>
              <h4 class="text-sm font-medium text-red-800">æ“ä½œå¤±è´¥</h4>
              <p class="text-sm text-red-600 mt-1">{{ error }}</p>
            </div>
          </div>
        </div>

        <!-- è¡¨å•ç»„ä»¶ -->
        <app-api-key-form
          [apiKey]="apiKey"
          [loading]="loading"
          (submit)="onFormSubmit($event)"
          (cancel)="onClose()">
        </app-api-key-form>
      </div>
    </div>

    <!-- åˆ é™¤/é‡æ–°ç”Ÿæˆç¡®è®¤ -->
    <div class="bg-white rounded-2xl shadow-[0_25px_70px_rgba(0,0,0,0.35)] overflow-hidden"
         *ngIf="isConfirmVisible()">

      <!-- æ¨¡æ€æ¡†å¤´éƒ¨ -->
      <div class="px-8 py-6 border-b border-slate-200"
           [ngClass]="isDangerousAction() ? 'bg-gradient-to-r from-red-600 to-red-700' : 'bg-gradient-to-r from-primary to-primary-dark'">
        <div class="flex items-center justify-between">
          <div>
            <h2 class="text-2xl font-bold text-white flex items-center gap-3">
              <span class="text-3xl">{{ isDangerousAction() ? 'âš ï¸' : 'ğŸ”„' }}</span>
              {{ getModalTitle() }}
            </h2>
            <p class="text-white/80 text-sm mt-1">{{ getActionDescription() }}</p>
          </div>
          <button class="w-8 h-8 flex items-center justify-center rounded-full bg-white/20 hover:bg-white/30 transition-colors text-white"
                  (click)="onClose()">
            <span class="text-xl">âœ•</span>
          </button>
        </div>
      </div>

      <!-- æ¨¡æ€æ¡†å†…å®¹ -->
      <div class="p-8">
        <!-- API Key ä¿¡æ¯ -->
        <div class="mb-6 p-4 bg-slate-50 rounded-lg border border-slate-200" *ngIf="apiKey">
          <div class="flex items-center justify-between">
            <div>
              <h3 class="font-semibold text-slate-800">{{ apiKey.name }}</h3>
              <p class="text-sm text-slate-600 mt-1">{{ apiKey.description || 'æ— æè¿°' }}</p>
              <div class="flex items-center gap-4 mt-2">
                <span class="text-xs px-2 py-1 rounded-full"
                      [ngClass]="apiKey.type === 'read_only' ? 'bg-blue-100 text-blue-700' : apiKey.type === 'read_write' ? 'bg-purple-100 text-purple-700' : 'bg-red-100 text-red-700'">
                  {{ apiKey.type === 'read_only' ? 'åªè¯»' : apiKey.type === 'read_write' ? 'è¯»å†™' : 'ç®¡ç†å‘˜' }}
                </span>
                <span class="text-xs px-2 py-1 rounded-full"
                      [ngClass]="apiKey.status === 'active' ? 'bg-green-100 text-green-700' : apiKey.status === 'inactive' ? 'bg-yellow-100 text-yellow-700' : apiKey.status === 'expired' ? 'bg-red-100 text-red-700' : 'bg-gray-100 text-gray-700'">
                  {{ apiKey.status === 'active' ? 'æ´»è·ƒ' : apiKey.status === 'inactive' ? 'æœªæ¿€æ´»' : apiKey.status === 'expired' ? 'å·²è¿‡æœŸ' : 'å·²æ’¤é”€' }}
                </span>
              </div>
            </div>
            <div class="text-right">
              <p class="text-xs text-slate-500">ä½¿ç”¨æ¬¡æ•°</p>
              <p class="text-lg font-semibold text-slate-800">{{ apiKey.usageCount.toLocaleString() }}</p>
            </div>
          </div>
        </div>

        <!-- ç¡®è®¤ä¿¡æ¯ -->
        <div class="mb-6">
          <div class="p-4 bg-amber-50 border border-amber-200 rounded-lg">
            <div class="flex items-start gap-3">
              <span class="text-amber-500 text-lg">âš ï¸</span>
              <div>
                <h4 class="text-sm font-medium text-amber-800">é‡è¦æé†’</h4>
                <p class="text-sm text-amber-700 mt-1">{{ getConfirmMessage() }}</p>
                <p class="text-sm text-amber-600 mt-2 font-medium">{{ getWarningMessage() }}</p>
              </div>
            </div>
          </div>
        </div>

        <!-- é”™è¯¯æç¤º -->
        <div class="mb-6 p-4 bg-red-50 border border-red-200 rounded-lg" *ngIf="error">
          <div class="flex items-start gap-3">
            <span class="text-red-500 text-lg">âš ï¸</span>
            <div>
              <h4 class="text-sm font-medium text-red-800">æ“ä½œå¤±è´¥</h4>
              <p class="text-sm text-red-600 mt-1">{{ error }}</p>
            </div>
          </div>
        </div>

        <!-- æ“ä½œæŒ‰é’® -->
        <div class="flex justify-end gap-4">
          <button class="px-6 py-2.5 text-sm font-medium text-slate-600 bg-white border-2 border-slate-300 rounded-lg hover:bg-slate-50 transition-all duration-200"
                  (click)="onClose()"
                  [disabled]="loading">
            å–æ¶ˆ
          </button>
          <button class="px-6 py-2.5 text-sm font-medium rounded-lg transition-all duration-300 shadow-[0_4px_12px_rgba(0,0,0,0.15)] hover:-translate-y-0.5 hover:shadow-[0_6px_20px_rgba(0,0,0,0.25)] disabled:opacity-60 disabled:cursor-not-allowed disabled:transform-none"
                  [ngClass]="getActionButtonClass()"
                  (click)="mode === 'delete' ? onDelete() : onRegenerate()"
                  [disabled]="loading">
            <span class="flex items-center gap-2">
              <span *ngIf="!loading">{{ getActionButtonText() }}</span>
              <span *ngIf="loading" class="flex items-center gap-2">
                <span class="inline-block w-4 h-4 border-2 border-white/30 border-t-white rounded-full animate-spin"></span>
                å¤„ç†ä¸­...
              </span>
            </span>
          </button>
        </div>
      </div>
    </div>

    <!-- æ–° API Key æ˜¾ç¤º -->
    <div class="bg-white rounded-2xl shadow-[0_25px_70px_rgba(0,0,0,0.35)] overflow-hidden"
         *ngIf="isNewKeyVisible()">

      <!-- æ¨¡æ€æ¡†å¤´éƒ¨ -->
      <div class="px-8 py-6 border-b border-slate-200 bg-gradient-to-r from-green-600 to-green-700">
        <div class="flex items-center justify-between">
          <div>
            <h2 class="text-2xl font-bold text-white flex items-center gap-3">
              <span class="text-3xl">âœ…</span>
              {{ mode === 'create' ? 'API Key åˆ›å»ºæˆåŠŸ' : 'API Key é‡æ–°ç”ŸæˆæˆåŠŸ' }}
            </h2>
            <p class="text-white/80 text-sm mt-1">
              {{ mode === 'create' ? 'æ‚¨çš„æ–° API Key å·²ç”Ÿæˆï¼Œè¯·å¦¥å–„ä¿ç®¡ã€‚' : 'æ‚¨çš„ API Key å·²é‡æ–°ç”Ÿæˆï¼Œè¯·åŠæ—¶æ›´æ–°ç›¸å…³åº”ç”¨ç¨‹åºã€‚' }}
            </p>
          </div>
          <button class="w-8 h-8 flex items-center justify-center rounded-full bg-white/20 hover:bg-white/30 transition-colors text-white"
                  (click)="onClose()">
            <span class="text-xl">âœ•</span>
          </button>
        </div>
      </div>

      <!-- æ¨¡æ€æ¡†å†…å®¹ -->
      <div class="p-8">
        <!-- å®‰å…¨æé†’ -->
        <div class="mb-6 p-4 bg-blue-50 border border-blue-200 rounded-lg">
          <div class="flex items-start gap-3">
            <span class="text-blue-500 text-lg">ğŸ”’</span>
            <div>
              <h4 class="text-sm font-medium text-blue-800">å®‰å…¨æé†’</h4>
              <ul class="text-sm text-blue-700 mt-2 space-y-1 list-disc list-inside">
                <li>è¯·ç«‹å³å¤åˆ¶å¹¶ä¿å­˜æ­¤ API Keyï¼Œå…³é—­æ­¤çª—å£åå°†æ— æ³•å†æ¬¡æŸ¥çœ‹å®Œæ•´å¯†é’¥</li>
                <li>è¯·å‹¿å°† API Key æš´éœ²åœ¨å®¢æˆ·ç«¯ä»£ç æˆ–å…¬å…±ä»“åº“ä¸­</li>
                <li>å»ºè®®å®šæœŸæ›´æ¢ API Key ä»¥ç¡®ä¿å®‰å…¨æ€§</li>
                <li>å¦‚æœ API Key æ„å¤–æ³„éœ²ï¼Œè¯·ç«‹å³é‡æ–°ç”Ÿæˆ</li>
              </ul>
            </div>
          </div>
        </div>

        <!-- API Key æ˜¾ç¤º -->
        <div class="mb-6">
          <label class="block text-sm font-medium text-slate-700 mb-2">æ‚¨çš„ API Key</label>
          <div class="flex items-center gap-2">
            <div class="flex-1 p-4 bg-slate-100 border-2 border-slate-300 rounded-lg font-mono text-sm">
              <span class="text-slate-800">{{ getDisplayedApiKey() }}</span>
            </div>
            <button class="px-4 py-2 text-sm text-slate-600 bg-slate-200 border border-slate-300 rounded-lg hover:bg-slate-300 transition-colors"
                    (click)="toggleFullApiKey()"
                    title="æ˜¾ç¤º/éšè—å®Œæ•´å¯†é’¥">
              {{ showFullApiKey ? 'éšè—' : 'æ˜¾ç¤º' }}
            </button>
            <button class="px-4 py-2 text-sm text-primary bg-primary/10 border border-primary/30 rounded-lg hover:bg-primary/20 transition-colors"
                    (click)="copyNewApiKey()"
                    title="å¤åˆ¶å¯†é’¥">
              ğŸ“‹ å¤åˆ¶
            </button>
          </div>
        </div>

        <!-- æ“ä½œæŒ‰é’® -->
        <div class="flex justify-end gap-4">
          <button class="px-6 py-2.5 text-sm font-medium text-white bg-green-600 border-none rounded-lg transition-all duration-300 shadow-[0_4px_12px_rgba(34,197,94,0.4)] hover:-translate-y-0.5 hover:shadow-[0_6px_20px_rgba(34,197,94,0.6)]"
                    (click)="completeNewApiKey()">
            æˆ‘å·²ä¿å­˜ï¼Œå®Œæˆ
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- åŠ¨ç”»æ ·å¼ -->
<style>
@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}

@keyframes slideUp {
  from {
    opacity: 0;
    transform: translateY(20px) scale(0.95);
  }
  to {
    opacity: 1;
    transform: translateY(0) scale(1);
  }
}
</style>