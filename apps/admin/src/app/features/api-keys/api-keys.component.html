<div class="api-keys-container">
  <!-- 页面标题和操作按钮 -->
  <div class="page-header">
    <div class="header-content">
      <h1 class="page-title">API Key 管理</h1>
      <p class="page-subtitle">管理您的API访问密钥，控制应用权限</p>
    </div>
    <button class="btn-primary" (click)="openCreateModal()">
      <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
      </svg>
      创建新密钥
    </button>
  </div>

  <!-- API密钥列表 -->
  <div class="api-keys-list">
    @for (key of apiKeys; track key.id) {
      <div class="api-key-card" [class.inactive]="!key.isActive">
        <div class="key-header">
          <div class="key-info">
            <h3 class="key-name">{{ key.name }}</h3>
            <div class="key-meta">
              <span class="created-date">创建于 {{ formatDate(key.createdAt) }}</span>
              @if (key.lastUsed) {
                <span class="last-used">最后使用：{{ formatDateTime(key.lastUsed) }}</span>
              }
            </div>
          </div>
          <div class="key-status">
            @if (isKeyExpired(key)) {
              <span class="status-badge expired">已过期</span>
            } @else if (isKeyExpiringSoon(key)) {
              <span class="status-badge expiring-soon">即将过期</span>
            } @else if (key.isActive) {
              <span class="status-badge active">活跃</span>
            } @else {
              <span class="status-badge inactive">已禁用</span>
            }
          </div>
        </div>

        <div class="key-content">
          <div class="key-display">
            <code class="key-value">{{ key.key }}</code>
            <button class="btn-copy" (click)="copyToClipboard(key.key)" title="复制到剪贴板">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
              </svg>
            </button>
          </div>

          <div class="key-permissions">
            <h4 class="permissions-title">权限：</h4>
            <div class="permissions-list">
              @for (permission of key.permissions; track permission) {
                <span class="permission-badge" [ngClass]="getPermissionBadgeClass(permission)">
                  {{ getPermissionLabel(permission) }}
                </span>
              }
            </div>
          </div>

          @if (key.expiresAt) {
            <div class="key-expiry">
              <span class="expiry-label">过期时间：</span>
              <span class="expiry-date" [class.soon]="isKeyExpiringSoon(key)" [class.expired]="isKeyExpired(key)">
                {{ formatDate(key.expiresAt) }}
              </span>
            </div>
          }
        </div>

        <div class="key-actions">
          <button class="btn-secondary" (click)="toggleKeyStatus(key)">
            {{ key.isActive ? '禁用' : '启用' }}
          </button>
          <button class="btn-danger" (click)="openDeleteModal(key)">
            删除
          </button>
        </div>
      </div>
    } @empty {
      <div class="empty-state">
        <div class="empty-icon">
          <svg class="w-16 h-16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z"></path>
          </svg>
        </div>
        <h3 class="empty-title">还没有 API 密钥</h3>
        <p class="empty-description">创建您的第一个API密钥来开始使用我们的服务</p>
        <button class="btn-primary" (click)="openCreateModal()">创建第一个密钥</button>
      </div>
    }
  </div>
</div>

<!-- 创建API密钥模态框 -->
@if (showCreateForm) {
  <div class="modal-overlay" (click)="closeCreateModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2 class="modal-title">创建新的 API 密钥</h2>
        <button class="modal-close" (click)="closeCreateModal()">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
      </div>

      <form class="modal-body" (ngSubmit)="createApiKey()">
        <div class="form-group">
          <label class="form-label">密钥名称</label>
          <input
            type="text"
            class="form-input"
            [(ngModel)]="newKey.name"
            name="name"
            placeholder="例如：生产环境密钥"
            required>
        </div>

        <div class="form-group">
          <label class="form-label">权限设置</label>
          <div class="permissions-grid">
            @for (permission of availablePermissions; track permission.id) {
              <label class="permission-checkbox">
                <input
                  type="checkbox"
                  [(ngModel)]="newKey.permissions"
                  [value]="permission.id"
                  name="permissions">
                <div class="checkbox-content">
                  <span class="checkbox-label">{{ permission.label }}</span>
                  <span class="checkbox-description">{{ permission.description }}</span>
                </div>
              </label>
            }
          </div>
        </div>

        <div class="form-group">
          <label class="form-label">过期时间（可选）</label>
          <input
            type="date"
            class="form-input"
            [(ngModel)]="newKey.expiresAt"
            name="expiresAt"
            [min]="today">
        </div>
      </form>

      <div class="modal-footer">
        <button type="button" class="btn-secondary" (click)="closeCreateModal()">取消</button>
        <button type="submit" class="btn-primary" (click)="createApiKey()"
                [disabled]="!newKey.name || newKey.permissions.length === 0">
          创建密钥
        </button>
      </div>
    </div>
  </div>
}

<!-- 删除确认模态框 -->
@if (isDeleteModalOpen && selectedKey) {
  <div class="modal-overlay" (click)="closeDeleteModal()">
    <div class="modal-content modal-sm" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2 class="modal-title">确认删除</h2>
        <button class="modal-close" (click)="closeDeleteModal()">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
      </div>

      <div class="modal-body">
        <p class="confirm-message">
          您确定要删除API密钥 <strong>{{ selectedKey.name }}</strong> 吗？
        </p>
        <p class="warning-message">
          删除后无法恢复，所有使用此密钥的应用将无法访问API。
        </p>
      </div>

      <div class="modal-footer">
        <button class="btn-secondary" (click)="closeDeleteModal()">取消</button>
        <button class="btn-danger" (click)="deleteApiKey()">确认删除</button>
      </div>
    </div>
  </div>
}