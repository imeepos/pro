# 舆情管理后台系统 V1 版本规划

## 概述
舆情管理后台系统，用于管理爬虫任务、数据源配置、预警规则、情感分析配置、数据查看等核心管理功能。

## 技术栈（已确认）✅
- 前端框架: Angular 17+ + TypeScript
- 状态管理: RxJS + Angular Services
- UI 组件库: NG-ZORRO (Ant Design for Angular)
- 表格组件: nz-table (NG-ZORRO 内置)
- 表单组件: nz-form (NG-ZORRO 内置)
- 构建工具: Angular CLI
- 数据请求: HttpClient (Angular 内置)
- CSS 方案: SCSS + NG-ZORRO 样式
- 路由: @angular/router

## 需求确认 ✅
1. ✅ 不需要多管理员账号/角色权限（第一期单用户即可）
2. ✅ 不需要操作日志记录
3. ✅ 不需要国际化支持
4. ✅ 不需要响应式布局（仅PC端使用）
5. ✅ 使用 NG-ZORRO 组件库
6. ✅ 鉴权方案：用户表 + 密码加密（bcrypt）
7. ✅ 页面布局：左侧导航 + 顶部栏 + 内容区

## 第一期核心目标 🎯
**最重要的功能：微博扫码登录获取 Cookie**

第一期专注于实现微博扫码登录功能，获取并保存有效的 Cookie，为后续爬虫任务提供登录态。

## 核心功能模块

### 1. 微博 Cookie 管理（第一期核心功能）🎯
- 微博扫码登录
- 实时显示二维码（使用 Playwright 生成）
- 扫码状态监控（未扫码/已扫码/已确认/已过期）
- Cookie 自动提取和保存
- Cookie 有效性验证
- Cookie 失效提醒
- 重新获取 Cookie 功能
- Cookie 信息展示（登录账号、过期时间等）

### 2. 爬虫任务管理
- 任务列表展示
- 创建爬虫任务（URL、关键词、批量任务）
- 编辑任务配置
- 启动/停止任务
- 删除任务
- 任务执行状态实时监控
- 任务执行历史记录
- 任务失败重试

### 3. 数据源配置
- 爬虫频率配置
- User-Agent 配置
- 代理池配置（可选）
- 请求超时配置
- 重试次数配置

### 4. 舆情数据管理
- 舆情数据列表（分页、筛选、搜索）
- 数据详情查看
- 数据编辑（标题、内容、情感标签等）
- 数据删除（支持批量删除）
- 数据导出（Excel）
- 数据统计图表

### 5. 预警规则配置
- 预警规则列表
- 创建预警规则（关键词、情感、热度阈值等）
- 编辑预警规则
- 启用/禁用规则
- 删除规则
- 预警历史记录
- 预警测试功能

### 6. 情感分析配置
- 当前模型显示（DeepSeek/OpenAI/通义千问等）
- 切换大模型 Provider
- API Key 管理
- 批量分析配置（并发数、超时时间）
- 分析效果测试
- 分析成本统计

### 7. 数据清洗规则
- 去重规则配置
- 垃圾内容过滤规则（正则表达式）
- 时间格式标准化规则
- 地理位置提取规则
- 规则测试功能

### 8. 系统监控
- 爬虫运行状态（实时）
- 数据处理进度
- 消息队列状态（RabbitMQ）
- 数据库状态
- Redis 缓存统计
- API 调用统计
- 错误日志查看

### 9. 页面配置管理（复用 web 功能）
- 大屏页面列表
- 页面创建、编辑、删除
- 页面预览（跳转到 web 应用）

## 页面结构

### 主布局（Layout）
```
┌─────────────────────────────────────────────┐
│  顶部栏 (Header)                             │
│  - Logo + 系统名称                           │
│  - 当前时间                                  │
│  - 退出登录                                  │
├──────────┬──────────────────────────────────┤
│          │                                  │
│  侧边栏  │         内容区域                  │
│  (Sider) │         (Content)                │
│          │                                  │
│  - 导航  │  - 面包屑导航                     │
│    菜单  │  - 页面内容                       │
│          │                                  │
└──────────┴──────────────────────────────────┘
```

### 导航菜单结构
```
📊 系统监控 (Dashboard)
🔐 微博 Cookie 管理 **【第一期核心】**
🕷️ 爬虫管理
   ├─ 任务列表
   └─ 数据源配置
📰 数据管理
   ├─ 舆情数据
   └─ 预警记录
⚙️ 系统配置
   ├─ 情感分析配置
   ├─ 数据清洗规则
   └─ 预警规则配置
🖥️ 大屏管理
   └─ 页面管理
```

## 组件拆分

### 1. 布局组件 (Layout Components)

#### 1.1 AdminLayout (管理后台主布局)
- 功能: 整体布局框架（顶部+侧边+内容）
- 使用: nz-layout

#### 1.2 AdminHeader (顶部栏)
- Logo + 系统名称
- 当前时间
- 退出登录按钮

#### 1.3 AdminSider (侧边栏)
- 导航菜单 (nz-menu)
- 菜单折叠/展开

### 2. 微博 Cookie 管理组件 **【第一期核心】**

#### 2.0 WeiboCookieManager (微博 Cookie 管理页面) 🎯
- 扫码登录区域
  - 二维码展示 (nz-spin 加载状态)
  - 扫码状态提示
  - 刷新二维码按钮
  - 倒计时显示（二维码有效期）
- Cookie 信息展示区域
  - 当前 Cookie 状态（有效/失效）
  - 登录账号信息
  - Cookie 创建时间
  - Cookie 过期时间
  - Cookie 详细信息（可折叠）
- 操作按钮
  - 重新获取 Cookie
  - 验证 Cookie 有效性
  - 删除 Cookie
  - 查看 Cookie 详情

### 3. 爬虫管理组件

#### 3.1 CrawlerTaskList (任务列表)
- 任务表格 (nz-table)
- 状态筛选
- 搜索功能
- 批量操作

#### 3.2 CrawlerTaskForm (任务表单)
- 创建/编辑任务表单 (nz-form)
- 任务类型选择 (URL/关键词/批量)
- 配置选项

#### 3.3 CrawlerTaskDetail (任务详情)
- 任务基本信息
- 执行历史
- 错误日志
- 操作按钮（启动/停止/重试）

#### 3.4 DataSourceConfig (数据源配置)
- 微博配置表单
- Cookie 管理
- 测试连接按钮

### 4. 数据管理组件

#### 4.1 SentimentDataList (舆情数据列表)
- 数据表格 (nz-table + 分页)
- 高级筛选 (nz-form)
- 批量操作
- 导出功能

#### 4.2 SentimentDataDetail (数据详情)
- 详情抽屉 (nz-drawer)
- 数据编辑表单
- 删除确认

#### 4.3 AlertRecordList (预警记录列表)
- 预警记录表格
- 状态筛选
- 查看详情

### 5. 系统配置组件

#### 5.1 SentimentAnalysisConfig (情感分析配置)
- Provider 选择 (nz-radio-group)
- API Key 配置
- 参数调整
- 测试功能

#### 5.2 CleaningRuleList (清洗规则列表)
- 规则列表表格
- 规则启用/禁用开关
- 规则测试

#### 5.3 CleaningRuleForm (清洗规则表单)
- 规则名称
- 规则类型
- 正则表达式
- 优先级

#### 5.4 AlertRuleList (预警规则列表)
- 规则表格
- 规则状态
- 规则测试

#### 5.5 AlertRuleForm (预警规则表单)
- 规则名称
- 关键词配置
- 触发条件
- 通知方式

### 6. 系统监控组件

#### 6.1 SystemDashboard (系统监控面板)
- 统计卡片 (nz-card)
- 状态指示器
- 实时数据图表 (ngx-echarts)
- 快捷操作

#### 6.2 CrawlerStatusPanel (爬虫状态面板)
- 运行中的任务
- 任务队列状态
- 错误统计

#### 6.3 DataProcessingPanel (数据处理面板)
- 处理进度
- 成功/失败统计
- 处理速率

#### 6.4 SystemStatusPanel (系统状态面板)
- 数据库状态
- Redis 状态
- RabbitMQ 状态
- 错误日志

### 7. 大屏管理组件

#### 7.1 ScreenPageList (页面列表)
- 页面表格
- 预览按钮
- 编辑/删除按钮

### 8. 公共组件

#### 8.1 SearchForm (搜索表单)
- 通用搜索组件
- 支持多种筛选条件

#### 8.2 ConfirmModal (确认对话框)
- 统一的确认弹窗

#### 8.3 StatusBadge (状态标签)
- 任务状态显示
- 数据处理状态显示

## 项目结构 (Angular)
```
apps/admin/
├── src/
│   ├── app/
│   │   ├── core/                    # 核心模块
│   │   │   ├── services/           # 核心服务
│   │   │   │   ├── auth.service.ts      # 简单鉴权
│   │   │   │   ├── api.service.ts       # API 封装
│   │   │   │   └── notification.service.ts  # 通知服务
│   │   │   ├── interceptors/       # 拦截器
│   │   │   │   ├── auth.interceptor.ts
│   │   │   │   └── error.interceptor.ts
│   │   │   └── guards/             # 路由守卫
│   │   │       └── auth.guard.ts
│   │   │
│   │   ├── shared/                 # 共享模块
│   │   │   ├── components/        # 共享组件
│   │   │   │   ├── search-form/
│   │   │   │   ├── confirm-modal/
│   │   │   │   └── status-badge/
│   │   │   ├── pipes/             # 管道
│   │   │   └── directives/        # 指令
│   │   │
│   │   ├── layout/                # 布局模块
│   │   │   ├── admin-layout/
│   │   │   ├── admin-header/
│   │   │   └── admin-sider/
│   │   │
│   │   ├── pages/                 # 页面模块
│   │   │   ├── login/            # 登录页
│   │   │   ├── dashboard/        # 系统监控
│   │   │   ├── weibo-cookie/    # 微博 Cookie 管理 **【第一期核心】**
│   │   │   ├── crawler/          # 爬虫管理
│   │   │   │   ├── task-list/
│   │   │   │   ├── task-detail/
│   │   │   │   └── data-source/
│   │   │   ├── data/             # 数据管理
│   │   │   │   ├── sentiment-list/
│   │   │   │   └── alert-record/
│   │   │   ├── config/           # 系统配置
│   │   │   │   ├── sentiment-analysis/
│   │   │   │   ├── cleaning-rule/
│   │   │   │   └── alert-rule/
│   │   │   └── screen/           # 大屏管理
│   │   │       └── page-list/
│   │   │
│   │   ├── models/               # 数据模型
│   │   │   ├── crawler.model.ts
│   │   │   ├── sentiment.model.ts
│   │   │   ├── alert.model.ts
│   │   │   └── config.model.ts
│   │   │
│   │   ├── app.component.ts
│   │   ├── app.config.ts
│   │   └── app.routes.ts
│   │
│   ├── assets/                   # 静态资源
│   ├── styles/                   # 全局样式
│   │   ├── styles.scss          # 主样式文件
│   │   └── variables.scss       # SCSS 变量
│   │
│   ├── environments/            # 环境配置
│   │   ├── environment.ts
│   │   └── environment.prod.ts
│   │
│   ├── index.html
│   └── main.ts
│
├── package.json
├── angular.json
└── tsconfig.json
```

## 路由结构
```typescript
const routes: Routes = [
  {
    path: 'login',
    component: LoginComponent
  },
  {
    path: '',
    component: AdminLayoutComponent,
    canActivate: [AuthGuard],
    children: [
      {
        path: 'dashboard',
        component: DashboardComponent
      },
      {
        path: 'weibo-cookie',
        component: WeiboCookieManagerComponent  // **【第一期核心】**
      },
      {
        path: 'crawler',
        children: [
          { path: 'tasks', component: CrawlerTaskListComponent },
          { path: 'tasks/:id', component: CrawlerTaskDetailComponent },
          { path: 'data-source', component: DataSourceConfigComponent }
        ]
      },
      {
        path: 'data',
        children: [
          { path: 'sentiment', component: SentimentDataListComponent },
          { path: 'alert', component: AlertRecordListComponent }
        ]
      },
      {
        path: 'config',
        children: [
          { path: 'sentiment-analysis', component: SentimentAnalysisConfigComponent },
          { path: 'cleaning-rule', component: CleaningRuleListComponent },
          { path: 'alert-rule', component: AlertRuleListComponent }
        ]
      },
      {
        path: 'screen',
        children: [
          { path: 'pages', component: ScreenPageListComponent }
        ]
      },
      {
        path: '',
        redirectTo: 'dashboard',
        pathMatch: 'full'
      }
    ]
  }
];
```

## 后端 API 需求（需要 apps/api 支持）

### 0. 用户鉴权 API **【新增】**

#### 用户表设计
```sql
CREATE TABLE admin_users (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  username VARCHAR(50) UNIQUE NOT NULL,
  password_hash VARCHAR(255) NOT NULL,    -- bcrypt 加密后的密码
  email VARCHAR(100),
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  last_login_at TIMESTAMP
);

-- 创建默认管理员（密码: admin123）
INSERT INTO admin_users (username, password_hash)
VALUES ('admin', '$2b$10$...');  -- bcrypt hash of 'admin123'
```

#### 鉴权接口
```typescript
// 登录
POST /api/admin/auth/login
Body: { username: string, password: string }
Response: {
  success: boolean,
  token: string,        // JWT token
  user: {
    id: string,
    username: string,
    email: string
  }
}

// 验证 Token
GET /api/admin/auth/verify
Headers: { Authorization: 'Bearer <token>' }
Response: {
  valid: boolean,
  user: {
    id: string,
    username: string
  }
}

// 修改密码
POST /api/admin/auth/change-password
Headers: { Authorization: 'Bearer <token>' }
Body: { oldPassword: string, newPassword: string }
Response: { success: boolean }

// 登出（可选，前端删除 token 即可）
POST /api/admin/auth/logout
Headers: { Authorization: 'Bearer <token>' }
Response: { success: boolean }
```

### 1. 微博 Cookie 管理 API **【第一期核心】**🎯

#### Cookie 数据表设计
```sql
CREATE TABLE weibo_cookies (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  cookies TEXT NOT NULL,                  -- JSON 格式存储 Cookie 数组
  user_info JSONB,                        -- 微博用户信息（昵称、UID等）
  status VARCHAR(20) DEFAULT 'active',    -- active | expired | invalid
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  expires_at TIMESTAMP,                   -- Cookie 预计过期时间
  last_validated_at TIMESTAMP             -- 最后验证时间
);
```

#### Cookie 管理接口
```typescript
// 启动微博扫码登录（生成二维码）
POST /api/admin/weibo/cookie/start-login
Response: {
  sessionId: string,        // 登录会话ID
  qrCodeUrl: string,        // 二维码图片 URL（base64 或图片链接）
  expiresIn: number,        // 二维码有效期（秒）
  status: 'pending'         // pending | scanned | confirmed | expired
}

// 轮询扫码状态
GET /api/admin/weibo/cookie/login-status/:sessionId
Response: {
  status: 'pending' | 'scanned' | 'confirmed' | 'expired' | 'failed',
  message?: string,
  cookieId?: string         // 登录成功后返回 Cookie ID
}

// 获取当前 Cookie 信息
GET /api/admin/weibo/cookie/current
Response: {
  id: string,
  userInfo: {
    nickname: string,
    uid: string,
    avatarUrl?: string
  },
  status: 'active' | 'expired' | 'invalid',
  createdAt: string,
  expiresAt: string,
  lastValidatedAt: string
}

// 验证 Cookie 有效性
POST /api/admin/weibo/cookie/validate
Response: {
  valid: boolean,
  message: string,
  userInfo?: any
}

// 删除 Cookie
DELETE /api/admin/weibo/cookie/:id
Response: { success: boolean }

// 获取 Cookie 详情
GET /api/admin/weibo/cookie/:id
Response: {
  id: string,
  cookies: Cookie[],        // Cookie 数组
  userInfo: any,
  status: string,
  createdAt: string,
  expiresAt: string
}
```

#### Cookie 获取流程说明
```
前端调用 start-login
  ↓
后端使用 Playwright 启动浏览器，打开微博登录页
  ↓
后端生成二维码并返回给前端（base64 图片）
  ↓
前端轮询 login-status 接口（每 2 秒）
  ↓
用户扫码 → 后端检测到登录成功
  ↓
后端提取 Cookie 并保存到数据库
  ↓
返回 status: 'confirmed' 和 cookieId
  ↓
前端显示登录成功，展示 Cookie 信息
```

### 2. 爬虫管理 API

#### 任务管理
```typescript
// 获取任务列表
GET /api/admin/crawler/tasks
Query: { page, pageSize, status?, keyword? }
Response: { total, items: CrawlTask[] }

// 获取任务详情
GET /api/admin/crawler/tasks/:id
Response: CrawlTask

// 创建任务
POST /api/admin/crawler/tasks
Body: { taskType, config }
Response: CrawlTask

// 更新任务
PUT /api/admin/crawler/tasks/:id
Body: Partial<CrawlTask>
Response: CrawlTask

// 删除任务
DELETE /api/admin/crawler/tasks/:id
Response: { success: boolean }

// 启动任务
POST /api/admin/crawler/tasks/:id/start
Response: { success: boolean }

// 停止任务
POST /api/admin/crawler/tasks/:id/stop
Response: { success: boolean }

// 重试任务
POST /api/admin/crawler/tasks/:id/retry
Response: { success: boolean }

// 获取任务执行历史
GET /api/admin/crawler/tasks/:id/history
Query: { page, pageSize }
Response: { total, items: TaskHistory[] }
```

#### 数据源配置
```typescript
// 获取数据源配置
GET /api/admin/crawler/data-source
Response: DataSourceConfig

// 更新数据源配置
PUT /api/admin/crawler/data-source
Body: DataSourceConfig
Response: DataSourceConfig

// 测试数据源连接
POST /api/admin/crawler/data-source/test
Response: { success: boolean, message: string }
```

### 3. 数据管理 API

#### 舆情数据
```typescript
// 获取舆情数据列表
GET /api/admin/data/sentiment
Query: { page, pageSize, sentiment?, source?, keyword?, startTime?, endTime? }
Response: { total, items: SentimentNews[] }

// 获取单条数据
GET /api/admin/data/sentiment/:id
Response: SentimentNews

// 更新数据
PUT /api/admin/data/sentiment/:id
Body: Partial<SentimentNews>
Response: SentimentNews

// 删除数据
DELETE /api/admin/data/sentiment/:id
Response: { success: boolean }

// 批量删除
POST /api/admin/data/sentiment/batch-delete
Body: { ids: string[] }
Response: { success: boolean, deletedCount: number }

// 导出数据
POST /api/admin/data/sentiment/export
Body: { filters: any }
Response: { downloadUrl: string }
```

#### 预警记录
```typescript
// 获取预警记录
GET /api/admin/data/alerts
Query: { page, pageSize, severity?, isResolved? }
Response: { total, items: Alert[] }

// 标记预警已解决
POST /api/admin/data/alerts/:id/resolve
Response: { success: boolean }
```

### 4. 系统配置 API

#### 情感分析配置
```typescript
// 获取情感分析配置
GET /api/admin/config/sentiment-analysis
Response: SentimentAnalysisConfig

// 更新配置
PUT /api/admin/config/sentiment-analysis
Body: SentimentAnalysisConfig
Response: SentimentAnalysisConfig

// 切换 Provider
POST /api/admin/config/sentiment-analysis/provider
Body: { provider: string }
Response: { success: boolean }

// 测试情感分析
POST /api/admin/config/sentiment-analysis/test
Body: { text: string }
Response: SentimentAnalysisResult
```

#### 数据清洗规则
```typescript
// 获取清洗规则列表
GET /api/admin/config/cleaning-rules
Response: CleaningRule[]

// 创建规则
POST /api/admin/config/cleaning-rules
Body: CleaningRule
Response: CleaningRule

// 更新规则
PUT /api/admin/config/cleaning-rules/:id
Body: Partial<CleaningRule>
Response: CleaningRule

// 删除规则
DELETE /api/admin/config/cleaning-rules/:id
Response: { success: boolean }

// 测试规则
POST /api/admin/config/cleaning-rules/:id/test
Body: { testData: string }
Response: { result: string }
```

#### 预警规则配置
```typescript
// 获取预警规则列表
GET /api/admin/config/alert-rules
Response: AlertRule[]

// 创建规则
POST /api/admin/config/alert-rules
Body: AlertRule
Response: AlertRule

// 更新规则
PUT /api/admin/config/alert-rules/:id
Body: Partial<AlertRule>
Response: AlertRule

// 删除规则
DELETE /api/admin/config/alert-rules/:id
Response: { success: boolean }

// 启用/禁用规则
POST /api/admin/config/alert-rules/:id/toggle
Body: { enabled: boolean }
Response: { success: boolean }

// 测试规则
POST /api/admin/config/alert-rules/:id/test
Body: { testData: any }
Response: { triggered: boolean, result: any }
```

### 5. 系统监控 API

```typescript
// 获取系统状态
GET /api/admin/monitor/status
Response: {
  crawler: { running: number, pending: number, failed: number },
  dataProcessing: { total: number, processed: number, failed: number },
  system: {
    database: { status: string },
    redis: { status: string },
    rabbitmq: { status: string }
  }
}

// 获取错误日志
GET /api/admin/monitor/errors
Query: { page, pageSize, level? }
Response: { total, items: ErrorLog[] }

// 获取数据统计
GET /api/admin/monitor/statistics
Response: {
  todayNewData: number,
  totalData: number,
  sentimentDistribution: any,
  sourceDistribution: any
}
```


## 数据模型

### 用户模型 **【新增】**
```typescript
export interface AdminUser {
  id: string;
  username: string;
  email?: string;
  createdAt: Date;
  updatedAt: Date;
  lastLoginAt?: Date;
}

export interface LoginRequest {
  username: string;
  password: string;
}

export interface LoginResponse {
  success: boolean;
  token: string;
  user: AdminUser;
}
```

### 微博 Cookie 模型 **【第一期核心】**
```typescript
export interface WeiboCookie {
  id: string;
  cookies: Array<{
    name: string;
    value: string;
    domain: string;
    path: string;
    expires?: number;
    httpOnly?: boolean;
    secure?: boolean;
  }>;
  userInfo?: {
    nickname: string;
    uid: string;
    avatarUrl?: string;
  };
  status: 'active' | 'expired' | 'invalid';
  createdAt: Date;
  updatedAt: Date;
  expiresAt?: Date;
  lastValidatedAt?: Date;
}

export interface WeiboLoginSession {
  sessionId: string;
  qrCodeUrl: string;          // base64 图片或图片链接
  expiresIn: number;          // 秒
  status: 'pending' | 'scanned' | 'confirmed' | 'expired' | 'failed';
}

export interface WeiboLoginStatus {
  status: 'pending' | 'scanned' | 'confirmed' | 'expired' | 'failed';
  message?: string;
  cookieId?: string;
}
```

### 爬虫任务模型
```typescript
export interface CrawlTask {
  id: string;
  taskType: 'url' | 'keyword' | 'batch';
  status: 'pending' | 'running' | 'completed' | 'failed';
  priority: number;
  config: {
    urls?: string[];
    keywords?: string[];
    maxPages?: number;
    depth?: number;
    rateLimit?: number;
  };
  result?: {
    totalUrls: number;
    successCount: number;
    failedCount: number;
    startTime?: Date;
    endTime?: Date;
    duration?: number;
  };
  createdAt: Date;
  updatedAt: Date;
}

export interface TaskHistory {
  id: string;
  taskId: string;
  status: string;
  result: any;
  error?: string;
  startTime: Date;
  endTime?: Date;
}
```

### 数据源配置模型
```typescript
export interface DataSourceConfig {
  weibo: {
    enabled: boolean;
    cookies?: string;
    userAgent: string;
    requestDelay: number;
    maxRetries: number;
    useProxy: boolean;
  };
}
```

### 清洗规则模型
```typescript
export interface CleaningRule {
  id: string;
  name: string;
  type: 'deduplication' | 'filter' | 'format' | 'extract';
  enabled: boolean;
  priority: number;
  config: {
    regex?: string;
    replacement?: string;
    threshold?: number;
  };
  description?: string;
  createdAt: Date;
  updatedAt: Date;
}
```

### 预警规则模型
```typescript
export interface AlertRule {
  id: string;
  name: string;
  enabled: boolean;
  conditions: {
    keywords?: string[];
    sentiment?: 'positive' | 'neutral' | 'negative';
    hotValueThreshold?: number;
    sourceFilter?: string[];
  };
  actions: {
    notifyEmail?: boolean;
    notifyWebhook?: boolean;
    createAlert?: boolean;
  };
  createdAt: Date;
  updatedAt: Date;
}
```

## 开发计划（任务拆分与依赖关系）

### 第一期开发计划 🎯（微博 Cookie 管理）

#### 阶段 1: 项目初始化（无依赖，可并行）
- [ ] T1.1 检查现有 Angular 项目配置
- [ ] T1.2 安装 NG-ZORRO 依赖
- [ ] T1.3 配置 NG-ZORRO 模块
- [ ] T1.4 配置 ESLint + Prettier（已有则跳过）
- [ ] T1.5 创建基础目录结构
- [ ] T1.6 配置环境变量文件
- [ ] T1.7 配置路由

**提交点**: 完成基础项目配置

#### 阶段 2: 核心服务搭建（依赖阶段1）
- [ ] T2.1 创建 API 服务（HttpClient 封装）
- [ ] T2.2 创建鉴权服务（AuthService，支持用户名密码登录）
- [ ] T2.3 创建通知服务（NotificationService）
- [ ] T2.4 创建 HTTP 拦截器（JWT 鉴权、错误处理）
- [ ] T2.5 创建路由守卫（AuthGuard）
- [ ] T2.6 定义 TypeScript 模型（User, WeiboCookie 等）

**提交点**: 完成基础设施搭建

#### 阶段 3: 布局和登录（依赖阶段2）
- [ ] T3.1 开发 AdminLayout 组件（左侧导航+顶部栏+内容区）
- [ ] T3.2 开发 AdminHeader 组件
- [ ] T3.3 开发 AdminSider 组件（导航菜单）
- [ ] T3.4 开发登录页面（LoginComponent，用户名+密码）
- [ ] T3.5 实现鉴权逻辑（JWT Token）

**提交点**: 完成布局框架和登录功能

#### 阶段 4: 微博 Cookie 管理页面 **【第一期核心】** 🎯（依赖阶段3）
- [ ] T4.1 开发 WeiboCookieManager 组件
- [ ] T4.2 实现启动扫码登录功能
  - 调用后端 start-login 接口
  - 显示二维码（base64 图片）
  - 显示倒计时
- [ ] T4.3 实现扫码状态轮询
  - 每 2 秒轮询 login-status 接口
  - 实时更新状态提示
  - 扫码成功后停止轮询
- [ ] T4.4 实现 Cookie 信息展示
  - 显示登录账号信息
  - 显示 Cookie 状态
  - 显示创建/过期时间
- [ ] T4.5 实现 Cookie 操作功能
  - 验证 Cookie 有效性
  - 重新获取 Cookie
  - 删除 Cookie
  - 查看 Cookie 详情（折叠面板）
- [ ] T4.6 实现错误处理和提示
- [ ] T4.7 实现页面样式优化

**提交点**: 完成微博 Cookie 管理功能 ✅

#### 阶段 5: 后端 API 开发 **【并行开发】** 🎯（依赖 apps/api）
- [ ] T5.1 创建 admin_users 表和默认管理员
- [ ] T5.2 实现用户鉴权 API（登录、验证、修改密码）
- [ ] T5.3 创建 weibo_cookies 表
- [ ] T5.4 实现微博扫码登录功能
  - 使用 Playwright 启动浏览器
  - 生成二维码（截图或提取图片）
  - 监控登录状态
  - 提取 Cookie
- [ ] T5.5 实现 Cookie 管理 API
  - Cookie 保存到数据库
  - Cookie 验证
  - Cookie 查询
  - Cookie 删除
- [ ] T5.6 实现 WebSocket 实时推送（可选，用于推送扫码状态）

**提交点**: 完成后端 Cookie 管理功能 ✅

### 第二期开发计划（其他功能）

#### 阶段 6: 系统监控页面（依赖阶段3）
- [ ] T6.1 开发 SystemDashboard 组件
- [ ] T6.2 开发 CrawlerStatusPanel 组件
- [ ] T6.3 开发 DataProcessingPanel 组件
- [ ] T6.4 开发 SystemStatusPanel 组件
- [ ] T6.5 集成 ngx-echarts（统计图表）
- [ ] T6.6 实现数据刷新功能

**提交点**: 完成系统监控页面

#### 阶段 7A: 爬虫管理模块（依赖阶段3，可并行）
- [ ] T7A.1 开发 CrawlerTaskList 组件
- [ ] T7A.2 开发 CrawlerTaskForm 组件
- [ ] T7A.3 开发 CrawlerTaskDetail 组件
- [ ] T7A.4 实现任务 CRUD 功能
- [ ] T7A.5 实现任务启动/停止功能
- [ ] T7A.6 开发 DataSourceConfig 组件
- [ ] T7A.7 实现数据源配置功能

**提交点**: 完成爬虫管理模块

#### 阶段 7B: 数据管理模块（依赖阶段3，可并行）
- [ ] T7B.1 开发 SentimentDataList 组件
- [ ] T7B.2 开发 SentimentDataDetail 组件
- [ ] T7B.3 实现数据筛选和搜索
- [ ] T7B.4 实现数据编辑功能
- [ ] T7B.5 实现批量删除功能
- [ ] T7B.6 实现数据导出功能
- [ ] T7B.7 开发 AlertRecordList 组件

**提交点**: 完成数据管理模块

#### 阶段 7C: 系统配置模块（依赖阶段3，可并行）
- [ ] T7C.1 开发 SentimentAnalysisConfig 组件
- [ ] T7C.2 实现 Provider 切换功能
- [ ] T7C.3 实现 API Key 配置功能
- [ ] T7C.4 开发 CleaningRuleList 组件
- [ ] T7C.5 开发 CleaningRuleForm 组件
- [ ] T7C.6 实现规则 CRUD 功能
- [ ] T7C.7 开发 AlertRuleList 组件
- [ ] T7C.8 开发 AlertRuleForm 组件
- [ ] T7C.9 实现预警规则 CRUD 功能

**提交点**: 完成系统配置模块

#### 阶段 7D: 大屏管理模块（依赖阶段3，可并行）
- [ ] T7D.1 开发 ScreenPageList 组件
- [ ] T7D.2 实现页面列表展示
- [ ] T7D.3 实现页面预览功能（跳转到 web 应用）
- [ ] T7D.4 实现页面删除功能

**提交点**: 完成大屏管理模块

#### 阶段 8: 共享组件开发（依赖阶段3，可与阶段7并行）
- [ ] T8.1 开发 SearchForm 组件
- [ ] T8.2 开发 ConfirmModal 组件
- [ ] T8.3 开发 StatusBadge 组件
- [ ] T8.4 开发通用 Pipes
- [ ] T8.5 开发通用 Directives

**提交点**: 完成共享组件

#### 阶段 9: 优化与测试（依赖所有阶段）
- [ ] T9.1 性能优化（OnPush 策略）
- [ ] T9.2 代码重构和优化
- [ ] T9.3 单元测试（可选）
- [ ] T9.4 E2E 测试（可选）
- [ ] T9.5 响应速度优化
- [ ] T9.6 构建优化和打包

**提交点**: 完成测试优化

### 执行顺序总结

#### 第一期（微博 Cookie 管理）🎯
```
阶段1（项目初始化） → 阶段2（核心服务） → 阶段3（布局+登录） →
阶段4（微博 Cookie 管理页面）
  ∥
阶段5（后端 API 开发，并行）
```

**第一期完成标志**:
- ✅ 管理员可以登录后台
- ✅ 可以通过扫码获取微博 Cookie
- ✅ Cookie 自动保存到数据库
- ✅ 可以查看和验证 Cookie 状态

#### 第二期（其他功能）
```
阶段6（系统监控） | 阶段7A（爬虫管理） | 阶段7B（数据管理） |
阶段7C（系统配置） | 阶段7D（大屏管理） | 阶段8（共享组件）
  ↓
阶段9（优化与测试）
```

**注意**:
- 第一期专注于微博 Cookie 获取功能，这是后续所有爬虫任务的基础
- 第二期功能可以根据实际需求调整优先级

## 依赖安装

### NPM 包
```bash
# NG-ZORRO
pnpm add ng-zorro-antd

# 图表库（系统监控页面，第二期）
pnpm add ngx-echarts echarts

# 日期处理
pnpm add date-fns

# Excel 导出（可选，也可后端实现，第二期）
pnpm add xlsx
pnpm add @types/xlsx -D

# 工具库
pnpm add lodash-es
pnpm add @types/lodash-es -D

# JWT 解码（可选，用于解析 JWT Token）
pnpm add jwt-decode
```

### 后端依赖（apps/api）
```bash
# JWT 鉴权
pnpm add @nestjs/jwt @nestjs/passport passport passport-jwt
pnpm add @types/passport-jwt -D

# 密码加密
pnpm add bcrypt
pnpm add @types/bcrypt -D

# Playwright（微博扫码登录）
pnpm add playwright
npx playwright install chromium
```

### angular.json 配置
```json
{
  "styles": [
    "node_modules/ng-zorro-antd/ng-zorro-antd.min.css",
    "src/styles.scss"
  ]
}
```

## 鉴权方案（基于用户表 + JWT）

### 实现方式
```typescript
// auth.service.ts
@Injectable({ providedIn: 'root' })
export class AuthService {
  private readonly TOKEN_KEY = 'admin_token';
  private readonly USER_KEY = 'admin_user';

  constructor(private http: HttpClient) {}

  // 登录
  login(username: string, password: string): Observable<LoginResponse> {
    return this.http.post<LoginResponse>('/api/admin/auth/login', {
      username,
      password
    }).pipe(
      tap(response => {
        if (response.success) {
          localStorage.setItem(this.TOKEN_KEY, response.token);
          localStorage.setItem(this.USER_KEY, JSON.stringify(response.user));
        }
      })
    );
  }

  // 登出
  logout(): void {
    localStorage.removeItem(this.TOKEN_KEY);
    localStorage.removeItem(this.USER_KEY);
  }

  // 是否已登录
  isAuthenticated(): boolean {
    return !!this.getToken();
  }

  // 获取 Token
  getToken(): string | null {
    return localStorage.getItem(this.TOKEN_KEY);
  }

  // 获取当前用户
  getCurrentUser(): AdminUser | null {
    const userStr = localStorage.getItem(this.USER_KEY);
    return userStr ? JSON.parse(userStr) : null;
  }

  // 修改密码
  changePassword(oldPassword: string, newPassword: string): Observable<any> {
    return this.http.post('/api/admin/auth/change-password', {
      oldPassword,
      newPassword
    });
  }
}
```

### HTTP 拦截器（添加 JWT Token）
```typescript
// auth.interceptor.ts
export const authInterceptor: HttpInterceptorFn = (req, next) => {
  const authService = inject(AuthService);
  const token = authService.getToken();

  if (token) {
    req = req.clone({
      setHeaders: {
        Authorization: `Bearer ${token}`
      }
    });
  }

  return next(req);
};
```

### 路由守卫
```typescript
// auth.guard.ts
export const authGuard: CanActivateFn = (route, state) => {
  const authService = inject(AuthService);
  const router = inject(Router);

  if (authService.isAuthenticated()) {
    return true;
  }

  router.navigate(['/login'], { queryParams: { returnUrl: state.url } });
  return false;
};
```

### 登录组件示例
```typescript
// login.component.ts
@Component({
  selector: 'app-login',
  templateUrl: './login.component.html'
})
export class LoginComponent {
  loginForm = new FormGroup({
    username: new FormControl('', [Validators.required]),
    password: new FormControl('', [Validators.required])
  });

  constructor(
    private authService: AuthService,
    private router: Router,
    private message: NzMessageService
  ) {}

  onSubmit(): void {
    if (this.loginForm.valid) {
      const { username, password } = this.loginForm.value;
      this.authService.login(username!, password!).subscribe({
        next: (response) => {
          if (response.success) {
            this.message.success('登录成功');
            this.router.navigate(['/dashboard']);
          } else {
            this.message.error('登录失败');
          }
        },
        error: (err) => {
          this.message.error('用户名或密码错误');
        }
      });
    }
  }
}
```

## UI 设计风格

### 配色方案
- 主色: Ant Design 默认蓝色 (#1890ff)
- 成功: #52c41a
- 警告: #faad14
- 危险: #f5222d
- 信息: #1890ff

### 布局尺寸
- 侧边栏宽度: 200px（展开），80px（折叠）
- 顶部栏高度: 64px
- 内容区域内边距: 24px

### 表格配置
- 分页大小: 10, 20, 50, 100
- 默认分页: 20
- 表格尺寸: middle

## 后续扩展（可选）

### V2 版本功能
- [ ] 多管理员账号支持
- [ ] 角色权限管理
- [ ] 操作日志记录
- [ ] 数据统计报表
- [ ] 定时任务管理
- [ ] 系统设置（SMTP 配置、Webhook 配置等）
- [ ] 数据标注功能
- [ ] 情感模型训练（集成自定义模型）

---

*创建时间: 2025-10-08*
*最后更新: 2025-10-08*
