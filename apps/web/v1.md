# 舆情大屏幕系统 V1 版本规划

## 概述
舆情大屏幕系统，用于实时展示舆情数据监控、分析和可视化，支持多维度数据展示和实时更新。

## 技术栈（已确认）
- 前端框架: Angular 17+ + TypeScript
- 状态管理: RxJS + Angular Services
- 可视化库: ECharts (ngx-echarts)
- 拖拽布局: angular-gridster2
- UI 组件库: NG-ZORRO (Ant Design for Angular) + 自定义大屏组件
- 构建工具: Angular CLI
- 实时通信: WebSocket (RxJS WebSocketSubject)
- 数据请求: HttpClient (Angular 内置)
- CSS 方案: Tailwind CSS
- 动画库: Angular Animations
- 导出功能: html2canvas + jspdf (PDF), xlsx (Excel)
- 时间轴播放: 自定义时间轴组件

## 需求确认
1. ✅ 不需要国际化支持
2. ✅ 使用 WebSocket 实时更新数据
3. ✅ 不需要主题切换（固定深色科技风格）
4. ✅ 支持超大屏幕自定义布局（1920x1080 / 4K / 超宽屏等）
5. ✅ 需要历史数据回放功能
6. ✅ 需要导出报告功能（PDF/Excel/图片）
7. ✅ 不需要用户权限控制
8. ⏳ 后端 API 接口格式（待后端确定，前期使用 Mock 数据）
9. ✅ **所见即所得的大屏编辑器**（拖拽布局 + 实时预览 + 保存到数据库）
10. ✅ **业务组件开箱即用**（组件已对接后端数据，无需额外配置）
11. ✅ **多页面管理**（创建、编辑、切换、删除页面）

## 组件拆分

### 1. 布局组件 (Layout Components)

#### 1.1 ScreenLayout (大屏主布局)
- 功能: 整体页面布局框架
- 包含: 头部、左中右三栏、底部
- 响应式适配: 支持不同分辨率大屏

#### 1.2 Header (顶部栏)
- 系统标题
- 当前时间显示
- 天气信息
- 系统状态指示器

#### 1.3 DataPanel (数据面板容器)
- 功能: 统一的数据卡片容器
- 支持标题、图标、边框动效
- 可配置大小和样式

### 2. 数据可视化组件 (Visualization Components)

#### 2.1 StatisticsCard (统计卡片)
- 显示关键指标数字
- 支持趋势箭头、百分比变化
- 动画数字滚动效果

#### 2.2 TrendChart (趋势图表)
- 折线图展示数据趋势
- 支持多条数据对比
- 时间轴切换 (小时/天/周/月)

#### 2.3 PieChart (饼图/环图)
- 舆情分类占比
- 情感分析分布
- 支持点击交互

#### 2.4 BarChart (柱状图)
- 热点话题 TOP N
- 媒体来源分布
- 地区分布排名

#### 2.5 MapChart (地图可视化)
- 地理位置热力图
- 区域舆情分布
- 支持省市级下钻

#### 2.6 WordCloud (词云图)
- 热词分布
- 关键词提取展示
- 支持点击过滤

#### 2.7 TimelineFlow (时间轴流)
- 舆情事件时间线
- 重大事件标注
- 支持滚动和缩放

#### 2.8 RankingList (排行榜)
- 热点事件排行
- 媒体活跃度排行
- 支持实时更新动画

### 3. 数据展示组件 (Data Display Components)

#### 3.1 NewsCard (新闻卡片)
- 单条舆情信息展示
- 包含标题、来源、时间、情感标签
- 支持点击查看详情

#### 3.2 ScrollList (滚动列表)
- 实时舆情流
- 自动滚动播放
- 支持暂停和手动滚动

#### 3.3 AlertPanel (预警面板)
- 负面舆情预警
- 敏感信息提示
- 分级预警展示

#### 3.4 SentimentMeter (情感仪表盘)
- 整体情感倾向
- 正面/中性/负面占比
- 仪表盘动画效果

### 4. 交互控制组件 (Control Components)

#### 4.1 FilterBar (筛选栏)
- 时间范围选择
- 数据源筛选
- 关键词搜索
- 情感类型过滤

#### 4.2 DateRangePicker (时间选择器)
- 快捷时间选择
- 自定义时间范围
- 适配大屏样式

#### 4.3 ScreenController (大屏控制器)
- 全屏切换
- 自动轮播控制
- 刷新频率设置
- 布局编辑模式切换
- 导出报告按钮

#### 4.4 PageEditor (页面编辑器) **【核心功能】**
- **编辑模式/预览模式切换**
- **左侧组件库面板**（展示所有可用业务组件）
- **中央画布区域**（所见即所得的拖拽布局）
- **右侧属性面板**（组件尺寸、位置微调）
- **顶部工具栏**（保存、预览、返回、屏幕尺寸切换）
- 组件拖拽（从组件库拖入画布）
- 组件移动、缩放、删除
- 网格吸附功能
- 实时预览（预览模式显示真实数据）
- 保存到后端数据库

#### 4.5 PageManager (页面管理器) **【新增】**
- 页面列表展示
- 创建新页面
- 编辑现有页面
- 删除页面
- 复制页面
- 页面切换
- 设置默认页面

#### 4.6 ComponentLibrary (组件库面板) **【新增】**
- 展示所有可用业务组件
- 组件分类（可视化、展示、控制等）
- 组件搜索
- 组件预览缩略图
- 拖拽到画布功能

#### 4.7 PropertyPanel (属性面板) **【新增】**
- 选中组件的属性编辑
- 位置调整（X, Y 坐标）
- 尺寸调整（宽度、高度）
- 层级调整（置顶、置底）
- 删除组件按钮

#### 4.8 HistoryPlayer (历史回放控制器)
- 时间轴拖动
- 播放/暂停控制
- 播放速度调节
- 时间点标记
- 关键事件快速跳转

#### 4.9 ExportPanel (导出面板)
- 导出为 PDF 报告
- 导出为 Excel 数据表
- 导出为图片（PNG/JPG）
- 自定义导出内容选择
- 导出进度提示

### 5. 装饰组件 (Decoration Components)

#### 5.1 BorderBox (边框装饰)
- 科技感边框
- 多种样式可选
- 支持动画效果

#### 5.2 BackgroundDecoration (背景装饰)
- 粒子背景
- 网格线
- 渐变背景

#### 5.3 LoadingAnimation (加载动画)
- 数据加载状态
- 大屏风格动画
- 骨架屏

## 项目结构 (Angular)
```
apps/web/
├── src/
│   ├── app/
│   │   ├── components/           # 组件目录
│   │   │   ├── layout/          # 布局组件
│   │   │   │   ├── screen-layout/
│   │   │   │   ├── header/
│   │   │   │   └── data-panel/
│   │   │   ├── visualization/   # 数据可视化组件
│   │   │   │   ├── statistics-card/
│   │   │   │   ├── trend-chart/
│   │   │   │   ├── pie-chart/
│   │   │   │   ├── bar-chart/
│   │   │   │   ├── map-chart/
│   │   │   │   ├── word-cloud/
│   │   │   │   ├── timeline-flow/
│   │   │   │   └── ranking-list/
│   │   │   ├── display/         # 数据展示组件
│   │   │   │   ├── news-card/
│   │   │   │   ├── scroll-list/
│   │   │   │   ├── alert-panel/
│   │   │   │   └── sentiment-meter/
│   │   │   ├── control/         # 交互控制组件
│   │   │   │   ├── filter-bar/
│   │   │   │   ├── date-range-picker/
│   │   │   │   ├── screen-controller/
│   │   │   │   ├── history-player/
│   │   │   │   └── export-panel/
│   │   │   └── editor/          # 编辑器组件 **【新增】**
│   │   │       ├── page-editor/       # 页面编辑器
│   │   │       ├── page-manager/      # 页面管理器
│   │   │       ├── component-library/ # 组件库面板
│   │   │       └── property-panel/    # 属性面板
│   │   │   └── decoration/      # 装饰组件
│   │   │       ├── border-box/
│   │   │       ├── background-decoration/
│   │   │       └── loading-animation/
│   │   ├── pages/               # 页面组件
│   │   │   ├── dashboard/       # 大屏展示页面（预览模式）
│   │   │   ├── editor/          # 页面编辑器页面 **【新增】**
│   │   │   └── page-list/       # 页面管理列表 **【新增】**
│   │   ├── services/            # 服务
│   │   │   ├── api.service.ts           # API 服务
│   │   │   ├── websocket.service.ts     # WebSocket 服务
│   │   │   ├── mock.service.ts          # Mock 数据服务
│   │   │   ├── history.service.ts       # 历史数据服务
│   │   │   ├── export.service.ts        # 导出服务
│   │   │   ├── data-state.service.ts    # 实时数据状态
│   │   │   ├── page.service.ts          # 页面管理服务 **【新增】**
│   │   │   ├── page-state.service.ts    # 页面状态管理 **【新增】**
│   │   │   ├── component-registry.service.ts  # 组件注册表 **【新增】**
│   │   │   └── filter-state.service.ts  # 筛选条件状态
│   │   ├── models/              # 数据模型/接口
│   │   │   ├── data.model.ts      # 数据类型
│   │   │   ├── page.model.ts      # 页面类型 **【新增】**
│   │   │   ├── component.model.ts # 组件类型 **【新增】**
│   │   │   └── api.model.ts       # API 类型
│   │   ├── utils/               # 工具函数
│   │   │   ├── format.util.ts   # 数据格式化
│   │   │   ├── chart.util.ts    # 图表配置
│   │   │   └── export.util.ts   # 导出工具
│   │   ├── constants/           # 常量配置
│   │   ├── pipes/               # 管道
│   │   ├── directives/          # 指令
│   │   ├── guards/              # 路由守卫
│   │   ├── interceptors/        # HTTP 拦截器
│   │   ├── app.component.ts
│   │   ├── app.config.ts
│   │   └── app.routes.ts
│   ├── assets/                  # 静态资源
│   │   ├── images/
│   │   └── fonts/
│   ├── styles/                  # 全局样式
│   │   ├── styles.css           # 主样式文件 (含 Tailwind)
│   │   ├── variables.css        # CSS 变量
│   │   └── theme/               # 主题配置
│   ├── environments/            # 环境配置
│   │   ├── environment.ts
│   │   └── environment.prod.ts
│   ├── index.html
│   └── main.ts
├── public/
├── package.json
├── angular.json
├── tailwind.config.js
└── tsconfig.json
```

## 开发计划（任务拆分与依赖关系）

### 阶段 1: 项目初始化（无依赖，可并行）
- [ ] T1.1 检查现有 Angular 项目配置
- [ ] T1.2 配置 pnpm workspace（如未配置）
- [ ] T1.3 安装核心依赖（ngx-echarts、angular-gridster2、ng-zorro-antd）
- [ ] T1.4 安装导出依赖（html2canvas、jspdf、xlsx）
- [ ] T1.5 配置 Tailwind CSS（安装 + 初始化 + 大屏主题色）
- [ ] T1.6 配置 ESLint + Prettier
- [ ] T1.7 创建基础目录结构（components, services, models 等）
- [ ] T1.8 配置环境变量文件

**提交点**: 完成基础项目配置

### 阶段 2: 基础设施搭建（依赖阶段1）
- [ ] T2.1 创建状态管理服务（data-state, filter-state）
- [ ] T2.2 创建 API 服务（HttpClient 封装）
- [ ] T2.3 实现 WebSocket 服务（RxJS WebSocketSubject）
- [ ] T2.4 创建 Mock 数据服务（模拟后端接口）
- [ ] T2.5 定义 TypeScript 模型（data.model, page.model, component.model, api.model）
- [ ] T2.6 配置 ngx-echarts 模块
- [ ] T2.7 配置 ng-zorro-antd 模块
- [ ] T2.8 实现历史数据服务（history.service.ts）
- [ ] T2.9 实现导出服务（export.service.ts）
- [ ] T2.10 **创建页面管理服务（page.service.ts）**
- [ ] T2.11 **创建页面状态服务（page-state.service.ts）**
- [ ] T2.12 **创建组件注册表服务（component-registry.service.ts）**
- [ ] T2.13 创建 HTTP 拦截器（错误处理、Loading）

**提交点**: 完成基础设施搭建

### 阶段 3: 装饰组件开发（依赖阶段2，可并行）
- [ ] T3.1 开发 border-box 组件（Angular Component）
- [ ] T3.2 开发 background-decoration 组件
- [ ] T3.3 开发 loading-animation 组件

**提交点**: 完成装饰组件

### 阶段 4: 布局组件开发（依赖阶段2和3）
- [ ] T4.1 开发 data-panel 容器组件
- [ ] T4.2 开发 header 组件
- [ ] T4.3 开发 screen-layout 主布局组件

**提交点**: 完成布局框架

### 阶段 5A: 数据可视化组件开发（依赖阶段4，可并行）
- [ ] T5A.1 开发 statistics-card 组件
- [ ] T5A.2 开发 trend-chart 组件（集成 ngx-echarts）
- [ ] T5A.3 开发 pie-chart 组件（集成 ngx-echarts）
- [ ] T5A.4 开发 bar-chart 组件（集成 ngx-echarts）
- [ ] T5A.5 开发 map-chart 组件（集成 ngx-echarts）
- [ ] T5A.6 开发 word-cloud 组件（集成 ngx-echarts）
- [ ] T5A.7 开发 timeline-flow 组件
- [ ] T5A.8 开发 ranking-list 组件

**提交点**: 完成可视化组件

### 阶段 5B: 数据展示组件开发（依赖阶段4，可并行）
- [ ] T5B.1 开发 news-card 组件
- [ ] T5B.2 开发 scroll-list 组件（使用 Angular CDK Virtual Scroll）
- [ ] T5B.3 开发 alert-panel 组件
- [ ] T5B.4 开发 sentiment-meter 组件

**提交点**: 完成展示组件

### 阶段 5C: 交互控制组件开发（依赖阶段4，可并行）
- [ ] T5C.1 开发 filter-bar 组件（集成 ng-zorro）
- [ ] T5C.2 开发 date-range-picker 组件（集成 ng-zorro）
- [ ] T5C.3 开发 screen-controller 组件
- [ ] T5C.4 开发 history-player 组件（历史回放控制）
- [ ] T5C.5 开发 export-panel 组件（导出功能）

**提交点**: 完成控制组件

### 阶段 5D: 页面编辑器组件开发（依赖阶段4，可并行）**【核心】**
- [ ] T5D.1 开发 component-library 组件（组件库面板）
- [ ] T5D.2 开发 property-panel 组件（属性编辑面板）
- [ ] T5D.3 开发 page-editor 组件（核心编辑器，集成 angular-gridster2）
- [ ] T5D.4 实现组件拖拽功能（从组件库拖入画布）
- [ ] T5D.5 实现组件移动、缩放、删除功能
- [ ] T5D.6 实现编辑/预览模式切换
- [ ] T5D.7 开发 page-manager 组件（页面管理器）

**提交点**: 完成编辑器组件

### 阶段 6: 页面集成（依赖阶段5A、5B、5C、5D完成）
- [ ] T6.1 创建 page-list 页面（页面管理列表）
- [ ] T6.2 创建 editor 页面（页面编辑器页面）
- [ ] T6.3 创建 dashboard 页面（大屏展示页面）
- [ ] T6.4 集成所有业务组件到 dashboard
- [ ] T6.5 实现数据流连接（Service 注入 + RxJS 订阅）
- [ ] T6.6 实现 WebSocket 实时更新
- [ ] T6.7 **实现页面保存到后端数据库功能**
- [ ] T6.8 **实现页面加载功能（从数据库读取）**
- [ ] T6.9 **实现页面切换功能**
- [ ] T6.10 实现历史回放功能
- [ ] T6.11 实现导出报告功能
- [ ] T6.12 配置路由（/pages, /editor/:id, /dashboard/:id）

**提交点**: 完成页面集成

### 阶段 7: 优化与测试（依赖阶段6）
- [ ] T7.1 性能优化（OnPush 策略、懒加载模块）
- [ ] T7.2 使用 Angular CDK Virtual Scroll 优化长列表
- [ ] T7.3 优化 Change Detection 策略
- [ ] T7.4 Angular Animations 优化
- [ ] T7.5 历史回放性能优化
- [ ] T7.6 导出功能测试和优化
- [ ] T7.7 单元测试（Jasmine + Karma）
- [ ] T7.8 E2E 测试（可选）
- [ ] T7.9 浏览器兼容性测试
- [ ] T7.10 大屏适配测试（1920x1080, 4K, 超宽屏）
- [ ] T7.11 构建优化和打包

**提交点**: 完成测试优化

### 执行顺序总结
```
阶段1（并行） → 阶段2 → 阶段3（并行） → 阶段4 →
阶段5A、5B、5C、5D（四者并行） → 阶段6 → 阶段7
```

**注意**: 阶段5D（页面编辑器）是核心功能，建议优先开发和测试

## 核心功能详细设计

### 1. 所见即所得的页面编辑器 **【核心】**

#### 功能概述
用户可以通过可视化界面，拖拽组件到画布，调整布局，实时预览效果，保存到数据库。

#### 页面数据模型
```typescript
// page.model.ts
export interface Page {
  id: string;                    // 页面ID
  name: string;                  // 页面名称
  description?: string;          // 页面描述
  screenSize: '1920x1080' | '4K' | 'ultrawide' | 'custom';
  customSize?: { width: number; height: number };
  isDefault: boolean;            // 是否默认页面
  createdAt: Date;
  updatedAt: Date;
  config: PageConfig;            // 页面配置
}

export interface PageConfig {
  grid: {
    columns: number;             // 网格列数
    rows: number;                // 网格行数
  };
  components: ComponentInstance[];  // 页面上的组件实例
}

export interface ComponentInstance {
  id: string;                    // 组件实例ID
  componentType: string;         // 组件类型（如 'statistics-card'）
  position: { x: number; y: number };  // 位置
  size: { w: number; h: number };      // 尺寸
  zIndex?: number;               // 层级
  // 组件无需额外配置，自动从后端获取数据
}
```

#### 组件注册表模型
```typescript
// component.model.ts
export interface ComponentMeta {
  type: string;                  // 组件类型标识
  name: string;                  // 组件显示名称
  category: 'visualization' | 'display' | 'control';  // 组件分类
  icon?: string;                 // 组件图标
  thumbnail?: string;            // 组件缩略图
  defaultSize: { w: number; h: number };  // 默认尺寸
  minSize: { w: number; h: number };      // 最小尺寸
  component: any;                // Angular Component 类
  description?: string;          // 组件描述
}
```

#### 工作流程
1. **进入编辑器**：用户点击"创建页面"或"编辑页面"
2. **拖拽组件**：从左侧组件库拖拽组件到中央画布
3. **调整布局**：移动、缩放组件，调整位置
4. **实时预览**：切换到预览模式，查看真实数据效果
5. **保存页面**：点击保存，将页面配置保存到后端数据库
6. **切换页面**：在页面列表中选择不同页面进行展示

#### 技术实现
- 使用 **angular-gridster2** 实现拖拽布局
- 使用 **Angular CDK Drag Drop** 实现组件库拖拽
- 使用 **ComponentFactoryResolver** 动态加载组件
- 页面配置保存到后端数据库（RESTful API）
- 通过 **component-registry.service** 管理所有可用组件

### 2. 业务组件开箱即用 **【核心】**

#### 设计理念
所有大屏组件都是完整的业务组件，已经对接好后端数据接口。用户只需要拖拽到画布上，组件会自动获取和展示数据，无需任何额外配置。

#### 实现方式
```typescript
// 示例：statistics-card.component.ts
@Component({
  selector: 'app-statistics-card',
  templateUrl: './statistics-card.component.html',
  styleUrls: ['./statistics-card.component.scss']
})
export class StatisticsCardComponent implements OnInit {
  statistics$ = this.dataService.getStatistics(); // 自动获取数据

  constructor(
    private dataService: DataStateService,
    private websocket: WebsocketService
  ) {}

  ngOnInit() {
    // 订阅 WebSocket 实时更新
    this.websocket.onMessage('statistics').subscribe(data => {
      // 自动更新数据
    });
  }
}
```

#### 组件特点
- ✅ **自动数据获取**：组件内部调用对应的 Service 获取数据
- ✅ **实时更新**：自动订阅 WebSocket，接收实时数据
- ✅ **零配置**：用户无需配置任何参数
- ✅ **统一接口**：所有组件遵循统一的数据获取规范

### 3. 多页面管理功能

#### 功能列表
- **页面列表**：展示所有创建的页面
- **创建页面**：快速创建新的大屏页面
- **编辑页面**：进入编辑器修改页面布局
- **删除页面**：删除不需要的页面
- **复制页面**：基于现有页面快速创建副本
- **切换页面**：在不同页面之间切换展示
- **设置默认**：设置系统启动时的默认页面

#### 后端 API 接口（待实现）
```typescript
// page.service.ts
export class PageService {
  // 获取页面列表
  getPages(): Observable<Page[]>

  // 获取单个页面
  getPage(id: string): Observable<Page>

  // 创建页面
  createPage(page: Partial<Page>): Observable<Page>

  // 更新页面
  updatePage(id: string, page: Partial<Page>): Observable<Page>

  // 删除页面
  deletePage(id: string): Observable<void>

  // 复制页面
  duplicatePage(id: string): Observable<Page>

  // 设置默认页面
  setDefaultPage(id: string): Observable<void>
}
```

### 4. 历史数据回放功能

#### 功能设计
- 时间轴拖动，查看任意时间点的数据状态
- 播放/暂停控制，自动回放历史数据
- 播放速度调节（0.5x, 1x, 2x, 5x）
- 关键事件标记，快速跳转到重要时间点
- 支持按时间范围导出历史数据

#### 数据结构
```typescript
// Angular 版本
export interface HistoryData {
  timestamp: number;
  snapshot: {
    statistics: any;
    charts: any[];
    news: any[];
    alerts: any[];
  };
  events?: Array<{
    type: string;
    description: string;
    severity: 'high' | 'medium' | 'low';
  }>;
}
```

#### 技术实现
- 使用 RxJS BehaviorSubject 管理回放状态
- 使用 Angular Service 提供历史数据查询
- 支持时间轴拖动的响应式更新

### 5. 导出报告功能

#### 导出格式
1. **PDF 报告**
   - 包含当前大屏截图
   - 关键数据统计表格
   - 图表快照
   - 自动生成分析摘要

2. **Excel 数据表**
   - 原始数据导出
   - 多 Sheet 分类（舆情数据、统计数据、预警信息等）
   - 支持筛选条件导出

3. **图片格式**
   - 当前大屏截图（PNG/JPG）
   - 单个图表导出
   - 高清图片质量可调

#### 技术实现
- PDF: html2canvas + jspdf
- Excel: xlsx (SheetJS)
- 图片: html2canvas

---
*创建时间: 2025-10-07*
*最后更新: 2025-10-07*
