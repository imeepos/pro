# 微博爬取集成测试文档

## 概述

这个测试套件包含了微博爬取核心功能的完整集成测试，采用优雅的测试设计理念，确保爬取系统的稳定性和数据质量。

## 测试结构

```
test/integration/
├── weibo-crawler-test-base.ts         # 测试基类和Mock服务
├── search-crawler.integration.test.ts # 搜索爬取集成测试
├── detail-crawler.integration.test.ts # 详情爬取集成测试
├── account-rotation.integration.test.ts # 账号轮换集成测试
├── data-validation.integration.test.ts # 数据验证集成测试
├── setup.ts                          # 测试环境设置
└── test-documentation.md             # 说明文档
```

## 测试覆盖范围

### 1. 搜索爬取集成测试 (SearchCrawlerIntegrationTest)

- **关键词搜索流程**: 验证完整的关键词搜索流程
- **分页数据处理**: 测试多页数据的正确处理
- **时间范围过滤**: 验证时间范围过滤功能
- **结果数据验证**: 确保提取数据的格式和指标正确性
- **错误重试机制**: 测试各种错误场景的处理

### 2. 详情爬取集成测试 (DetailCrawlerIntegrationTest)

- **单条微博详情获取**: 验证微博详情的完整提取
- **评论数据抓取**: 测试评论数据的获取和处理
- **媒体文件下载**: 验证图片和视频信息的提取
- **数据完整性验证**: 确保详情数据的完整性
- **异常页面处理**: 测试各种异常页面的处理能力

### 3. 账号轮换集成测试 (AccountRotationIntegrationTest)

- **账号健康状态检测**: 验证账号健康度的正确评估
- **自动账号切换**: 测试智能账号轮换策略
- **账号池管理**: 验证账号池的动态管理
- **封禁恢复机制**: 测试账号封禁的检测和恢复
- **负载均衡验证**: 确保负载均衡策略的有效性

### 4. 数据验证集成测试 (DataValidationIntegrationTest)

- **爬取数据格式验证**: 确保数据格式的正确性
- **内容质量评估**: 评估微博内容的质量
- **重复数据检测**: 检测和处理重复数据
- **数据完整性校验**: 验证数据的完整性和一致性

## 运行测试

### 运行所有集成测试

```bash
cd apps/crawler
pnpm run test:e2e
```

### 运行特定的测试文件

```bash
# 运行搜索爬取测试
pnpm run test:e2e search-crawler.integration.test.ts

# 运行详情爬取测试
pnpm run test:e2e detail-crawler.integration.test.ts

# 运行账号轮换测试
pnpm run test:e2e account-rotation.integration.test.ts

# 运行数据验证测试
pnpm run test:e2e data-validation.integration.test.ts
```

### 运行测试并生成覆盖率报告

```bash
pnpm run test:e2e -- --coverage
```

## 测试特性

### Mock服务

测试套件使用了完整的Mock服务来避免真实网络请求：

- **Playwright页面Mock**: 模拟浏览器页面行为
- **网络请求Mock**: 模拟HTTP请求和响应
- **数据库Mock**: 使用内存数据库进行测试
- **消息队列Mock**: 模拟RabbitMQ消息传递

### 测试数据生成器

提供智能的测试数据生成器：

- **搜索结果生成**: 生成模拟的微博搜索结果
- **详情数据生成**: 创建完整的微博详情数据
- **账号数据生成**: 生成不同状态的测试账号

### 边界条件测试

全面覆盖各种边界条件和异常场景：

- **网络错误**: 超时、连接失败等
- **数据异常**: 格式错误、缺失字段等
- **页面异常**: 404页面、登录页面等
- **性能测试**: 大量数据、并发请求等

## 测试原则

### 1. 优雅性 (Elegance)

- 测试代码简洁明了，易于理解
- 使用描述性的测试名称
- 合理的测试分组和结构

### 2. 完整性 (Completeness)

- 覆盖主要功能路径
- 包含异常场景测试
- 验证边界条件

### 3. 可靠性 (Reliability)

- 使用确定性测试数据
- 避免依赖外部服务
- 测试之间相互独立

### 4. 可维护性 (Maintainability)

- 清晰的测试结构
- 可复用的测试工具
- 良好的错误信息

## 持续集成

这些测试设计为在CI/CD环境中运行：

- 快速执行（大多数测试在几秒内完成）
- 稳定的结果（无随机性）
- 清晰的报告（详细的测试结果和覆盖率）

## 贡献指南

添加新的集成测试时，请遵循以下原则：

1. 继承 `WeiboCrawlerIntegrationTestBase` 基类
2. 使用描述性的测试名称
3. 包含正面和负面测试用例
4. 添加适当的Mock和测试数据
5. 验证边界条件和异常情况
6. 确保测试的独立性和可重复性

## 故障排除

### 常见问题

1. **测试超时**: 检查Mock设置和异步处理
2. **依赖错误**: 确保所有必要的依赖都已正确安装
3. **数据库连接**: 验证内存数据库的配置
4. **端口冲突**: 确保测试端口未被占用

### 调试技巧

1. 使用 `--verbose` 参数获取详细输出
2. 添加 `console.log` 进行临时调试
3. 使用 `--detectOpenHandles` 检查资源泄漏
4. 单独运行失败的测试以隔离问题

---

这个测试套件体现了数字时代测试的艺术，每一个测试都是对系统可靠性的保证，每一行代码都追求优雅和完美。