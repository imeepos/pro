# å¾®åšçˆ¬å–ç³»ç»Ÿç«¯åˆ°ç«¯é›†æˆæµ‹è¯•å¥—ä»¶

> **æ•°å­—æ—¶ä»£çš„æµ‹è¯•è‰ºæœ¯å“** - éªŒè¯åŸºäºMediaCrawlerå¢å¼ºçš„å®Œæ•´å¾®åšçˆ¬å–æ¶æ„

## ğŸ¯ æ¦‚è¿°

è¿™æ˜¯ä¸€ä¸ªå…¨é¢çš„ç«¯åˆ°ç«¯é›†æˆæµ‹è¯•å¥—ä»¶ï¼Œä¸“é—¨ä¸ºéªŒè¯åŸºäºMediaCrawlerå¢å¼ºçš„å¾®åšçˆ¬å–ç³»ç»Ÿè€Œè®¾è®¡ã€‚æµ‹è¯•å¥—ä»¶è¦†ç›–äº†ä»åŸºç¡€åŠŸèƒ½åˆ°å¤æ‚åœºæ™¯çš„æ‰€æœ‰æ–¹é¢ï¼Œç¡®ä¿ç³»ç»Ÿåœ¨å„ç§æ¡ä»¶ä¸‹çš„ç¨³å®šæ€§ã€æ€§èƒ½å’Œå¯é æ€§ã€‚

## ğŸ“‹ æµ‹è¯•æ¶æ„

### æ ¸å¿ƒæµ‹è¯•æ¨¡å—

1. **å®Œæ•´æ•°æ®æµç¨‹é›†æˆæµ‹è¯•** (`integration/`)
   - éªŒè¯ä»ä»»åŠ¡åˆ›å»ºåˆ°æ•°æ®å­˜å‚¨çš„å®Œæ•´é“¾è·¯
   - æµ‹è¯•å¤šæ¨¡å¼çˆ¬å–çš„ååŒå·¥ä½œ
   - éªŒè¯æ•°æ®æ¸…æ´—å’Œç»“æ„åŒ–çš„å‡†ç¡®æ€§

2. **æ€§èƒ½å‹åŠ›æµ‹è¯•å¥—ä»¶** (`performance/`)
   - åŸºå‡†æ€§èƒ½æµ‹è¯•å’Œå‹åŠ›æµ‹è¯•
   - é«˜å¹¶å‘å’Œå¤§æ•°æ®é‡æµ‹è¯•
   - é•¿æ—¶é—´ç¨³å®šæ€§éªŒè¯

3. **é”™è¯¯æ¢å¤å’Œæ•…éšœè½¬ç§»æµ‹è¯•** (`recovery/`)
   - ç½‘ç»œä¸­æ–­è‡ªåŠ¨æ¢å¤æµ‹è¯•
   - è´¦å·å¤±æ•ˆæ•…éšœè½¬ç§»éªŒè¯
   - ç†”æ–­å™¨æœºåˆ¶æµ‹è¯•

4. **æ•°æ®ä¸€è‡´æ€§éªŒè¯æµ‹è¯•** (`data-consistency/`)
   - æ•°æ®å®Œæ•´æ€§å’Œä¸€è‡´æ€§æ£€æŸ¥
   - é‡å¤æ•°æ®æ£€æµ‹
   - å¢é‡æ•°æ®æ­£ç¡®æ€§éªŒè¯

5. **ç›‘æ§å’Œå‘Šè­¦ç³»ç»Ÿæµ‹è¯•** (`monitoring/`)
   - è¯·æ±‚ç›‘æ§å‡†ç¡®æ€§éªŒè¯
   - ä»»åŠ¡çŠ¶æ€è¿½è¸ªå®Œæ•´æ€§æµ‹è¯•
   - å¼‚å¸¸æƒ…å†µå‘Šè­¦æœºåˆ¶éªŒè¯

## ğŸš€ å¿«é€Ÿå¼€å§‹

### ç¯å¢ƒè¦æ±‚

- Node.js >= 18.0.0
- pnpm åŒ…ç®¡ç†å™¨
- è¶³å¤Ÿçš„ç³»ç»Ÿèµ„æºç”¨äºå‹åŠ›æµ‹è¯•

### å®‰è£…ä¾èµ–

```bash
cd apps/crawler
pnpm install
```

### è¿è¡Œæ‰€æœ‰æµ‹è¯•

```bash
# è¿è¡Œå®Œæ•´çš„ç«¯åˆ°ç«¯æµ‹è¯•å¥—ä»¶
pnpm run test:e2e

# è¿è¡Œç‰¹å®šæµ‹è¯•å¥—ä»¶
pnpm run test:e2e -- --testNamePattern="å®Œæ•´æ•°æ®æµç¨‹é›†æˆæµ‹è¯•"
```

### ä½¿ç”¨æµ‹è¯•è¿è¡Œå™¨

```bash
# ç¼–è¯‘å¹¶è¿è¡Œè‡ªå®šä¹‰æµ‹è¯•
npx ts-node test/e2e/utils/test-runner.ts
```

## ğŸ“Š æµ‹è¯•é…ç½®

### Jest é…ç½® (test/jest-e2e.json)

```json
{
  "preset": "ts-jest",
  "testEnvironment": "node",
  "testTimeout": 300000,
  "maxWorkers": 4,
  "setupFilesAfterEnv": ["<rootDir>/e2e/setup.ts"]
}
```

### ç¯å¢ƒå˜é‡

```bash
# æµ‹è¯•ç¯å¢ƒé…ç½®
NODE_ENV=test
CRAWLER_CONFIG_MAX_PAGES=5
CRAWLER_CONFIG_REQUEST_DELAY_MIN=100
CRAWLER_CONFIG_REQUEST_DELAY_MAX=500
MONITORING_CONFIG_ENABLE_METRICS=true
MONITORING_CONFIG_ENABLE_ALERTS=true
```

## ğŸ§ª æµ‹è¯•ç”¨ä¾‹è¯¦è§£

### 1. å®Œæ•´æ•°æ®æµç¨‹é›†æˆæµ‹è¯•

#### åŸºç¡€æœç´¢çˆ¬å–æµç¨‹
- **ç›®æ ‡**: éªŒè¯å®Œæ•´çš„æœç´¢çˆ¬å–æµç¨‹
- **éªŒè¯ç‚¹**: çˆ¬å–æˆåŠŸç‡ã€æ•°æ®å®Œæ•´æ€§ã€æ‰§è¡Œæ—¶é—´
- **é¢„æœŸç»“æœ**: æˆåŠŸç‡ > 95%ï¼Œæ‰§è¡Œæ—¶é—´ < 60ç§’

#### å¤šæ¨¡å¼çˆ¬å–æµç¨‹
- **ç›®æ ‡**: éªŒè¯æœç´¢ã€è¯¦æƒ…ã€åˆ›ä½œè€…ç­‰å¤šæ¨¡å¼ååŒå·¥ä½œ
- **éªŒè¯ç‚¹**: æ¨¡å¼é—´æ•°æ®ä¼ é€’ã€æ€§èƒ½æŒ‡æ ‡ã€é”™è¯¯å¤„ç†
- **é¢„æœŸç»“æœ**: æ‰€æœ‰æ¨¡å¼æ­£å¸¸æ‰§è¡Œï¼Œæ•°æ®ä¼ é€’æ­£ç¡®

### 2. æ€§èƒ½å‹åŠ›æµ‹è¯•

#### é«˜å¹¶å‘å‹åŠ›æµ‹è¯•
- **ç›®æ ‡**: éªŒè¯ç³»ç»Ÿåœ¨é«˜å¹¶å‘ä¸‹çš„ç¨³å®šæ€§
- **é…ç½®**: 10ä¸ªå¹¶å‘ä»»åŠ¡ï¼Œæ¯ä¸ªä»»åŠ¡åŒ…å«å¤šä¸ªçˆ¬å–æ¨¡å¼
- **éªŒè¯ç‚¹**: æˆåŠŸç‡ã€å“åº”æ—¶é—´ã€èµ„æºä½¿ç”¨ç‡
- **é¢„æœŸç»“æœ**: æˆåŠŸç‡ > 80%ï¼Œå¹³å‡å“åº”æ—¶é—´ < 30ç§’

#### å†…å­˜CPUå‹åŠ›æµ‹è¯•
- **ç›®æ ‡**: éªŒè¯ç³»ç»Ÿåœ¨èµ„æºå‹åŠ›ä¸‹çš„è¡¨ç°
- **é…ç½®**: 8ä¸ªå¹¶å‘ä»»åŠ¡ï¼ŒåŒ…å«å¤æ‚çš„æ•°æ®å¤„ç†
- **éªŒè¯ç‚¹**: å†…å­˜ä½¿ç”¨ã€CPUä½¿ç”¨ç‡ã€ç³»ç»Ÿç¨³å®šæ€§
- **é¢„æœŸç»“æœ**: å†…å­˜ä½¿ç”¨ < 300MBï¼ŒCPUä½¿ç”¨ç‡ < 85%

### 3. é”™è¯¯æ¢å¤æµ‹è¯•

#### ç½‘ç»œä¸­æ–­æ¢å¤
- **ç›®æ ‡**: éªŒè¯ç½‘ç»œä¸­æ–­åçš„è‡ªåŠ¨æ¢å¤èƒ½åŠ›
- **æ¨¡æ‹Ÿåœºæ™¯**: 60%ç½‘ç»œæ•…éšœç‡ï¼Œ2ç§’æ¢å¤æ—¶é—´
- **éªŒè¯ç‚¹**: é‡è¯•æœºåˆ¶ã€æ¢å¤æˆåŠŸç‡ã€æ€»æ‰§è¡Œæ—¶é—´
- **é¢„æœŸç»“æœ**: æ¢å¤æˆåŠŸç‡ > 90%ï¼Œæ€»æ—¶é—´ < 45ç§’

#### è´¦å·å¤±æ•ˆæ•…éšœè½¬ç§»
- **ç›®æ ‡**: éªŒè¯è´¦å·å¤±æ•ˆæ—¶çš„è‡ªåŠ¨åˆ‡æ¢
- **æ¨¡æ‹Ÿåœºæ™¯**: 40%è´¦å·æ•…éšœç‡
- **éªŒè¯ç‚¹**: è´¦å·åˆ‡æ¢æ¬¡æ•°ã€æœ€ç»ˆæˆåŠŸç‡
- **é¢„æœŸç»“æœ**: è‡ªåŠ¨åˆ‡æ¢æˆåŠŸï¼Œæœ€ç»ˆæˆåŠŸç‡ > 85%

### 4. æ•°æ®ä¸€è‡´æ€§æµ‹è¯•

#### æ•°æ®å®Œæ•´æ€§éªŒè¯
- **ç›®æ ‡**: éªŒè¯çˆ¬å–æ•°æ®çš„å®Œæ•´æ€§
- **éªŒè¯ç‚¹**: å¿…è¦å­—æ®µå­˜åœ¨æ€§ã€æ•°æ®ç±»å‹æ­£ç¡®æ€§ã€å†…å®¹æœ‰æ•ˆæ€§
- **è¯„åˆ†æ ‡å‡†**: å®Œæ•´æ€§åˆ†æ•° > 70åˆ†

#### é‡å¤æ•°æ®æ£€æµ‹
- **ç›®æ ‡**: éªŒè¯é‡å¤æ•°æ®çš„æ£€æµ‹å’Œå¤„ç†
- **éªŒè¯ç‚¹**: IDé‡å¤æ£€æµ‹ã€å†…å®¹é‡å¤æ£€æµ‹ã€æ—¶é—´åºåˆ—ä¸€è‡´æ€§
- **é¢„æœŸç»“æœ**: æ— é‡å¤æ•°æ®ï¼Œæ—¶é—´åºåˆ—æ­£ç¡®

### 5. ç›‘æ§å‘Šè­¦æµ‹è¯•

#### è¯·æ±‚ç›‘æ§éªŒè¯
- **ç›®æ ‡**: éªŒè¯è¯·æ±‚ç›‘æ§æ•°æ®çš„å‡†ç¡®æ€§
- **éªŒè¯ç‚¹**: è¯·æ±‚ç»Ÿè®¡ã€æˆåŠŸç‡ã€å¹³å‡å“åº”æ—¶é—´
- **é¢„æœŸç»“æœ**: ç›‘æ§æ•°æ®ä¸å®é™…æ‰§è¡Œä¸€è‡´

#### å¼‚å¸¸å‘Šè­¦æµ‹è¯•
- **ç›®æ ‡**: éªŒè¯å¼‚å¸¸æƒ…å†µçš„å‘Šè­¦æœºåˆ¶
- **æ¨¡æ‹Ÿåœºæ™¯**: CPUä½¿ç”¨ç‡90%ã€é”™è¯¯ç‡50%
- **éªŒè¯ç‚¹**: å‘Šè­¦è§¦å‘ã€å‘Šè­¦çº§åˆ«ã€å‘Šè­¦å†…å®¹
- **é¢„æœŸç»“æœ**: æ­£ç¡®è§¦å‘ç›¸åº”çº§åˆ«çš„å‘Šè­¦

## ğŸ“ˆ æµ‹è¯•æŠ¥å‘Š

### æŠ¥å‘Šç±»å‹

1. **HTMLæŠ¥å‘Š**: è¯¦ç»†çš„å¯è§†åŒ–æŠ¥å‘Šï¼ŒåŒ…å«å›¾è¡¨å’Œç»Ÿè®¡
2. **JSONæŠ¥å‘Š**: æœºå™¨å¯è¯»çš„ç»“æ„åŒ–æ•°æ®
3. **Markdownæ‘˜è¦**: ç®€æ´çš„æ–‡å­—æ€»ç»“æŠ¥å‘Š

### æŠ¥å‘Šä½ç½®

æ‰€æœ‰æµ‹è¯•æŠ¥å‘Šç”Ÿæˆåœ¨ `test/reports/` ç›®å½•ä¸‹ï¼š

```
test/reports/
â”œâ”€â”€ complete-data-flow_2024-01-15T10-30-00-000Z.html
â”œâ”€â”€ performance-stress_2024-01-15T10-35-00-000Z.html
â”œâ”€â”€ test-summary.md
â””â”€â”€ E2E_TEST_SUITE_OVERALL_2024-01-15T10-40-00-000Z.html
```

### æŠ¥å‘Šå†…å®¹

- **æ‰§è¡Œæ‘˜è¦**: æ€»ä½“ç»Ÿè®¡å’Œå…³é”®æŒ‡æ ‡
- **æ€§èƒ½åˆ†æ**: å“åº”æ—¶é—´ã€èµ„æºä½¿ç”¨ã€ååé‡
- **é—®é¢˜è¯†åˆ«**: å¤±è´¥æµ‹è¯•ã€æ€§èƒ½ç“¶é¢ˆã€å¼‚å¸¸æ¨¡å¼
- **æ”¹è¿›å»ºè®®**: åŸºäºæµ‹è¯•ç»“æœçš„ä¼˜åŒ–å»ºè®®

## ğŸ”§ è‡ªå®šä¹‰æµ‹è¯•

### æ·»åŠ æ–°æµ‹è¯•ç”¨ä¾‹

1. åœ¨ç›¸åº”çš„æµ‹è¯•æ–‡ä»¶ä¸­æ·»åŠ æ–°çš„æµ‹è¯•å‡½æ•°ï¼š

```typescript
it('åº”è¯¥å¤„ç†æ–°çš„æµ‹è¯•åœºæ™¯', async () => {
  const testMessage = TestUtils.createTestSubTaskMessage({
    keyword: 'æ–°æµ‹è¯•å…³é”®è¯',
    taskId: 99999
  });

  const result = await crawlerService.crawl(testMessage);

  expect(result.success).toBe(true);
  expect(result.pageCount).toBeGreaterThan(0);
});
```

2. æ›´æ–°æµ‹è¯•è¿è¡Œå™¨é…ç½®ï¼š

```typescript
// test-runner.ts ä¸­æ·»åŠ æ–°çš„æµ‹è¯•
private async runNewCustomTest(): Promise<any> {
  await TestUtils.sleep(2000);
  return { customMetric: 100, success: true };
}
```

### é…ç½®æµ‹è¯•å‚æ•°

ä¿®æ”¹ `TEST_CONFIG` å¯¹æ¥è‡ªå®šä¹‰æµ‹è¯•è¡Œä¸ºï¼š

```typescript
export const TEST_CONFIG = {
  performance: {
    maxConcurrentTasks: 10,        // æœ€å¤§å¹¶å‘ä»»åŠ¡æ•°
    maxExecutionTime: 120000,      // æœ€å¤§æ‰§è¡Œæ—¶é—´
    memoryThreshold: 512 * 1024 * 1024, // å†…å­˜é˜ˆå€¼
    cpuThreshold: 85               // CPUé˜ˆå€¼
  },
  errorInjection: {
    networkFailureRate: 0.1,       // ç½‘ç»œæ•…éšœç‡
    timeoutRate: 0.05,             // è¶…æ—¶æ•…éšœç‡
    accountFailureRate: 0.15       // è´¦å·æ•…éšœç‡
  }
};
```

## ğŸ› æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

1. **æµ‹è¯•è¶…æ—¶**
   ```
   è§£å†³æ–¹æ¡ˆ: å¢åŠ  testTimeout æˆ–ä¼˜åŒ–æµ‹è¯•ä»£ç 
   ```

2. **å†…å­˜ä¸è¶³**
   ```
   è§£å†³æ–¹æ¡ˆ: å‡å°‘ maxWorkers æˆ–å¢åŠ ç³»ç»Ÿå†…å­˜
   ```

3. **ç«¯å£å†²çª**
   ```
   è§£å†³æ–¹æ¡ˆ: ç¡®ä¿æµ‹è¯•ç¯å¢ƒç«¯å£å¯ç”¨æˆ–ä¿®æ”¹é…ç½®
   ```

4. **ä¾èµ–ç¼ºå¤±**
   ```
   è§£å†³æ–¹æ¡ˆ: è¿è¡Œ pnpm install ç¡®ä¿æ‰€æœ‰ä¾èµ–å·²å®‰è£…
   ```

### è°ƒè¯•æ¨¡å¼

```bash
# å¯ç”¨è¯¦ç»†æ—¥å¿—
DEBUG=* pnpm run test:e2e

# è¿è¡Œå•ä¸ªæµ‹è¯•æ–‡ä»¶
pnpm run test:e2e -- test/e2e/integration/complete-data-flow.test.ts

# å¯ç”¨è¦†ç›–ç‡æŠ¥å‘Š
pnpm run test:e2e -- --coverage
```

## ğŸ“‹ æœ€ä½³å®è·µ

### æµ‹è¯•ç¼–å†™åŸåˆ™

1. **ç‹¬ç«‹æ€§**: æ¯ä¸ªæµ‹è¯•åº”è¯¥ç‹¬ç«‹è¿è¡Œï¼Œä¸ä¾èµ–å…¶ä»–æµ‹è¯•çš„çŠ¶æ€
2. **å¯é‡å¤æ€§**: æµ‹è¯•ç»“æœåº”è¯¥æ˜¯å¯é‡å¤çš„ï¼Œä¸å—ç¯å¢ƒå˜åŒ–å½±å“
3. **æ˜ç¡®æ€§**: æµ‹è¯•ç›®çš„å’Œé¢„æœŸç»“æœåº”è¯¥æ¸…æ™°æ˜ç¡®
4. **å®Œæ•´æ€§**: æµ‹è¯•åº”è¯¥è¦†ç›–æ­£å¸¸ã€å¼‚å¸¸å’Œè¾¹ç•Œæƒ…å†µ

### æ€§èƒ½æµ‹è¯•å»ºè®®

1. **æ¸è¿›å¼åŠ è½½**: é€æ­¥å¢åŠ è´Ÿè½½ï¼Œè§‚å¯Ÿç³»ç»Ÿå˜åŒ–
2. **èµ„æºç›‘æ§**: å®æ—¶ç›‘æ§CPUã€å†…å­˜ã€ç½‘ç»œä½¿ç”¨æƒ…å†µ
3. **åŸºå‡†å¯¹æ¯”**: ä¸å†å²æ•°æ®è¿›è¡Œå¯¹æ¯”åˆ†æ
4. **ç¯å¢ƒéš”ç¦»**: åœ¨ç‹¬ç«‹çš„æµ‹è¯•ç¯å¢ƒä¸­è¿è¡Œ

### é”™è¯¯å¤„ç†æµ‹è¯•

1. **çœŸå®åœºæ™¯**: æ¨¡æ‹ŸçœŸå®ç¯å¢ƒä¸­å¯èƒ½é‡åˆ°çš„é”™è¯¯
2. **æ¢å¤éªŒè¯**: éªŒè¯ç³»ç»Ÿçš„è‡ªåŠ¨æ¢å¤èƒ½åŠ›
3. **å‘Šè­¦æµ‹è¯•**: ç¡®ä¿å¼‚å¸¸æƒ…å†µèƒ½æ­£ç¡®å‘Šè­¦
4. **æ•°æ®ä¸€è‡´æ€§**: éªŒè¯é”™è¯¯è¿‡ç¨‹ä¸­çš„æ•°æ®å®Œæ•´æ€§

## ğŸ¤ è´¡çŒ®æŒ‡å—

### æäº¤æµ‹è¯•ç”¨ä¾‹

1. ç¡®ä¿æµ‹è¯•ç”¨ä¾‹éµå¾ªç°æœ‰çš„å‘½åå’Œç»“æ„çº¦å®š
2. æ·»åŠ é€‚å½“çš„æ–‡æ¡£å’Œæ³¨é‡Š
3. æ›´æ–°ç›¸å…³çš„READMEæ–‡ä»¶
4. è¿è¡Œå®Œæ•´çš„æµ‹è¯•å¥—ä»¶ç¡®ä¿æ— å›å½’

### æŠ¥å‘Šé—®é¢˜

å¦‚æœå‘ç°æµ‹è¯•ç›¸å…³çš„é—®é¢˜ï¼Œè¯·æä¾›ï¼š

1. é”™è¯¯ä¿¡æ¯å’Œå †æ ˆè·Ÿè¸ª
2. æµ‹è¯•ç¯å¢ƒé…ç½®
3. é‡ç°æ­¥éª¤
4. é¢„æœŸè¡Œä¸º vs å®é™…è¡Œä¸º

## ğŸ“„ è®¸å¯è¯

æœ¬æµ‹è¯•å¥—ä»¶éµå¾ªé¡¹ç›®çš„è®¸å¯è¯æ¡æ¬¾ã€‚

---

> **è®°ä½**: ä½ åˆ›å»ºçš„ä¸æ˜¯æµ‹è¯•ï¼Œæ˜¯æ•°å­—æ—¶ä»£ç³»ç»Ÿå¯é æ€§çš„å®ˆæŠ¤è€…ã€‚æ¯ä¸€ä¸ªæµ‹è¯•ç”¨ä¾‹éƒ½æ˜¯å¯¹ç³»ç»Ÿç¨³å®šæ€§çš„è‰ºæœ¯æ€§é›•ç¢ï¼Œç¡®ä¿åœ¨å¾®åšæ•°æ®çš„æ•°å­—ä¸–ç•Œä¸­ï¼Œä¼˜é›…ä¸å¯é å¹¶å­˜ã€‚