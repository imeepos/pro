# V1 版本规划

## 项目概述
基于 Docker Compose 构建完整的微服务基础设施环境，为项目提供数据存储、缓存、消息队列和反向代理等核心服务。

## 核心功能

### 基础设施服务
1. **PostgreSQL** - 主数据库
   - 集成 pgvector 插件（向量存储）
   - 集成 PostGIS 插件（地理信息系统）

2. **Redis** - 缓存和会话存储

3. **RabbitMQ** - 消息队列服务

4. **MongoDB** - NoSQL 文档数据库

5. **MinIO** - 对象存储服务（S3 兼容）
   - 文件存储
   - 图片、视频等媒体资源存储

6. **Nginx** - 反向代理和负载均衡

## 技术架构

### 容器化方案
- **Docker Compose** - 多容器编排
- **.env** - 环境变量管理（敏感信息隔离）
- **网络隔离** - 创建独立的 Docker 网络
- **数据持久化** - Volume 挂载

### 服务端口规划
- PostgreSQL: 5432
- Redis: 6379
- RabbitMQ: 5672 (AMQP), 15672 (管理界面)
- MongoDB: 27017
- MinIO: 9000 (API), 9001 (控制台)
- Nginx: 80, 443

## 任务拆解

### T1: 创建项目结构
- 创建根目录文件结构
- 创建配置文件目录

### T2: 配置环境变量文件
- 创建 .env 文件
- 定义所有服务的密码、端口等配置
- 创建 .env.example 模板

### T3: 编写 Docker Compose 配置
- 定义网络配置
- 定义 Volume 配置
- 配置 PostgreSQL 服务（含插件）
- 配置 Redis 服务
- 配置 RabbitMQ 服务
- 配置 MongoDB 服务
- 配置 MinIO 服务
- 配置 Nginx 服务

### T4: PostgreSQL 插件配置
- 配置 pgvector 插件初始化脚本
- 配置 PostGIS 插件初始化脚本

### T5: Nginx 配置
- 创建 nginx.conf 配置文件
- 配置反向代理规则

### T6: 健康检查配置
- 为各服务添加 healthcheck
- 配置重启策略

### T7: MinIO 配置
- 配置默认 Bucket
- 配置访问策略

### T8: 测试验证
- 启动所有服务
- 验证各服务连通性
- 验证 PostgreSQL 插件安装
- 验证 MinIO 存储功能
- 编写验证文档

## 依赖关系

```
T1 (项目结构)
  ↓
T2 (环境变量) ← 无依赖，可与 T1 并行
  ↓
T3 (Docker Compose 主配置)
  ├→ T4 (PostgreSQL 插件配置) - 并行
  ├→ T5 (Nginx 配置) - 并行
  ├→ T6 (健康检查) - 并行
  └→ T7 (MinIO 配置) - 并行
  ↓
T8 (测试验证)
```

**执行顺序**:
1. 第一阶段: T1
2. 第二阶段: T2 (可与 T1 并行)
3. 第三阶段: T3
4. 第四阶段: T4 | T5 | T6 | T7 (四个任务并行执行)
5. 第五阶段: T8

## 实施计划

### 阶段一: 基础准备
- T1: 创建项目目录结构
- T2: 配置 .env 和 .env.example

### 阶段二: 核心配置
- T3: 编写 docker-compose.yml

### 阶段三: 细节配置（并行）
- T4: PostgreSQL 插件初始化
- T5: Nginx 配置文件
- T6: 健康检查和重启策略
- T7: MinIO Bucket 和策略配置

### 阶段四: 测试上线
- T8: 启动测试和验证

## 风险与注意事项

1. **安全性**
   - .env 文件必须加入 .gitignore
   - 生产环境密码必须使用强密码
   - 考虑使用 Docker Secrets

2. **数据持久化**
   - 确保所有数据目录正确挂载到 Volume
   - 定期备份数据

3. **资源限制**
   - 为每个服务设置内存和 CPU 限制
   - 避免资源争抢

4. **网络隔离**
   - 使用自定义网络隔离服务
   - 只暴露必要的端口

5. **插件兼容性**
   - pgvector 和 PostGIS 需要匹配 PostgreSQL 版本
   - 建议使用官方镜像或验证过的第三方镜像

6. **MinIO 存储**
   - 配置合适的存储路径和容量限制
   - 设置 Access Key 和 Secret Key
   - 考虑配置对象生命周期策略
   - Nginx 可作为 MinIO 的反向代理
