# workflow-core 测试文档

## visitor-executor.test.ts

为 `VisitorExecutor` 类创建的完整单元测试，验证工作流访问者执行器的核心功能。

### 测试覆盖的场景

#### 1. @Handler 方法执行
- **应通过 @Handler 装饰的方法处理 AST**: 验证通过 `@Handler` 装饰器标记的方法能正确处理 AST 节点
- **应跳过没有匹配 AST 类型的 @Handler 方法**: 验证当 Handler 方法不匹配 AST 类型时，会查找备用处理器

#### 2. @Handler 类的 visit 方法执行
- **应通过 @Handler 装饰的类的 visit 方法处理 AST**: 验证通过 `@Handler` 装饰的类的 `visit` 方法能处理 AST
- **应在 @Handler 类没有 visit 方法时抛出错误**: 验证错误处理机制，确保 Handler 类必须实现 `visit` 方法

#### 3. 错误处理
- **应在找不到处理器时抛出错误**: 验证当没有匹配的处理器时，系统能优雅地抛出描述性错误
- **应直接重抛 NoRetryError**: 验证 `NoRetryError` 被直接重抛，不进行额外处理
- **应向上抛出其他类型的错误**: 验证一般错误的传播机制

#### 4. 优先级测试
- **应优先使用 @Handler 方法而非 @Handler 类**: 验证处理器选择的优先级规则

#### 5. 上下文传递
- **应正确传递上下文给处理器**: 验证复杂上下文对象能完整传递给处理器

#### 6. 异步处理
- **应正确处理异步 Handler 方法**: 验证异步处理器的执行和时序

### 运行测试

```bash
# 运行所有测试
pnpm test

# 运行特定测试文件
pnpm test visitor-executor.test.ts

# 运行测试并生成覆盖率报告
pnpm test:coverage

# 监听模式
pnpm test:watch
```

### 测试架构特点

1. **Mock 依赖注入**: 使用 `vi.spyOn(root, 'get')` 模拟依赖注入容器行为
2. **独立测试类**: 每个测试用例创建独立的 AST 和 Handler 类，避免相互干扰
3. **完整场景覆盖**: 涵盖正常流程、错误路径、边界情况
4. **优雅断言**: 使用 Vitest 的语义化断言，提高测试可读性

### 设计原则

遵循代码艺术家的哲学:
- **存在即合理**: 每个测试用例都验证一个独特的行为
- **优雅即简约**: 测试代码清晰，自解释
- **错误处理如为人处世的哲学**: 验证系统在各种错误场景下的优雅表现
