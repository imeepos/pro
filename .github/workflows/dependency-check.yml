name: ä¾èµ–ç‰ˆæœ¬æ£€æŸ¥

on:
  push:
    branches: [ master, main ]
  pull_request:
    branches: [ master, main ]
  schedule:
    # æ¯å‘¨ä¸€æ—©ä¸Š8ç‚¹è¿è¡Œ
    - cron: '0 8 * * 1'
  workflow_dispatch:

jobs:
  dependency-check:
    name: ä¾èµ–ç‰ˆæœ¬ä¸€è‡´æ€§æ£€æŸ¥
    runs-on: ubuntu-latest

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½®Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: å®‰è£…pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 9.15.1

      - name: å®‰è£…ä¾èµ–
        run: pnpm install --frozen-lockfile

      - name: è¿è¡Œä¾èµ–ç‰ˆæœ¬æ£€æŸ¥
        run: pnpm deps:check
        continue-on-error: true

      - name: è¿è¡Œå®‰å…¨å®¡è®¡
        run: pnpm deps:audit
        continue-on-error: true

      - name: ç”Ÿæˆä¾èµ–æŠ¥å‘Š
        if: always()
        run: |
          echo "## ä¾èµ–æ£€æŸ¥æŠ¥å‘Š" > $GITHUB_STEP_SUMMARY
          echo "### ç‰ˆæœ¬ä¸€è‡´æ€§æ£€æŸ¥" >> $GITHUB_STEP_SUMMARY
          pnpm deps:check || echo "âš ï¸ å‘ç°ç‰ˆæœ¬å†²çª" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### å®‰å…¨å®¡è®¡" >> $GITHUB_STEP_SUMMARY
          pnpm deps:audit || echo "âš ï¸ å‘ç°å®‰å…¨é—®é¢˜" >> $GITHUB_STEP_SUMMARY

  update-dependencies-doc:
    name: æ›´æ–°ä¾èµ–æ–‡æ¡£
    runs-on: ubuntu-latest
    needs: dependency-check
    if: github.event_name == 'schedule' && github.ref == 'refs/heads/master'

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: è®¾ç½®Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: å®‰è£…pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 9.15.1

      - name: å®‰è£…ä¾èµ–
        run: pnpm install --frozen-lockfile

      - name: é…ç½®Git
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'

      - name: æ£€æŸ¥ä¾èµ–å˜åŒ–å¹¶æäº¤
        run: |
          # ç”Ÿæˆæ–°çš„ä¾èµ–æŠ¥å‘Š
          pnpm deps:check > deps-report.txt 2>&1 || true

          # æ£€æŸ¥æ˜¯å¦æœ‰å˜åŒ–éœ€è¦æäº¤
          if [[ -n $(git status --porcelain) ]]; then
            git add .
            git commit -m "ğŸ¤– è‡ªåŠ¨æ›´æ–°ä¾èµ–æ£€æŸ¥æŠ¥å‘Š

            - è¿è¡Œä¾èµ–ç‰ˆæœ¬ä¸€è‡´æ€§æ£€æŸ¥
            - æ›´æ–°dependencies.mdæ–‡æ¡£
            - æ‰§è¡Œå®‰å…¨å®¡è®¡

            ğŸ¤– Generated with GitHub Actions"
            git push
          else
            echo "æ²¡æœ‰å‘ç°ä¾èµ–å˜åŒ–"
          fi