# RabbitMQ 连接状态和队列配置诊断报告

## 生成时间
2025-10-18 12:25:54

## 🔍 检查摘要

### ✅ 正常状态
- **RabbitMQ服务**: 运行正常 (版本 3.13.7)
- **连接地址**: amqp://admin:***@43.240.223.138:5672
- **管理界面**: http://43.240.223.138:15672
- **连接状态**: 5个活跃连接
- **交换机配置**: 正常

### ⚠️ 需要关注的问题
- **消息积压**: 部分队列存在大量未处理消息
- **消费者不足**: 某些队列有消息但无消费者处理

## 📊 队列状态详情

### 🎯 关键队列

#### 1. 微博爬虫队列 (weibo_crawl_queue)
- **状态**: ✅ 正常
- **消息数**: 0
- **消费者数**: 1
- **死信队列**: weibo_crawl_queue.dlq (0 消息)
- **分析**: 队列为空，有活跃消费者，工作正常

#### 2. 微博任务状态队列 (weibo_task_status_queue)
- **状态**: ✅ 正常
- **消息数**: 0
- **消费者数**: 1
- **死信队列**: weibo_task_status_queue.dlq (0 消息)
- **分析**: 队列为空，有活跃消费者，工作正常

### ⚠️ 积压队列

#### 3. 微博账号队列 (weibo_account)
- **状态**: ⚠️ 有消息积压
- **消息数**: 16,965
- **消费者数**: 0
- **内存使用**: ~87 MB
- **建议**: 需要启动相关消费者处理账号信息

#### 4. 微博详情队列 (weibo_detail)
- **状态**: ⚠️ 有消息积压
- **消息数**: 16,963
- **消费者数**: 0
- **内存使用**: ~2.8 MB
- **建议**: 需要启动详情处理服务

#### 5. 微博登录成功队列 (weibo_login_success)
- **状态**: ⚠️ 有少量消息
- **消息数**: 3
- **消费者数**: 0
- **建议**: 需要登录处理服务

### 📋 其他队列
- **weibo_data**: 0 消息, 0 消费者 ✅
- **weibo_scheduled_task**: 0 消息, 0 消费者 ✅
- **weibo_login_success_queue**: 0 消息, 0 消费者 ✅
- **weibo_detail_mongodb**: 1,308 消息, 0 消费者 ⚠️

## 🔧 连接配置检查

### 环境变量配置
```bash
RABBITMQ_URL=amqp://admin:RabbitMQ2025Secure@43.240.223.138:5672
RABBITMQ_DEFAULT_USER=admin
RABBITMQ_DEFAULT_PASS=RabbitMQ2025Secure
RABBITMQ_AMQP_PORT=5672
RABBITMQ_MANAGEMENT_PORT=15672
```

### 代码配置
- **Broker服务**: `apps/broker/src/rabbitmq/rabbitmq-config.service.ts`
- **API服务**: `apps/api/src/weibo/weibo-rabbitmq-config.service.ts`
- **队列包**: `packages/rabbitmq/src/index.ts`

## 🚀 服务状态

### 已验证服务
- **RabbitMQ Server**: ✅ 运行正常
- **Broker应用**: ✅ 启动正常，数据库连接正常
- **连接测试**: ✅ 消息发布和队列访问正常

### 需要检查的服务
- **Crawler服务**: ❓ 需要验证消费者状态
- **数据处理服务**: ❓ 需要验证详情和账号处理

## 📈 性能指标

### 总体统计
- **总消息数**: 33,931
- **总消费者数**: 2
- **活跃连接数**: 5
- **交换机数**: 10
- **队列数**: 11

### 消息处理统计
- **已发布消息**: 41,729
- **已确认消息**: 6,515
- **重新投递**: 5,944
- **磁盘读写**: 7,909 次读取, 41,729 次写入

## 🔍 问题诊断

### 高优先级问题
1. **weibo_account** 和 **weibo_detail** 队列积压严重
   - 影响: 可能导致账号信息和微博详情处理延迟
   - 建议: 启动或重启相应的消费者服务

2. **weibo_detail_mongodb** 队列有1,308条消息
   - 影响: MongoDB数据同步延迟
   - 建议: 检查MongoDB连接和处理服务

### 中优先级问题
1. **weibo_login_success** 队列有3条消息
   - 影响: 登录成功事件处理延迟
   - 建议: 检查登录事件处理服务

## 💡 建议操作

### 立即操作
1. 检查crawler服务是否正常运行
2. 验证数据处理服务的消费者状态
3. 检查MongoDB连接和写入权限

### 预防措施
1. 监控队列积压情况，设置告警阈值
2. 定期检查消费者服务健康状态
3. 优化消息处理性能，避免积压

### 监控建议
1. 设置队列消息数量监控 (>1000条时告警)
2. 监控消费者在线状态
3. 跟踪消息处理延迟时间

## 🧪 测试结果

### 连接测试: ✅ 通过
- 连接耗时: 197ms
- 消息发布: 成功 (4ms)
- 队列访问: 正常

### 功能测试: ✅ 通过
- 队列声明: 正常
- 死信队列: 正常
- 消息持久化: 正常

---

**报告生成者**: RabbitMQ诊断工具
**下次检查建议**: 24小时内或出现队列异常时